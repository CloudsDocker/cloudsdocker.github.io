<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="DB sharding in YHDThere are two solutions when DB becoming bottleneck in yihaodian.   Scale upUpgrade Oracle DB, adding more CPU , Disk and memory to incrase I/O performance. This is for short term on">
<meta name="keywords" content="DB,Sharding,MobileInternet">
<meta property="og:type" content="article">
<meta property="og:title" content="Database sharding">
<meta property="og:url" content="http://www.todzhang.com/2016-06-01-DB-Sharding/index.html">
<meta property="og:site_name" content="Clouds &amp; Docker">
<meta property="og:description" content="DB sharding in YHDThere are two solutions when DB becoming bottleneck in yihaodian.   Scale upUpgrade Oracle DB, adding more CPU , Disk and memory to incrase I/O performance. This is for short term on">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-05-31T13:03:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Database sharding">
<meta name="twitter:description" content="DB sharding in YHDThere are two solutions when DB becoming bottleneck in yihaodian.   Scale upUpgrade Oracle DB, adding more CPU , Disk and memory to incrase I/O performance. This is for short term on">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Database sharding</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2016-05-31-Microservices-Vs-SOA/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2016-02-25-Java-Class-Loader/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.todzhang.com/2016-06-01-DB-Sharding/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&text=Database sharding"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&is_video=false&description=Database sharding"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Database sharding&body=Check out this article: http://www.todzhang.com/2016-06-01-DB-Sharding/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&name=Database sharding&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DB-sharding-in-YHD"><span class="toc-number">1.</span> <span class="toc-text">DB sharding in YHD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sharding-dimensions"><span class="toc-number">1.1.</span> <span class="toc-text">sharding dimensions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sharding-strategy"><span class="toc-number">1.2.</span> <span class="toc-text">sharding strategy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sharding-numbers"><span class="toc-number">1.3.</span> <span class="toc-text">sharding numbers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Router-transparency"><span class="toc-number">1.4.</span> <span class="toc-text">Router transparency</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Oracle-Sharding"><span class="toc-number">2.</span> <span class="toc-text">Oracle Sharding</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Downsides-of-DB-replica"><span class="toc-number">2.1.</span> <span class="toc-text">Downsides of DB replica</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Database sharding
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Clouds & Docker</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-05-31T13:03:27.000Z" itemprop="datePublished">2019-05-31</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/DB/">DB</a>, <a class="tag-link" href="/tags/MobileInternet/">MobileInternet</a>, <a class="tag-link" href="/tags/Sharding/">Sharding</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="DB-sharding-in-YHD"><a href="#DB-sharding-in-YHD" class="headerlink" title="DB sharding in YHD"></a>DB sharding in YHD</h1><p>There are two solutions when DB becoming bottleneck in yihaodian. </p>
<ul>
<li>Scale up<br>Upgrade Oracle DB, adding more CPU , Disk and memory to incrase I/O performance. This is for short term only, high cost.</li>
<li>Scale out<br>Divide the order table to multiple DBs, which is support horizontal extension, for long term purpose.</li>
</ul>
<p>Orgional Oracle is replaced by multiple MySQL DB, supporintg one master and multiple slaves, supporitng segratation of read and write. Leveraging <code>MySQL built-in</code> Master-slave replication (SLA&lt;1 second)</p>
<h2 id="sharding-dimensions"><a href="#sharding-dimensions" class="headerlink" title="sharding dimensions"></a>sharding dimensions</h2><ul>
<li>DB Field chosing, it should chose the filed that lead to least SQL and code change, to make the access fall in <code>one database</code>, instead of multiple DBs, which result in high I/O and significant logic change. </li>
<li>Here is one practice</li>
<li><ul>
<li>Get all SQL</li>
</ul>
</li>
<li><ul>
<li>Pick up top fields appear in <code>where</code> clause.</li>
</ul>
</li>
<li><ul>
<li>List break down from three categories</li>
</ul>
</li>
</ul>
<ol>
<li>Single ID, i.e. userID=?</li>
<li>Multiple ID. i.e. userID in (?,?,?)</li>
<li>Not show</li>
</ol>
<table>
<thead>
<tr>
<th align="left">Field</th>
<th align="right">Single ID</th>
<th align="right">Multiple ID</th>
<th align="right">Not show</th>
</tr>
</thead>
<tbody><tr>
<td align="left">userID</td>
<td align="right">120</td>
<td align="right">40</td>
<td align="right">330</td>
</tr>
<tr>
<td align="left">orderID</td>
<td align="right">60</td>
<td align="right">80</td>
<td align="right">360</td>
</tr>
<tr>
<td align="left">shopID</td>
<td align="right">15</td>
<td align="right">0</td>
<td align="right">485</td>
</tr>
<tr>
<td align="left">It’s obviously we should chose userID for sharding. Hold on, this is just <strong>static</strong> analysis, we should conduct <em>dynamic*</em> study as well, so list most executed SQLs, e.g. top 15 SQL (account to 85% of SQL calls), if we conduct sharding by user ID, 85% of those SQL will fall in single DB and 13% fall in multiple DB, and only 2% will scan all DB, so the performance is must better than sharding on other ID fields.</td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
</tr>
</tbody></table>
<h2 id="sharding-strategy"><a href="#sharding-strategy" class="headerlink" title="sharding strategy"></a>sharding strategy</h2><p>There are two type of strategies</p>
<ol>
<li>By value range, e.g. user ID 1-9999 to DB1, and 10000-20000 to DB2. For this option, </li>
<li>By value mod, e.g. userID mod n, when reminder is 0, go to DB1, reminder is 1, to DB2, etc.</li>
</ol>
<p>Pros and Cons:</p>
<table>
<thead>
<tr>
<th align="left">Criteria</th>
<th align="left">By Range</th>
<th align="left">By Mod</th>
</tr>
</thead>
<tbody><tr>
<td align="left">number of DBs</td>
<td align="left">initially only require small amount of DBs, can increasse by business requests</td>
<td align="left">initially number based on mod number, normally a big number</td>
</tr>
<tr>
<td align="left">Accessibility</td>
<td align="left">initially only few DBs, perforamce cost is small, single DB performance query is poor</td>
<td align="left">initially big number of DBs, query acorss DBs may consume many resources, better for query on single DB</td>
</tr>
<tr>
<td align="left">DBs adjustment</td>
<td align="left">easy, just add new DB, and impact is limit when split existing DB</td>
<td align="left">not easy, change mod value  may result in DB migration across DBs</td>
</tr>
<tr>
<td align="left">Data hotspot</td>
<td align="left">there are data hotspot issues</td>
<td align="left">no data hotspot issues</td>
</tr>
</tbody></table>
<p>In practice, for the sake of simplicity, mod sharding is often used. To manage further sharding, and for smooth data migration, normally new DBs are added by folds, e.g. intially 4 DBs, furhter split will be 8 DBs, then 16 DBs. This is becuase only half of data in existing DB will be migrated to new DB, while the rest half will be remain unchanged. However, there are some super IDs, e.g. one big shop with massive records than normal, if we shard DB by user ID, there will one DB will many records than others. For this case, we need to provide separate DB for those super IDs.</p>
<h2 id="sharding-numbers"><a href="#sharding-numbers" class="headerlink" title="sharding numbers"></a>sharding numbers</h2><p>Firslty, that’s depends on the ability of single DB, e.g. normally one MySQL DB can support upto 50mio records, and Oracle can support 100mio. Normally multiple DBs may leads to certain perforamnce issues, when data query across multiple DBs, if there are multithreading call, it will cost precious thread resource, while it’s single thread, the wating time will be unacceptable. Normally, the initial sharding is 4-8 DBs.</p>
<h2 id="Router-transparency"><a href="#Router-transparency" class="headerlink" title="Router transparency"></a>Router transparency</h2><p>To certain extent, DB sharding means change of DBSChema, which inevitable result in application, however, this is irrelavent to business logic, so the DB sharding should be transparent to business logic code, therefore, DB sharding should be handled at DAL (Data Access Layer) or DDAL (Distributed Data Access Layer).</p>
<ol>
<li>For access to single DB, e.g. query by certain user id, DAL will automatically route to that DB, even further split by mod, still no applicaiton logic code change impacted.</li>
<li>For simple across DB query, DAL in charge to aggregate results from every DB query, still transparent to upper application logic.</li>
<li>For query involves multiple DBs with aggretation functions, e.g. groupBy, order by, min, max, avg. It’s recommended DAL consolidate request from single DB, while upper layers do further processing. That’s becuase if rely on DAL, it would be too complex, and such case is relatively rare case, so leave it to upper layer.</li>
</ol>
<h1 id="Oracle-Sharding"><a href="#Oracle-Sharding" class="headerlink" title="Oracle Sharding"></a>Oracle Sharding</h1><p>It’s required in Web 2.0 and high availability technologies</p>
<p>Shardingis an application-managed scaling technique using many (hundreds /thousands of) independent databases </p>
<ul>
<li>Data is split into multiple databases (shards)</li>
<li>Each database holds a subset (either range or hash) of the data</li>
<li>Split the shards as data volume or access grows</li>
<li>Shards are replicated for availability and scalability</li>
</ul>
<p>Sharding is the dominant approach for scaling massive websites</p>
<ul>
<li>Application code dispatches request to a specific database based on key value</li>
<li>Queries are constrained -simple queries on shard-key</li>
<li>Data isdenormalizedto avoid cross-shard operations (no joins)</li>
<li>Each database holds all the data</li>
<li>Request dispatched to a specific database based on read/write,key value</li>
<li>Updates go to one database, changes are replicated to the other databases. The other databases are available for reads</li>
<li>Provides read scalability</li>
<li>Can be combined with horizontal sharding so that each shard is replicated to a different degree</li>
<li>Main benefit is that you do not need to reshard</li>
</ul>
<h2 id="Downsides-of-DB-replica"><a href="#Downsides-of-DB-replica" class="headerlink" title="Downsides of DB replica"></a>Downsides of DB replica</h2><ul>
<li>Only async log shipping which can lose data in case of failure</li>
<li>Slaves can return inconsistent data</li>
<li>Statement based replication has correctness issues &amp; row-based replication is immature</li>
<li>Replication is slow (high overhead on each reader, slaves are single-threaded)</li>
<li>No support for failover between master (primary) &amp; slaves (backup)</li>
<li>Does not handle failure conditions such as missing or damaged logs</li>
<li>Storage engine and replication state may become inconsistent after a crash</li>
<li>Bringing a failed master back requires copying the database</li>
</ul>
<p>–End–</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DB-sharding-in-YHD"><span class="toc-number">1.</span> <span class="toc-text">DB sharding in YHD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sharding-dimensions"><span class="toc-number">1.1.</span> <span class="toc-text">sharding dimensions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sharding-strategy"><span class="toc-number">1.2.</span> <span class="toc-text">sharding strategy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sharding-numbers"><span class="toc-number">1.3.</span> <span class="toc-text">sharding numbers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Router-transparency"><span class="toc-number">1.4.</span> <span class="toc-text">Router transparency</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Oracle-Sharding"><span class="toc-number">2.</span> <span class="toc-text">Oracle Sharding</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Downsides-of-DB-replica"><span class="toc-number">2.1.</span> <span class="toc-text">Downsides of DB replica</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.todzhang.com/2016-06-01-DB-Sharding/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&text=Database sharding"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&is_video=false&description=Database sharding"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Database sharding&body=Check out this article: http://www.todzhang.com/2016-06-01-DB-Sharding/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&title=Database sharding"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.todzhang.com/2016-06-01-DB-Sharding/&name=Database sharding&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Todd Zhang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
