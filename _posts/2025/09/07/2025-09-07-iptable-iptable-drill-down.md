---
header:
    image: hd_google_map_no_reviews_huawai_2.jpg
title: IPtableï¼šå¬è¿‡ IPï¼Œå¬è¿‡ tableï¼Œå¯åˆåœ¨ä¸€èµ·ä½ å°±è’™äº†
date: 2025-09-07
tags:
    - tech
permalink: /blogs/tech/en/iptable-iptable-drill-down
layout: single
category: tech
---
> When one door of happiness closes, another opens. - Helen Keller
> å½“ä¸€æ‰‡å¹¸ç¦ä¹‹é—¨å…³é—­æ—¶ï¼Œå¦ä¸€æ‰‡å°±ä¼šæ‰“å¼€ã€‚ä½†æˆ‘ä»¬å¾€å¾€é•¿æ—¶é—´åœ°å‡è§†ç€é‚£æ‰‡å…³é—­çš„é—¨ï¼Œè€Œå¿½ç•¥äº†ä¸ºæˆ‘ä»¬æ‰“å¼€çš„é‚£æ‰‡é—¨ã€‚ - æµ·ä¼¦Â·å‡¯å‹’


## ðŸ’¥ å¼€åœºï¼šä¸€æ¡å‘½ä»¤å¼•å‘çš„æƒ¨æ¡ˆ

2023å¹´11æœˆçš„æŸä¸ªæ·±å¤œï¼Œæˆ‘æ­£åœ¨å…¬å¸çš„æµ‹è¯•æœåŠ¡å™¨ä¸Šè°ƒè¯•ä¸€ä¸ªç½‘ç»œé—®é¢˜ã€‚å½“æ—¶çš„æˆ‘ï¼Œè‡ªè®¤ä¸ºå¯¹Linuxè¿˜ç®—ç†Ÿæ‚‰ï¼Œçœ‹ç€ç½‘ä¸Šçš„æ•™ç¨‹ï¼Œä¿¡å¿ƒæ»¡æ»¡åœ°æ•²ä¸‹äº†è¿™æ¡å‘½ä»¤ï¼š

```bash
iptables -A INPUT -j DROP
```

ç„¶åŽ...SSHè¿žæŽ¥æ–­äº†ã€‚

æˆ‘å½“æ—¶çš„è¡¨æƒ…å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼šðŸ˜¨ â†’ ðŸ˜° â†’ ðŸ˜± â†’ ðŸ’€

**é‚£ä¸€åˆ»ï¼Œæˆ‘æ‰çœŸæ­£ç†è§£äº†ä»€ä¹ˆå«"ä¸€è¡Œä»£ç æ¯æ‰€æœ‰"ã€‚**

æ›´è¦å‘½çš„æ˜¯ï¼Œè¿™å°æœåŠ¡å™¨åœ¨æœºæˆ¿ï¼Œè€Œæˆ‘åœ¨å®¶é‡Œã€‚å‡Œæ™¨3ç‚¹ï¼Œæˆ‘åªèƒ½çœ¼çççœ‹ç€ç›‘æŽ§æ˜¾ç¤º"æœåŠ¡å™¨å¤±è”"ï¼Œç„¶åŽå¼€å§‹ç–¯ç‹‚ç»™è¿ç»´åŒäº‹æ‰“ç”µè¯...

## ðŸŽ­ iptablesï¼šLinuxä¸–ç•Œçš„è¶…çº§ä¿å®‰é˜Ÿé•¿

æ­¤æ—¶æˆ‘ä»¬å…ˆåœä¸‹æ¥æƒ³è±¡ä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯iptablesï¼Ÿä½ çš„LinuxæœåŠ¡å™¨å°±åƒä¸€åº§ç¹åŽçš„è´­ç‰©ä¸­å¿ƒï¼Œè€Œ**iptables**å°±æ˜¯è¿™åº§è´­ç‰©ä¸­å¿ƒé‡Œæœ€ç‰›é€¼çš„ä¿å®‰é˜Ÿé•¿ï¼ðŸ‘®â€â™‚ï¸

è¿™ä½ä¿å®‰é˜Ÿé•¿æœ‰ç€è¶…äººèˆ¬çš„èƒ½åŠ›ï¼š

ðŸšª **é—¨å«åŠŸèƒ½**ï¼šç«™åœ¨æ¯ä¸ªå…¥å£ï¼Œæ£€æŸ¥æ¯ä¸€ä¸ªæƒ³è¿›æ¥çš„"é¡¾å®¢"ï¼ˆæ•°æ®åŒ…ï¼‰çš„èº«ä»½è¯ï¼ˆIPåœ°å€ï¼‰ã€‚"ä½ æ˜¯è°ï¼Ÿä»Žå“ªæ¥ï¼Ÿè¦å¹²å˜›ï¼Ÿ"å¦‚æžœä¸ç¬¦åˆè§„å®šï¼Œç›´æŽ¥ä¸€ä¸ª"æ»šè›‹"ï¼ˆDROPï¼‰æ‰”å‡ºåŽ»ï¼Œè¿žæ‹›å‘¼éƒ½ä¸æ‰“ï¼

ðŸŽ­ **å˜è£…å¤§å¸ˆ**ï¼šä¸ä»…èƒ½æ‹¦äººï¼Œè¿˜èƒ½ç»™æ•°æ®åŒ…"åŒ–å¦†"ï¼æŠŠæ¥è‡ªå¤–ç½‘çš„è®¿å®¢ä¼ªè£…æˆå†…ç½‘çš„ç†Ÿäººï¼ˆNATè½¬æ¢ï¼‰ï¼Œè®©ä»–ä»¬ç¥žä¸çŸ¥é¬¼ä¸è§‰åœ°è¿›å…¥å†…éƒ¨åŒºåŸŸã€‚å°±åƒç”µå½±é‡Œçš„ç‰¹å·¥ï¼Œæ¢ä¸ªé©¬ç”²å°±èƒ½æ··è¿›æ•Œè¥ï¼

ðŸ“ **è®°å½•ç‹‚é­”**ï¼šæ¯å¤©å…¢å…¢ä¸šä¸šåœ°åœ¨å°æœ¬æœ¬ä¸Šè®°å½•ï¼š"ä¸Šåˆ9ç‚¹ï¼ŒIP 192.168.1.100 æƒ³è®¿é—®22ç«¯å£ï¼Œå·²æ‹’ç»"ã€"ä¸‹åˆ3ç‚¹ï¼Œå‘çŽ°å¯ç–‘æ‰«æè¡Œä¸ºï¼Œå·²è®°å½•"ã€‚æ¯”å±…å§”ä¼šå¤§å¦ˆè¿˜è¦å…«å¦ï¼

ðŸŽ¯ **ç²¾å‡†ç‹™å‡»æ‰‹**ï¼šä¸æ˜¯ä¸€åˆ€åˆ‡çš„æš´åŠ›ä¿å®‰ï¼Œè€Œæ˜¯ç²¾å‡†åˆ¶å¯¼çš„æ™ºèƒ½å«å£«ã€‚å¯ä»¥è®¾ç½®"åªå…è®¸è€æ¿çš„IPè®¿é—®SSH"ã€"ç¦æ­¢å†…ç½‘è®¿é—®æŸäº›ç½‘ç«™"ã€"é™åˆ¶æ¯ç§’è¿žæŽ¥æ•°"ç­‰ç­‰ï¼Œæ¯”ä½ å¦ˆç®¡ä½ è¿˜ç»†è‡´ï¼

æœ€ç¥žå¥‡çš„æ˜¯ï¼Œè¿™ä½ä¿å®‰é˜Ÿé•¿è¿˜æœ‰**åˆ†èº«æœ¯**ï¼ä»–æŠŠè‡ªå·±åˆ†æˆå¥½å‡ ä¸ªéƒ¨é—¨ï¼š
- **filteréƒ¨é—¨**ï¼šä¸“é—¨è´Ÿè´£"è®©è¿›è¿˜æ˜¯ä¸è®©è¿›"
- **natéƒ¨é—¨**ï¼šä¸“é—¨è´Ÿè´£"æ¢é©¬ç”²å’Œæ”¹åœ°å€"
- **mangleéƒ¨é—¨**ï¼šä¸“é—¨è´Ÿè´£"ç»™æ•°æ®åŒ…è´´æ ‡ç­¾"

æ‰€ä»¥ä¸‹æ¬¡æœ‰äººé—®ä½ iptablesæ˜¯ä»€ä¹ˆï¼Œä½ å°±å‘Šè¯‰ä»–ï¼š"é‚£æ˜¯Linuxä¸–ç•Œé‡Œæœ€æ•¬ä¸šçš„ä¿å®‰é˜Ÿé•¿ï¼Œ24å°æ—¶ä¸ç¡è§‰ï¼Œæ¯”ä½ æƒ³è±¡çš„è¿˜è¦èªæ˜Žï¼"ðŸ˜„

## ðŸ¤” å¤ç›˜ï¼šæˆ‘åˆ°åº•åšé”™äº†ä»€ä¹ˆï¼Ÿ

äº‹åŽå¤ç›˜ï¼Œæˆ‘å‘çŽ°è‡ªå·±çŠ¯äº†ä¸€ä¸ªå…¸åž‹çš„æ–°æ‰‹é”™è¯¯ï¼š**æ²¡æœ‰ç†è§£iptablesçš„æ‰§è¡Œé¡ºåºå’Œé»˜è®¤ç­–ç•¥**ã€‚

æˆ‘ä»¥ä¸º `iptables -A INPUT -j DROP` åªæ˜¯"æ·»åŠ ä¸€æ¡æ‹’ç»è§„åˆ™"ï¼Œä½†å®žé™…ä¸Šï¼š

1. **-A** æ˜¯appendï¼ŒæŠŠè§„åˆ™åŠ åˆ°é“¾çš„**æœ«å°¾**
2. æˆ‘çš„æœåŠ¡å™¨é»˜è®¤ç­–ç•¥æ˜¯ACCEPT
3. ä½†æˆ‘åœ¨æ‰€æœ‰ACCEPTè§„åˆ™**ä¹‹åŽ**åŠ äº†ä¸€æ¡DROP ALL
4. ç»“æžœå°±æ˜¯ï¼šæ‰€æœ‰æ–°è¿žæŽ¥éƒ½è¢«æ‹’ç»äº†

**æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ï¼š**

```bash
# å…ˆå…è®¸å·²å»ºç«‹çš„è¿žæŽ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# å†å…è®¸SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
# æœ€åŽæ‰æ‹’ç»å…¶ä»–
iptables -A INPUT -j DROP
```

è¿™ä¸ªæ•™è®­è®©æˆ‘æ˜Žç™½ï¼š**iptablesä¸æ˜¯ç®€å•çš„"IPè¡¨æ ¼"ï¼Œè€Œæ˜¯ä¸€å¥—å¤æ‚çš„æ•°æ®åŒ…å¤„ç†æµæ°´çº¿ã€‚**

## ðŸ” æ·±å…¥ç†è§£ï¼šiptablesåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

### ä»Žæž¶æž„è§’åº¦çœ‹iptables

ç»è¿‡é‚£æ¬¡æƒ¨ç—›æ•™è®­ï¼Œæˆ‘èŠ±äº†æ•´æ•´ä¸€å‘¨æ—¶é—´ç ”ç©¶iptablesçš„å†…éƒ¨æœºåˆ¶ã€‚å‘çŽ°å®ƒå…¶å®žæ˜¯Linuxå†…æ ¸netfilteræ¡†æž¶çš„ç”¨æˆ·ç©ºé—´å·¥å…·ã€‚

**ç®€å•æ¥è¯´ï¼š**
- **netfilter**ï¼šå†…æ ¸ä¸­çš„é’©å­æ¡†æž¶ï¼Œåœ¨æ•°æ®åŒ…å¤„ç†çš„å…³é”®èŠ‚ç‚¹è®¾ç½®"æ£€æŸ¥ç‚¹"
- **iptables**ï¼šç”¨æˆ·ç©ºé—´çš„é…ç½®å·¥å…·ï¼Œå‘Šè¯‰netfilteråœ¨è¿™äº›æ£€æŸ¥ç‚¹åšä»€ä¹ˆ

### æ•°æ®åŒ…çš„"äººç”Ÿè½¨è¿¹"

æˆ‘ç”¨ä¸€ä¸ªçœŸå®žçš„ä¾‹å­æ¥è¯´æ˜Žæ•°æ®åŒ…åœ¨iptablesä¸­çš„æµè½¬è¿‡ç¨‹ï¼š

å‡è®¾æœ‰ä¸€ä¸ªHTTPè¯·æ±‚ä»Žå¤–ç½‘è®¿é—®æˆ‘çš„WebæœåŠ¡å™¨ï¼š

```
å¤–ç½‘å®¢æˆ·ç«¯ â†’ ç½‘å¡ â†’ PREROUTING â†’ è·¯ç”±å†³ç­– â†’ INPUT â†’ æœ¬æœºè¿›ç¨‹
```

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯¹åº”çš„é“¾ï¼ˆchainï¼‰ï¼š

1. **PREROUTING**ï¼šæ•°æ®åŒ…åˆšåˆ°è¾¾ç½‘å¡ï¼Œè¿˜æ²¡è·¯ç”±
   - å¸¸ç”¨äºŽDNATï¼ˆç›®æ ‡åœ°å€è½¬æ¢ï¼‰
   - ä¾‹å¦‚ï¼šæŠŠè®¿é—®å…¬ç½‘IPçš„è¯·æ±‚è½¬å‘åˆ°å†…ç½‘æœåŠ¡å™¨

2. **INPUT**ï¼šè·¯ç”±åŽç¡®å®šæ˜¯å‘ç»™æœ¬æœºçš„
   - å¸¸ç”¨äºŽè®¿é—®æŽ§åˆ¶
   - ä¾‹å¦‚ï¼šåªå…è®¸ç‰¹å®šIPè®¿é—®SSH

3. **FORWARD**ï¼šè·¯ç”±åŽç¡®å®šéœ€è¦è½¬å‘çš„
   - å¸¸ç”¨äºŽç½‘å…³ã€è·¯ç”±å™¨
   - ä¾‹å¦‚ï¼šæŽ§åˆ¶å†…ç½‘è®¿é—®å¤–ç½‘çš„æµé‡

4. **OUTPUT**ï¼šæœ¬æœºå‘å‡ºçš„æ•°æ®åŒ…
   - å¸¸ç”¨äºŽå‡ºç«™æŽ§åˆ¶
   - ä¾‹å¦‚ï¼šç¦æ­¢æœåŠ¡å™¨ä¸»åŠ¨è¿žæŽ¥å¤–ç½‘

5. **POSTROUTING**ï¼šæ•°æ®åŒ…å³å°†ç¦»å¼€ç½‘å¡
   - å¸¸ç”¨äºŽSNATï¼ˆæºåœ°å€è½¬æ¢ï¼‰
   - ä¾‹å¦‚ï¼šNATç½‘å…³çš„åœ°å€ä¼ªè£…

### è¡¨ï¼ˆtableï¼‰çš„åˆ†å·¥åˆä½œ

åœ¨é‚£æ¬¡äº‹æ•…åŽï¼Œæˆ‘è¿˜å‘çŽ°äº†å¦ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼š**è¡¨ï¼ˆtableï¼‰**ã€‚

æ¯ä¸ªè¡¨è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼š

| è¡¨å | ä¸»è¦åŠŸèƒ½ | æˆ‘çš„ä½¿ç”¨ç»éªŒ |
|------|----------|-------------|
| **filter** | è¿‡æ»¤ï¼ˆå…è®¸/æ‹’ç»ï¼‰ | æœ€å¸¸ç”¨ï¼Œ90%çš„é˜²ç«å¢™è§„åˆ™éƒ½åœ¨è¿™é‡Œ |
| **nat** | åœ°å€è½¬æ¢ | åšå†…ç½‘ç©¿é€ã€è´Ÿè½½å‡è¡¡æ—¶å¿…ç”¨ |
| **mangle** | ä¿®æ”¹æ•°æ®åŒ… | é«˜çº§çŽ©æ³•ï¼ŒQoSã€ç­–ç•¥è·¯ç”± |
| **raw** | è¿žæŽ¥è·Ÿè¸ªæŽ§åˆ¶ | é«˜æ€§èƒ½åœºæ™¯ï¼Œç»•è¿‡conntrack |

## ðŸ› ï¸ å®žæˆ˜æ¡ˆä¾‹ï¼šä»Žè¸©å‘åˆ°ç²¾é€š

### æ¡ˆä¾‹1ï¼šSSHé˜²æŠ¤çš„æ­£ç¡®å§¿åŠ¿

**é”™è¯¯åšæ³•ï¼ˆæˆ‘çš„é»‘åŽ†å²ï¼‰ï¼š**
```bash
iptables -A INPUT -p tcp --dport 22 -j DROP  # ç›´æŽ¥æ‹’ç»SSH
```

**æ­£ç¡®åšæ³•ï¼š**
```bash
# 1. å…ˆä¿æŠ¤å·²æœ‰è¿žæŽ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 2. å…è®¸æœ¬åœ°å›žçŽ¯
iptables -A INPUT -i lo -j ACCEPT

# 3. åªå…è®¸ç‰¹å®šIPè®¿é—®SSH
iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT

# 4. è®°å½•è¢«æ‹’ç»çš„è¿žæŽ¥ï¼ˆè°ƒè¯•ç”¨ï¼‰
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH_DENIED: "

# 5. æ‹’ç»å…¶ä»–SSHè¿žæŽ¥
iptables -A INPUT -p tcp --dport 22 -j DROP
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**
- `ESTABLISHED,RELATED`ï¼šä¿æŠ¤å·²å»ºç«‹çš„è¿žæŽ¥ï¼Œé¿å…æŠŠè‡ªå·±è¸¢å‡ºåŽ»
- `lo`ï¼šæœ¬åœ°å›žçŽ¯å¿…é¡»å…è®¸ï¼Œå¦åˆ™å¾ˆå¤šæœåŠ¡ä¼šå‡ºé—®é¢˜
- æºIPé™åˆ¶ï¼šåªå…è®¸å†…ç½‘æˆ–å ¡åž’æœºè®¿é—®
- LOGï¼šè®°å½•æ”»å‡»æ—¥å¿—ï¼Œæ–¹ä¾¿åŽç»­åˆ†æž

### æ¡ˆä¾‹2ï¼šé€æ˜Žä»£ç†çš„ç¥žå¥‡åº”ç”¨

åŽ»å¹´æˆ‘åœ¨åšä¸€ä¸ªé¡¹ç›®ï¼Œéœ€è¦æŠŠæ‰€æœ‰HTTPæµé‡é‡å®šå‘åˆ°ç¼“å­˜æœåŠ¡å™¨ã€‚ä¼ ç»Ÿåšæ³•æ˜¯ä¿®æ”¹DNSæˆ–è€…åº”ç”¨é…ç½®ï¼Œä½†æˆ‘ç”¨iptableså®žçŽ°äº†é€æ˜Žä»£ç†ï¼š

```bash
# æŠŠè®¿é—®8.8.8.8:80çš„æµé‡é‡å®šå‘åˆ°å†…ç½‘ç¼“å­˜
iptables -t nat -A PREROUTING -d 8.8.8.8 -p tcp --dport 80 \
    -j DNAT --to-destination 192.168.1.100:80

# ä¿®æ”¹è¿”å›žåŒ…çš„æºåœ°å€ï¼Œè®©å®¢æˆ·ç«¯ä»¥ä¸ºè¿˜æ˜¯åœ¨è®¿é—®8.8.8.8
iptables -t nat -A POSTROUTING -s 192.168.1.100 -p tcp --sport 80 \
    -j SNAT --to-source 8.8.8.8:80
```

**æ•ˆæžœï¼š**
- å®¢æˆ·ç«¯ä»¥ä¸ºåœ¨è®¿é—®Googleçš„DNSæœåŠ¡å™¨
- å®žé™…ä¸Šè®¿é—®çš„æ˜¯æˆ‘ä»¬çš„å†…ç½‘ç¼“å­˜
- å®Œå…¨é€æ˜Žï¼Œæ— éœ€ä¿®æ”¹å®¢æˆ·ç«¯é…ç½®

### æ¡ˆä¾‹3ï¼šé«˜æ€§èƒ½UDPæœåŠ¡çš„ä¼˜åŒ–

åœ¨å¤„ç†é«˜å¹¶å‘UDPæµé‡æ—¶ï¼Œæˆ‘å‘çŽ°conntrackï¼ˆè¿žæŽ¥è·Ÿè¸ªï¼‰æˆäº†æ€§èƒ½ç“¶é¢ˆã€‚è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨rawè¡¨ï¼š

```bash
# å¯¹ç‰¹å®šç«¯å£çš„UDPæµé‡è·³è¿‡è¿žæŽ¥è·Ÿè¸ª
iptables -t raw -A PREROUTING -p udp --dport 53 -j NOTRACK
iptables -t raw -A OUTPUT -p udp --sport 53 -j NOTRACK

# åœ¨filterè¡¨ä¸­å…è®¸è¿™äº›æµé‡
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -p udp --sport 53 -j ACCEPT
```

**æ€§èƒ½æå‡ï¼š**
- DNSæŸ¥è¯¢å“åº”æ—¶é—´ä»Ž5msé™åˆ°1ms
- æœåŠ¡å™¨CPUä½¿ç”¨çŽ‡é™ä½Ž30%
- å¹¶å‘å¤„ç†èƒ½åŠ›æå‡3å€

## ðŸš¨ è¸©å‘æŒ‡å—ï¼šæˆ‘çŠ¯è¿‡çš„é‚£äº›é”™è¯¯

### å‘1ï¼šè§„åˆ™é¡ºåºå¾ˆé‡è¦

```bash
# é”™è¯¯ï¼šå…ˆDROPå†ACCEPTï¼Œæ°¸è¿œä¸ä¼šç”Ÿæ•ˆ
iptables -A INPUT -j DROP
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# æ­£ç¡®ï¼šå…ˆACCEPTå†DROP
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -j DROP
```

### å‘2ï¼šå¿˜è®°ä¿å­˜è§„åˆ™

æˆ‘æ›¾ç»èŠ±äº†2å°æ—¶è°ƒè¯•iptablesè§„åˆ™ï¼Œé‡å¯æœåŠ¡å™¨åŽå‘çŽ°å…¨æ²¡äº†...

```bash
# CentOS/RHEL
service iptables save

# Ubuntu/Debian
iptables-save > /etc/iptables/rules.v4

# æˆ–è€…ä½¿ç”¨iptables-persistent
apt-get install iptables-persistent
```

### å‘3ï¼šIPv6éœ€è¦å•ç‹¬é…ç½®

iptablesåªç®¡IPv4ï¼ŒIPv6éœ€è¦ç”¨ip6tablesï¼š

```bash
# IPv4
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# IPv6
ip6tables -A INPUT -p tcp --dport 22 -j ACCEPT
```

### å‘4ï¼šDockerçš„iptableså†²çª

Dockerä¼šè‡ªåŠ¨ä¿®æ”¹iptablesè§„åˆ™ï¼Œæœ‰æ—¶ä¼šå’Œæˆ‘ä»¬çš„è§„åˆ™å†²çªï¼š

```bash
# æŸ¥çœ‹Dockeræ·»åŠ çš„è§„åˆ™
iptables -L DOCKER-USER

# åœ¨DOCKER-USERé“¾ä¸­æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
iptables -I DOCKER-USER -p tcp --dport 22 -j DROP
```

## ðŸŽ¯ æœ€ä½³å®žè·µï¼šè¡€çš„æ•™è®­æ€»ç»“

### 1. å®‰å…¨ç¬¬ä¸€çš„é…ç½®æµç¨‹

```bash
#!/bin/bash
# æˆ‘çš„iptablesé…ç½®æ¨¡æ¿

# æ¸…ç©ºçŽ°æœ‰è§„åˆ™ï¼ˆè°¨æ…Žä½¿ç”¨ï¼ï¼‰
# iptables -F
# iptables -X
# iptables -Z

# è®¾ç½®é»˜è®¤ç­–ç•¥ï¼ˆæœ€åŽè®¾ç½®ï¼‰
# iptables -P INPUT DROP
# iptables -P FORWARD DROP
# iptables -P OUTPUT ACCEPT

# 1. å…è®¸æœ¬åœ°å›žçŽ¯
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 2. å…è®¸å·²å»ºç«‹çš„è¿žæŽ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 3. å…è®¸SSHï¼ˆä¿®æ”¹ä¸ºä½ çš„ç®¡ç†IPï¼‰
iptables -A INPUT -p tcp --dport 22 -s YOUR_ADMIN_IP -j ACCEPT

# 4. å…è®¸WebæœåŠ¡
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 5. å…è®¸DNSæŸ¥è¯¢
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

# 6. è®°å½•è¢«æ‹’ç»çš„åŒ…ï¼ˆå¯é€‰ï¼‰
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables_INPUT_denied: " --log-level 7

# 7. æ‹’ç»å…¶ä»–å…¥ç«™æµé‡
iptables -A INPUT -j DROP
```

### 2. è°ƒè¯•æŠ€å·§

```bash
# å®žæ—¶æŸ¥çœ‹è§„åˆ™åŒ¹é…æƒ…å†µ
watch -n 1 'iptables -L -n -v'

# æŸ¥çœ‹ç‰¹å®šé“¾çš„è¯¦ç»†ä¿¡æ¯
iptables -L INPUT -n -v --line-numbers

# ä¸´æ—¶æ’å…¥è°ƒè¯•è§„åˆ™
iptables -I INPUT 1 -p tcp --dport 22 -j LOG --log-prefix "SSH_DEBUG: "

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/messages | grep iptables
```

### 3. æ€§èƒ½ä¼˜åŒ–

```bash
# ä½¿ç”¨ipsetå¤„ç†å¤§é‡IP
ipset create blacklist hash:ip
ipset add blacklist 1.2.3.4
iptables -A INPUT -m set --match-set blacklist src -j DROP

# é™åˆ¶è¿žæŽ¥é€ŸçŽ‡
iptables -A INPUT -p tcp --dport 22 -m recent --set --name SSH
iptables -A INPUT -p tcp --dport 22 -m recent --update --seconds 60 --hitcount 4 --name SSH -j DROP
```

## ðŸ”® è¿›é˜¶åº”ç”¨ï¼šä»Žå·¥å…·åˆ°è‰ºæœ¯

### ç½‘ç»œå®‰å…¨é˜²æŠ¤

```bash
# é˜²æ­¢SYN floodæ”»å‡»
iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT
iptables -A INPUT -p tcp --syn -j DROP

# é˜²æ­¢ç«¯å£æ‰«æ
iptables -A INPUT -m recent --name portscan --rcheck --seconds 86400 -j DROP
iptables -A INPUT -m recent --name portscan --remove
iptables -A INPUT -p tcp -m tcp --dport 139 -m recent --name portscan --set -j LOG --log-prefix "portscan:"
iptables -A INPUT -p tcp -m tcp --dport 139 -m recent --name portscan --set -j DROP
```

### æµé‡æ•´å½¢å’ŒQoS

```bash
# æ ‡è®°ä¸åŒç±»åž‹çš„æµé‡
iptables -t mangle -A OUTPUT -p tcp --dport 22 -j MARK --set-mark 1
iptables -t mangle -A OUTPUT -p tcp --dport 80 -j MARK --set-mark 2

# é…åˆtcåšæµé‡æŽ§åˆ¶
tc qdisc add dev eth0 root handle 1: htb default 30
tc class add dev eth0 parent 1: classid 1:1 htb rate 100mbit
tc class add dev eth0 parent 1:1 classid 1:10 htb rate 50mbit ceil 100mbit
tc filter add dev eth0 protocol ip parent 1:0 prio 1 handle 1 fw classid 1:10
```

## ðŸ’¡ æ€»ç»“ï¼šä»Žææƒ§åˆ°æŽŒæŽ§

å›žæƒ³èµ·é‚£ä¸ªå‡Œæ™¨3ç‚¹çš„å¤œæ™šï¼Œæˆ‘ä»Žä¸€ä¸ªiptableså°ç™½å˜æˆäº†çŽ°åœ¨èƒ½å¤Ÿç†Ÿç»ƒè¿ç”¨å®ƒè§£å†³å„ç§ç½‘ç»œé—®é¢˜çš„å·¥ç¨‹å¸ˆã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘å­¦åˆ°çš„ä¸ä»…ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ï¼š

### æ ¸å¿ƒæ€æƒ³
1. **ç†è§£åŽŸç†æ¯”è®°ä½å‘½ä»¤æ›´é‡è¦**
2. **å®‰å…¨ç¬¬ä¸€ï¼Œæ°¸è¿œç•™åŽè·¯**
3. **æµ‹è¯•çŽ¯å¢ƒå…ˆéªŒè¯ï¼Œç”Ÿäº§çŽ¯å¢ƒå†åº”ç”¨**
4. **æ—¥å¿—å’Œç›‘æŽ§æ˜¯æœ€å¥½çš„æœ‹å‹**

### å®žç”¨å»ºè®®
1. **å»ºç«‹è‡ªå·±çš„è§„åˆ™æ¨¡æ¿åº“**
2. **å®šæœŸå¤‡ä»½å’Œç‰ˆæœ¬æŽ§åˆ¶iptablesè§„åˆ™**
3. **å­¦ä¼šä½¿ç”¨iptables-saveå’Œiptables-restore**
4. **æŽŒæ¡åŸºæœ¬çš„ç½‘ç»œè°ƒè¯•æŠ€èƒ½**

### è¿›é˜¶æ–¹å‘
1. **å­¦ä¹ nftablesï¼ˆiptablesçš„ç»§ä»»è€…ï¼‰**
2. **äº†è§£eBPFå’ŒXDPæŠ€æœ¯**
3. **æŽŒæ¡å®¹å™¨ç½‘ç»œå’ŒService Mesh**
4. **ç ”ç©¶äº‘åŽŸç”Ÿç½‘ç»œå®‰å…¨**

**æœ€åŽæƒ³è¯´çš„æ˜¯ï¼š**

iptablesä¸åªæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæ˜¯Linuxç½‘ç»œæ ˆçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œæ˜¯ç†è§£çŽ°ä»£ç½‘ç»œå®‰å…¨å’Œäº‘è®¡ç®—çš„åŸºç¡€ã€‚æŽŒæ¡å®ƒï¼Œä½ å°±æŽŒæ¡äº†ç½‘ç»œä¸–ç•Œçš„ä¸€æŠŠé’¥åŒ™ã€‚

é‚£ä¸ªè®©æˆ‘åœ¨å‡Œæ™¨3ç‚¹æ€€ç–‘äººç”Ÿçš„å‘½ä»¤ï¼Œæœ€ç»ˆæˆä¸ºäº†æˆ‘æŠ€æœ¯æˆé•¿è·¯ä¸Šçš„é‡è¦é‡Œç¨‹ç¢‘ã€‚æ­£å¦‚æµ·ä¼¦Â·å‡¯å‹’æ‰€è¯´ï¼š"å½“ä¸€æ‰‡é—¨å…³é—­æ—¶ï¼Œå¦ä¸€æ‰‡é—¨å°±ä¼šæ‰“å¼€ã€‚"

æ„¿ä½ åœ¨iptablesçš„ä¸–ç•Œé‡Œï¼Œå°‘è¸©å‘ï¼Œå¤šæˆé•¿ï¼

---

**é™„å½•ï¼šå¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨**

```bash
# æŸ¥çœ‹è§„åˆ™
iptables -L -n -v
iptables -t nat -L -n -v

# ä¿å­˜/æ¢å¤è§„åˆ™
iptables-save > /etc/iptables.rules
iptables-restore < /etc/iptables.rules

# æ¸…ç©ºè§„åˆ™
iptables -F
iptables -X
iptables -Z

# æ’å…¥/åˆ é™¤è§„åˆ™
iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT
iptables -D INPUT 1

# ä¿®æ”¹é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
```

*è®°ä½ï¼šæ¯ä¸€æ¬¡è¸©å‘éƒ½æ˜¯æˆé•¿çš„æœºä¼šï¼Œæ¯ä¸€ä¸ªé”™è¯¯éƒ½æ˜¯ç»éªŒçš„ç§¯ç´¯ã€‚*

