<!DOCTYPE html>





<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.8.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    save_scroll: false,
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta name="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
<meta property="og:type" content="website">
<meta property="og:title" content="Clouds &amp; Docker">
<meta property="og:url" content="http://www.todzhang.com/page/6/index.html">
<meta property="og:site_name" content="Clouds &amp; Docker">
<meta property="og:description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Clouds &amp; Docker">
<meta name="twitter:description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
  <link rel="canonical" href="http://www.todzhang.com/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Clouds & Docker</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Clouds & Docker</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content page-home">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-11-04-Python-Scrapy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-11-04-Python-Scrapy/" class="post-title-link" itemprop="url">Python Scraphy</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Python-Scraphy"><a href="#Python-Scraphy" class="headerlink" title="Python Scraphy"></a>Python Scraphy</h1><p>‘<a href="https://www.seek.com.au/jobs-in-information-communication-technology?highpay=True&amp;salaryrange=150000-999999&amp;salarytype=annual&#39;" target="_blank" rel="noopener">https://www.seek.com.au/jobs-in-information-communication-technology?highpay=True&amp;salaryrange=150000-999999&amp;salarytype=annual&#39;</a></p>
<p>scrapy shell httxxxx<br>scrapy extrac </p>
<blockquote>
<blockquote>
<blockquote>
<p>response.css(‘title::text’).re(r’Quotes.*’)<br>[‘Quotes to Scrape’]</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>response.css(‘title::text’)[0].extract()<br>‘Quotes to Scrape’</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>response.xpath(‘//title’)</p>
</blockquote>
</blockquote>
</blockquote>
<p>view(response)</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://doc.scrapy.org/en/latest/intro/tutorial.html" target="_blank" rel="noopener">https://doc.scrapy.org/en/latest/intro/tutorial.html</a></li>
<li></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-11-05-JSON-Lines/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-11-05-JSON-Lines/" class="post-title-link" itemprop="url">JSON lines</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="JSON-lines"><a href="#JSON-lines" class="headerlink" title="JSON lines"></a>JSON lines</h1><p>The JSON Lines format is useful because it’s stream-like, you can easily append new records to it. It doesn’t have the same problem of JSON when you run twice. Also, as each record is a separate line, you can process big files without having to fit everything in memory, there are tools like JQ to help doing that at the command-line.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="http://jsonlines.org" target="_blank" rel="noopener">http://jsonlines.org</a></li>
<li><a href="https://en.wikipedia.org/wiki/JSON_Streaming" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/JSON_Streaming</a></li>
<li></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-11-12-elastic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-11-12-elastic/" class="post-title-link" itemprop="url">Eslastic Search</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Eslastic-Search"><a href="#Eslastic-Search" class="headerlink" title="Eslastic Search"></a>Eslastic Search</h1><p>`Elastic Search notes</p>
<h3 id="List-indices"><a href="#List-indices" class="headerlink" title="List indices"></a>List indices</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9200/_cat/indices?v</span><br></pre></td></tr></table></figure>

<h3 id="pretty-print-JSON-message-if-any"><a href="#pretty-print-JSON-message-if-any" class="headerlink" title="pretty-print JSON message (if any)"></a>pretty-print JSON message (if any)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/customer?pretty'</span></span><br></pre></td></tr></table></figure>

<p>如果有任何建议或者想法，请联系我。</p>
<h2 id="联系我："><a href="#联系我：" class="headerlink" title="联系我："></a>联系我：</h2><ul>
<li><a href="mailto:phray.zhang@gmail.com" target="_blank" rel="noopener">phray.zhang@gmail.com</a> (email/邮件，whatsapp, linkedin)</li>
<li>helloworld_2000 (wechat/微信)</li>
<li><a href="https://github.com/CloudsDocker/" target="_blank" rel="noopener">github</a></li>
<li>[简书 jianshu]（<a href="http://www.jianshu.com/users/a9e7b971aafc）" target="_blank" rel="noopener">http://www.jianshu.com/users/a9e7b971aafc）</a></li>
<li>微信公众号：vibex</li>
<li>微博: cloudsdocker</li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-11-22-Facial-Recognition/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-11-22-Facial-Recognition/" class="post-title-link" itemprop="url">用10几行代码自己写个人脸识别程序</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="用10几行代码自己写个人脸识别程序"><a href="#用10几行代码自己写个人脸识别程序" class="headerlink" title="用10几行代码自己写个人脸识别程序"></a>用10几行代码自己写个人脸识别程序</h1><h2 id="CV-Computer-Vision"><a href="#CV-Computer-Vision" class="headerlink" title="CV (Computer Vision)"></a>CV (Computer Vision)</h2><p>最近在研究CV的一些开源库(OpenCV)，有一个体会就是在此领域，除了一些非常学术的<em>机器学习</em>, _深度学习_等概念外，其实还有一些很有趣的_现实的_应用场景。比如之前很流行的微软的 <a href="https://how-old.net" target="_blank" rel="noopener">https://how-old.net</a>, 你使用自己指定或者上传的照片进行面部识别_猜年龄_。 如下图所示：<br><img src="http://cloudsdocker.github.io/images/facial_howold.jpg" alt></p>
<p>细想一下这个很吸引眼球的程序，其实技术本身打散了就包括两大块，一是从图片中扫描并进行面部识别，二是对找到的人脸根据算法去猜个年龄。大家可以猜猜实现第一个功能需要多少核心代码量？其实不用<del>上万行</del>，在这里我就使用短短<strong>几行代码</strong>（去除空格换行什么的，有效代码只要10行）就实现一个_高大上_面部识别的功能。在此文容我细述一下具体实现代码以及我对机器识别图像领域技术的理解。</p>
<h3 id="面部识别-刷脸"><a href="#面部识别-刷脸" class="headerlink" title="面部识别,刷脸"></a>面部识别,刷脸</h3><p> _人脸识别_技术大家应该都不陌生，之前大家使用的数码相机，或者现在很多手机自带的相机都有人脸识别的功能。其效果就像是下图这样。近的看，_剁手节_刚刚过了没有多久 , 背后的马老板一直在力推的刷脸支付也是一个此领域的所谓“黑科技”。比如在德国汉诺威电子展上，马云用支付宝“刷脸”买了一套纪念邮票。人脸识别应用市场也从爆发。随后，各大互联网巨头也纷纷推出了刷脸相关的应用。</p>
<p><img src="http://cloudsdocker.github.io/images/iPhone-camera-face-recognition.jpg" alt></p>
<p>如果要加个定义，人脸识别又叫做人像识别、面部识别，是一种通过用摄像机或摄像头采集含有人脸的图像或视频流，并自动在图像中检测和跟踪人脸，进而对检测到的人脸进行脸部的一系列相关技术。</p>
<h2 id="我的十行代码程序"><a href="#我的十行代码程序" class="headerlink" title="我的十行代码程序"></a>我的十行代码程序</h2><p>OK，长话短说，先上 <em>干货</em> ，下面就是此程序的<em>带注释</em> 版本，完整的程序以及相关配套文件可以在 <a href="https://github.com/CloudsDocker/pyFacialRecognition" target="_blank" rel="noopener">这个github库</a> <a href="https://github.com/CloudsDocker/pyFacialRecognition" target="_blank" rel="noopener">https://github.com/CloudsDocker/pyFacialRecognition</a> 中找到，有兴趣可以<em>fork</em> 下来玩玩。下面是整个程序的代码样子，后面我会逐行去解释分析。</p>
<p><img src="http://cloudsdocker.github.io/images/facial_code_preview.png" alt></p>
<p>就这短短的十行代码代码？seriously？“有图有真相”，我们先来看下运行的效果：</p>
<h3 id="首先是原始的图片"><a href="#首先是原始的图片" class="headerlink" title="首先是原始的图片"></a>首先是原始的图片</h3><p><img src="http://cloudsdocker.github.io/images/facial_oriImage.jpg" alt></p>
<h3 id="运行程序后识别出面部并高亮显示的结果"><a href="#运行程序后识别出面部并高亮显示的结果" class="headerlink" title="运行程序后识别出面部并高亮显示的结果"></a>运行程序后识别出面部并高亮显示的结果</h3><p>请注意 <em>K歌二人组</em> 的脸上的红色框框，这就是上面十行代码的成果。<br><img src="http://cloudsdocker.github.io/images/facial_postProcessImage.png" alt></p>
<h2 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>因为此程序使用是的Python,因此你需要去安装Python。这里就不赘述了。除此之外，还需要安装 <a href="http://opencv.org/downloads.html" target="_blank" rel="noopener">OpenCV</a> (<a href="http://opencv.org/downloads.html)。" target="_blank" rel="noopener">http://opencv.org/downloads.html)。</a><br>多说一句,这个 OpenCV正如其名，是一个开源的机器识别的深度学习框架。这是Intel（英特尔）实验室里的一个俄罗斯团队创造的，目前在开源社区非常的活跃。</p>
<p>特别提一下，对于Mac的用户，推荐使用brew去安装 （下面第一条语句可能会执行报错，我当时也是搞了好久。如果遇到第一条命令不过可以通过文尾的方式联系作者）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap homebrew/science</span><br><span class="line">brew install opencv</span><br></pre></td></tr></table></figure>

<p>安装完成之后,在python的命令行中输入如下代码验证，如果没有报错就说明安装好了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import cv2</span><br></pre></td></tr></table></figure>

<h3 id="程序代码“庖丁解牛”"><a href="#程序代码“庖丁解牛”" class="headerlink" title="程序代码“庖丁解牛”"></a>程序代码“庖丁解牛”</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> cv2,sys</span><br></pre></td></tr></table></figure>

<ul>
<li>由于这里注释及窗口标题中使用了中文，因此加上utf-8字符集的支持</li>
<li>引入Opencv库以及Python的sys内建库，用于解析输入的图片参数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inputImageFile=sys.argv[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>在运行程序时将需要测试的照片文件名作为一个参数传进来</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faceClassifier=cv2.CascadeClassifier(<span class="string">'haarcascade_frontalface_default.xml'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>加载OpenCV中自带预先培训好的人脸识别层级分类器 HAAR Casscade Classifier，这个会用来对我们输入的图片进行人脸判断。</li>
</ul>
<p>这里有几个在深度学习及机器图像识别领域中的几个概念，稍微分析一下，至于深入的知识，大家可以自行搜索或者联系作者。</p>
<h3 id="Classifer"><a href="#Classifer" class="headerlink" title="Classifer"></a>Classifer</h3><p>在机器深度学习领域，针对识别不同物体都有不同的classifier,比如有的classifier来识别洗车，还有识别飞机的classifier，有classifier来识别照片中的笑容，眼睛等等。而我们这个例子是需要去做人脸识别，因此需要一个面部识别的classifier。</p>
<h3 id="物体识别的原理"><a href="#物体识别的原理" class="headerlink" title="物体识别的原理"></a>物体识别的原理</h3><p>一般来说，比如想要机器学习着去识别“人脸”，就会使用大量的样本图片来事先培训，这些图片分为两大类，positive和negative的，也就是分为包“含有人脸”的图片和“不包含人脸”的图片，这样当使用程序去一张一张的分析这些图片，然后分析判断并对这些图片“分类” (classify),即合格的图片与不合格的图片，这也就其为什么叫做 <em>classifier</em> ， 这样学习过程中积累的”知识”，比如一些判断时的到底临界值多少才能判断是positive还是negative什么的，都会存储在一个个XML文件中，这样使用这些前人经验（这里我们使用了 <em>哈尔</em> 分类器）来对新的图片进行‘专家判断’分析，是否是人脸或者不是人脸。</p>
<h3 id="Cascade"><a href="#Cascade" class="headerlink" title="Cascade"></a>Cascade</h3><p>这里的 Cascade是 <em>层级分类器</em> 的意思。为什么要 <em>分层</em> 呢？刚才提到在进行机器分析照片时，其实是对整个图片从上到下，从左到右，一个像素一个像素的分析，这些分析又会涉及很多的 <em>特征分析</em> ，比如对于人脸分析就包含识别眼睛，嘴巴等等，一般为了提高分析的准确度都需要有成千上万个特征，这样对于每个像素要进行成千上万的分析，对于整个图片都是百万甚至千万像素，这样总体的计算量会是个天文数字。但是，科学家很聪明，就想到分级的理念，即把这些特征分层，这样分层次去验证图片，如果前面层次的特征没有通过，对于这个图片就不用判断后面的特征了。这有点像是系统架构中的 <em>FF (Fail Fast)</em>,这样就提高了处理的速度与效率。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objImage=cv2.imread(inputImageFile)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用OpenCV库来加载我们传入的测试图片</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cvtImage=cv2.cvtColor(objImage,cv2.COLOR_BGR2GRAY)</span><br></pre></td></tr></table></figure>

<ul>
<li>首先将图片进行灰度化处理，以便于进行图片分析。这种方法在图像识别领域非常常见，比如在进行验证码的机器识别时就会先灰度化，去除不相关的背景噪音图像，然后再分析每个像素，以便抽取出真实的数据。不对针对此，你就看到非常多的验证码后面特意添加了很多的噪音点，线，就是为了防止这种程序来灰度化图片进行分析破解。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foundFaces=faceClassifier.detectMultiScale(cvtImage,scaleFactor=<span class="number">1.3</span>,minNeighbors=<span class="number">9</span>,minSize=(<span class="number">50</span>,<span class="number">50</span>),flags = cv2.cv.CV_HAAR_SCALE_IMAGE)</span><br></pre></td></tr></table></figure>

<ul>
<li>执行detectMultiScale方法来识别物体，因为我们这里使用的是人脸的cascade classifier分类器，因此调用这个方法会来进行面部识别。后面这几个参数来设置进行识别时的配置，比如<ul>
<li>scaleFactor: 因为在拍照，尤其现在很多都是自拍，这样照片中有的人脸大一些因为离镜头近，而有些离镜头远就会小一些，因为这个参数用于设置这个因素，如果你在使用不同的照片时如果人脸远近不同，就可以修改此参数，请注意此参数必须要大于1.0</li>
<li>minNeighbors: 因为在识别物体时是使用一个移动的小窗口来逐步判断的，这个参数就是决定是不是确定找到物体之前需要判断多少个周边的物体</li>
<li>minSize：刚才提到识别物体时是合作小窗口来逐步判断的，这个参数就是设置这个小窗口的大小</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">" 在图片中找到了 &#123;&#125; 个人脸"</span>.format(len(foundFaces)))</span><br></pre></td></tr></table></figure>

<ul>
<li>显示出查找到多少张人脸，需要提到的识别物体的方法返回的一个找到的物体的位置信息的列表，因此使用 <em>len</em> 来打印出找到了多少物体。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (x,y,w,h) <span class="keyword">in</span> foundFaces:</span><br><span class="line">    cv2.rectangle(objImage,(x,y),(x+w,y+h),(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>),<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>遍历发现的“人脸”，需要说明的返回的是由4部分组成的位置数据，即这个“人脸”的横轴，纵轴坐标，宽度与高度。</li>
<li>然后使用 <em>OpenCV</em> 提供的方法在原始图片上画出个矩形。其中 <em>(0,0,255)</em> 是使用的颜色，这里使用的是R/G/B的颜色表示方法，比如 (0,0,0)表示黑色，(255,255,255)表示白色，有些网页编程经验的程序员应该不陌生。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cv2.imshow(<span class="string">u'面部识别的结果已经高度框出来了。按任意键退出'</span>.encode(<span class="string">'gb2312'</span>), objImage)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来是使用 <em>opencv</em> 提供的imshow方法来显示这个图片，其中包括我们刚刚画的红色的识别的结果</li>
<li>最后一个语句是让用户按下键盘任意一个键来退出此图片显示窗口</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>好了，上面是这个程序的详细解释以及相关的知识的讲解。其实这个只是个_抛砖引玉_的作用，还用非常多的应用场景，比如程序解析网页上的图片验证码，雅虎前几个月开源的 <a href="https://github.com/yahoo/open_nsfw" target="_blank" rel="noopener">NSFW</a>, Not Suitable for Work (NSFW)，即判断那些不适合工作场所的图片，内容你懂的。 :-)</p>
<p>最后，再提一下，所有这些源代码及相关文件都开源在 <a href="https://github.com/CloudsDocker/pyFacialRecognition" target="_blank" rel="noopener">https://github.com/CloudsDocker/pyFacialRecognition</a> ，在fork并下载到本地后执行下面代码来测试运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/CloudsDocker/pyFacialRecognition.git</span><br><span class="line"><span class="built_in">cd</span> pyFacialRecognition</span><br><span class="line">./run.sh</span><br></pre></td></tr></table></figure>

<p>如果有任何建议或者想法，请联系我。</p>
<h2 id="联系我："><a href="#联系我：" class="headerlink" title="联系我："></a>联系我：</h2><ul>
<li><a href="mailto:phray.zhang@gmail.com" target="_blank" rel="noopener">phray.zhang@gmail.com</a> (email/邮件，whatsapp, linkedin)</li>
<li>helloworld_2000 (wechat/微信)</li>
<li>微博: cloudsdocker</li>
<li><a href="https://github.com/CloudsDocker/" target="_blank" rel="noopener">github</a></li>
<li>[简书 jianshu]（<a href="http://www.jianshu.com/users/a9e7b971aafc）" target="_blank" rel="noopener">http://www.jianshu.com/users/a9e7b971aafc）</a></li>
<li>微信公众号：vibex</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://docs.opencv.org/trunk/index.html" target="_blank" rel="noopener">OpenCV</a></li>
<li><a href="https://zh.wikipedia.org/wiki/哈尔特征" target="_blank" rel="noopener">HAAR 哈尔特征</a></li>
<li><a href="http://docs.opencv.org/trunk/d7/d8b/tutorial_py_face_detection.html" target="_blank" rel="noopener">Face Detection using Haar Cascades</a></li>
<li><a href="https://github.com/yahoo/open_nsfw" target="_blank" rel="noopener">NSFW</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-12-01-Java-New-Features-Chronicle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-12-01-Java-New-Features-Chronicle/" class="post-title-link" itemprop="url">Java new features</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="JDK-Versions"><a href="#JDK-Versions" class="headerlink" title="JDK Versions"></a>JDK Versions</h1><ul>
<li>JDK 1.5 in 2005</li>
<li>JDK 1.6 in 2006</li>
<li>JDK 1.7 in 2011</li>
<li>JDK 1.8 in 2014<br>Sun之前风光无限，但是在2010年1月27号被Oracle收购。<br>在被Oracle收购后对外承诺要回到每2年一个realse的节奏。但是2014年就公布由于Java Security的问题delay一年</li>
</ul>
<h1 id="Java新功能一览"><a href="#Java新功能一览" class="headerlink" title="Java新功能一览"></a>Java新功能一览</h1><ul>
<li>Generics</li>
<li>Concurrent Framework</li>
<li>Numberic Literal</li>
<li>Lambda</li>
</ul>
<h1 id="JDK-New-release-vs-Stock-Price"><a href="#JDK-New-release-vs-Stock-Price" class="headerlink" title="JDK New release vs. Stock Price"></a>JDK New release vs. Stock Price</h1><p>最近在做一个Java项目的相关工作，发现很多程序员还在使用一些最基本的Java语言特性，其实可以理解为很多人入门Java要么在学校里要么通过某些书籍，而这些在国内的学习资料更新比较慢，很多都还是基于JDK1.4或者更老。其实Java这个语言一直在进步。下面我就以Java最近几个主版本引入的新功能来梳理一下这些“黑科技”</p>
<h2 id="Java-1-5"><a href="#Java-1-5" class="headerlink" title="Java 1.5"></a>Java 1.5</h2><p>这个版本个人认为在Java最近10年的历史中是一个最重要的升级。JDK1.5，内部版本号是Tiger，引入了一些颠覆性的功能，列在如下：<br>Generics<br>Conncurrecnt Framework，应该是继Collection Framework后又一个块头的“框架”了。</p>
<h2 id="Java-1-6"><a href="#Java-1-6" class="headerlink" title="Java 1.6"></a>Java 1.6</h2><p>所有上面提到的东西，包括此文章的markdown源代码，mindmap思维导图等等都可以在我的github上找到。联系我：</p>
<ul>
<li><a href="mailto:phray.zhang@gmail.com" target="_blank" rel="noopener">phray.zhang@gmail.com</a> (email/邮件，whatsapp, linkedin)</li>
<li>helloworld_2000 (wechat/微信)</li>
<li><a href="https://github.com/CloudsDocker/" target="_blank" rel="noopener">github</a></li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://en.wikipedia.org/wiki/Java_version_history" target="_blank" rel="noopener">JDK History</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-12-09-HeadsFirst-RandomNumber-In-Java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-12-09-HeadsFirst-RandomNumber-In-Java/" class="post-title-link" itemprop="url">Random number in java</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>ThreadLocalRandom, SecureRandm, java.util.Random, java.math.Random</p>
<p>Instances of java.util.Random are threadsafe. However, the concurrent use of the same java.util.Random instance across threads may encounter contention and consequent poor performance. Consider instead using ThreadLocalRandom in multithreaded designs. </p>
<p>The Java Math library function Math.random() generates a double value in the range [0,1). Notice this range does not include the 1.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> rand = ThreadLocalRandom.current().nextInt(x,y);</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="http://www.javaguru.co/2014/12/how-to-generate-range-of-random.html" target="_blank" rel="noopener">How to generate a range of random integers in Java</a></li>
<li><a href="http://docs.oracle.com/javase/8/docs/api/java/util/Random.html" target="_blank" rel="noopener">Random JavaDoc</a></li>
<li><a href="http://docs.oracle.com/javase/8/docs/api/java/security/SecureRandom.html" target="_blank" rel="noopener">SecureRandom JavaDoc</a></li>
<li><a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadLocalRandom.html" target="_blank" rel="noopener">ThreadLocalRandom JavaDoc</a></li>
<li><a href="http://commons.apache.org/proper/commons-math/" target="_blank" rel="noopener">Apache Common Math</a></li>
<li><a href="https://en.wikipedia.org/wiki/Linear_congruential_generator" target="_blank" rel="noopener">LCG wikipedia</a></li>
<li><a href="http://www.programering.com/a/MDN1ETMwATM.html" target="_blank" rel="noopener">Blog about this topic</a></li>
<li><a href="http://www.importnew.com/12460.html" target="_blank" rel="noopener">ImportNew</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-12-12-Angular/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-12-12-Angular/" class="post-title-link" itemprop="url">Angulary Misc</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Dependency-Injection"><a href="#Dependency-Injection" class="headerlink" title="Dependency Injection"></a>Dependency Injection</h1><p>Angular doesn’t automatically know how you want to create instances of your services or the injector to create your service. You must configure it by specifying providers for every service.</p>
<p>Providers tell the injector how to create the service. Without a provider, the injector would not know that it is responsible for injecting the service nor be able to create the service.</p>
<h1 id="What-is-difference-between-declarations-providers-and-import-in-NgModule"><a href="#What-is-difference-between-declarations-providers-and-import-in-NgModule" class="headerlink" title="What is difference between declarations, providers and import in NgModule"></a>What is difference between declarations, providers and import in NgModule</h1><ul>
<li>imports: is used to import supporting modules likes FormsModule, RouterModule, CommonModule, or any other custom-made feature module. makes the exported declarations of other modules available in the current module</li>
<li>declarations are to make directives (including components and pipes) from the current module available to other directives in the current module. Selectors of directives, components or pipes are only matched against the HTML if they are declared or imported. declaration is used to declare components, directives, pipes that belongs to the current module. Everything inside declarations knows each other. For example, if we have a component, say UsernameComponent, which display list of the usernames, and we also have a pipe, say toupperPipe, which transform string to uppercase letter string. Now If we want to show usernames in uppercase letters in our UsernameComponent, we can use the toupperPipe which we had created before but how UsernameComponent know that the toupperPipe exist and how we can access and use it, here comes the declarations, we can declare UsernameComponent and toupperPipe.</li>
<li>providers are to make services and values known to DI. They are added to the root scope and they are injected to other services or directives that have them as dependency.provider is used to inject the services required by components, directives, pipes in our module.</li>
</ul>
<h1 id="CLI-to-create-new-component"><a href="#CLI-to-create-new-component" class="headerlink" title="CLI to create new component"></a>CLI to create new component</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ng generate component components/xxx-table -m deposit.module.ts --spec</span><br><span class="line">ng generate component components/comp1 -m core.module.ts --spec</span><br><span class="line"><span class="built_in">Error</span>: Specified <span class="built_in">module</span> does not exist</span><br><span class="line">Specified <span class="built_in">module</span> does not exist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ng generate component core/components/comp1 -m core/core.module --spec</span><br><span class="line"><span class="built_in">Error</span>: dryRunSink.commit(...).ignoreElements is not a <span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function"><span class="title">dryRunSink</span>.<span class="title">commit</span>(<span class="params">...</span>).<span class="title">ignoreElements</span> <span class="title">is</span> <span class="title">not</span> <span class="title">a</span> <span class="title">function</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ng</span> <span class="title">generate</span> <span class="title">component</span> <span class="title">app</span>/<span class="title">core</span>/<span class="title">components</span>/<span class="title">comp1</span> -<span class="title">m</span> <span class="title">app</span>/<span class="title">core</span>/<span class="title">core</span>.<span class="title">module</span> --<span class="title">spec</span></span></span><br></pre></td></tr></table></figure>

<h1 id="Angular-JS-notes"><a href="#Angular-JS-notes" class="headerlink" title="Angular JS notes"></a>Angular JS notes</h1><p>AngularJS applications are built around a design pattern called Model-View-Controller (MVC), which places an emphasis on creating applications that are</p>
<ul>
<li>Extendable: It is easy to figure out how even a complex AngularJS app works once you understand the basics—and that means you can easily enhance applications to create new and useful features for your users.</li>
<li>Maintainable: AngularJS apps are easy to debug and fix, which means that long-term maintenance is simplified.</li>
<li>Testable: AngularJS has good support for unit and end-to-end testing, meaning that you can find and fix defects before your users do.</li>
<li>Standardized: AngularJS builds on the innate capabilities of the web browser without getting in your way, allowing you to create standards-compliant web apps that take advantage of the latest features (such as HTML5 APIs) and popular tools and frameworks.</li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-12-24-Apache-Tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-12-24-Apache-Tips/" class="post-title-link" itemprop="url">Apache Tips</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo su -</span><br><span class="line">apachectl start</span><br><span class="line">apachectl stop</span><br></pre></td></tr></table></figure>

<p>Open a browser to access <a href="http://localhost/" target="_blank" rel="noopener">http://localhost/</a></p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-12-30-HashCode-Contract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-12-30-HashCode-Contract/" class="post-title-link" itemprop="url">Hash Code Misc</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="contract-of-hashCode"><a href="#contract-of-hashCode" class="headerlink" title="contract of hashCode :"></a>contract of hashCode :</h1><ul>
<li>Whenever it is <strong>invoked on the same object more than once during an execution of a Java application, the hashCode method must consistently return the same integer</strong>, provided no information used in equals comparisons on the object is modified. This <em>integer need <strong>not</strong> remain consistent from one execution of an application to another execution of the <strong>same</strong> application</em>.</li>
<li>If two objects <strong>are equal</strong> according to the equals(Object) method, then calling the hashCode method on each of the two objects must produce the <strong>same integer</strong> result.</li>
<li>It is <strong>not required</strong> that <strong>if two objects are unequal</strong> according to the equals(java.lang.Object) method, then calling the hashCode method on each of the two objects <strong>must produce distinct integer results</strong>. However, the programmer should be aware that producing distinct integer results for unequal objects <em>may improve the performance of hash tables</em>.</li>
</ul>
<p>As much as is reasonably practical, the hashCode method defined by class Object does return distinct integers for distinct objects. (This is typically implemented by <strong>converting the internal address</strong> of the object into an integer, but this implementation technique is not required by the JavaTM programming language.)</p>
<h1 id="Hashcode-in-Java-Collections"><a href="#Hashcode-in-Java-Collections" class="headerlink" title="Hashcode in Java Collections"></a>Hashcode in Java Collections</h1><h2 id="Hashcode-vs-equals"><a href="#Hashcode-vs-equals" class="headerlink" title="Hashcode vs. equals"></a>Hashcode vs. equals</h2><h3 id="Equals"><a href="#Equals" class="headerlink" title="Equals"></a>Equals</h3><p>For usage in java collections framework, <strong>equals()</strong> used in following scenarios:</p>
<ul>
<li>contains or not</li>
<li>to remove one item</li>
</ul>
<p>Below is one implementation of a Equals</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(o==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(!(o <span class="keyword">instanceof</span> Employee)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        Employee other=(Employee)o;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.employeeID==other.employeeID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hashcode"><a href="#Hashcode" class="headerlink" title="Hashcode"></a>Hashcode</h3><p>When insert data into HashTable, HashMap, HashSet, the hashcode used to determine <strong>where</strong> to <strong>store/search</strong> the value in list/bucket. The hashcode only <strong>point to an area</strong> in list/bucket of data. The hashtable then iterates this area (all keys with the same hash code) and uses the key’s equals() method to find the right key. Once the right key is found, the object stored for that key is returned. </p>
<p>After you override the hashcode, you are still be able to get origional hashcode via calling <strong>int originalHashCode = System.identityHashCode(emp1);</strong></p>
<h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><p>In this regard there is a rule of thumb that if you are going to overide the one of the methods (equals, hashcode), you have to override both, othersise it’s a violation of contract .</p>
<h2 id="HashMap-tips"><a href="#HashMap-tips" class="headerlink" title="HashMap tips"></a>HashMap tips</h2><ul>
<li>Since searching inlined list is O(n) operation, in worst case hash collision reduce a map to linked list. This issue is recently addressed in Java 8 by replacing linked list to the tree to search in O(logN)</li>
<li><strong>HashMap works on the principle of hashing</strong>.</li>
<li>HashMap  stores both Key and Value in LinkedList node or as Map</li>
<li>using immutable, final object with proper equals() and hashcode() implementation would act as perfect Java HashMap  keys and improve the performance of Java HashMap  by reducing collision. <strong>Immutability also allows caching their hashcode of different keys which makes overall retrieval process very fast</strong> and suggest that String and various wrapper classes e.g. Integer very good keys in Java HashMap.</li>
<li>if the load factor is .75 it will act to re-size the map once it filled 75%. Java HashMap re-size itself by creating a new bucket array of size twice of the previous size of HashMap and then start putting every old element into that new bucket array. This process is called rehashing because it also applies the hash function to find new bucket location. </li>
<li>there is potential race condition exists while resizing HashMap in Java, if two thread at the same time found that now HashMap needs resizing and they both try to resizing. on the process of resizing of HashMap in Java, the element in the bucket which is stored in linked list get reversed in order during their migration to new bucket because Java HashMap  doesn’t append the new element at tail instead it append new element at the head to avoid tail traversing.</li>
<li>If race condition happens then you will end up with an infinite loop. </li>
</ul>
<h2 id="Why-String-Integer-and-other-wrapper-classes-are-considered-good-keys"><a href="#Why-String-Integer-and-other-wrapper-classes-are-considered-good-keys" class="headerlink" title="Why String, Integer and other wrapper classes are considered good keys?"></a>Why String, Integer and other wrapper classes are considered good keys?</h2><ul>
<li>String, Integer and other wrapper classes are natural candidates of HashMap key, and String is most frequently used key as well because String is immutable and final, and overrides equals and hashcode() method. </li>
<li>Immutability is best as it offers other advantages as well like thread-safety, If you can  keep your hashCode same by only making certain fields final, then you go for that as well.</li>
</ul>
<h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h1><ul>
<li>ConcurrentHashMap provides better concurrency by only locking portion of map determined by concurrency level. </li>
<li>but Hashtable provides stronger thread-safety than ConcurrentHashMap</li>
<li>ConcurrentHashMap performs better than earlier two because it only locks a portion of Map, instead of whole Map, which is the case with Hashtable and synchronized Map. </li>
<li>provided all functions supported by Hashtable with an additional feature called “concurrency level”, which allows ConcurrentHashMap to partition Map.</li>
<li>ConcurrentHashMap allows multiple readers to read concurrently without any blocking. This is achieved by partitioning Map into different parts based on concurrency level and locking only a portion of Map during updates. </li>
<li><strong>Default concurrency level is 16</strong>, and accordingly Map is divided into 16 part and each part is governed with a different lock. This means, 16 thread can operate on Map simultaneously until they are operating on different part of Map. </li>
<li>Since update operations like put(), remove(), putAll() or clear() is not synchronized, concurrent retrieval may not reflect most recent change on Map.</li>
<li>ConcurrentHashMap also uses ReentrantLock to internally lock its segments.</li>
<li>In hashmap and hashtable, you can check one item first and add it if not present. Though this code will work fine in HashMap and Hashtable, This won’t work in ConcurrentHashMap; because, during put operation whole map is not locked, and while one thread is putting value, other thread’s get() call can still return null which result in one thread overriding value inserted by other thread. Ofcourse, you can wrap whole code in synchronized block and make it thread-safe but that will only make your code single threaded. ConcurrentHashMap provides putIfAbsent(key, value) which does same thing but atomically and thus eliminates above race condition</li>
<li>ConcurrentHashMap is best suited when you have <strong>multiple readers</strong> and <strong>few writers</strong>. If writers outnumber reader, or writer is equal to reader, than performance of ConcurrentHashMap <strong>effectively reduces to synchronized map or Hashtable</strong>. Performance of CHM drops, because you got to <strong>lock all portion of Map</strong>, and effectively each reader will wait for another writer, operating on that portion of Map. ConcurrentHashMap is a good choice for caches, which can be initialized during application start up and later accessed my many request processing threads.</li>
<li>ConcurrentHashMap allows <strong>concurrent read</strong> and <strong>thread-safe update</strong> operation.</li>
<li>Iterator returned by ConcurrentHashMap is weekly consistent, fail-safe and never throw ConcurrentModificationException. </li>
<li>In Java.ConcurrentHashMap <strong>doesn’t allow null as key or value</strong>.</li>
</ul>
<h1 id="How-null-work-in-HashMap"><a href="#How-null-work-in-HashMap" class="headerlink" title="How null work in HashMap"></a>How null work in HashMap</h1><p> How null key is handled in HashMap? Since equals() and hashCode() are used to store and retrieve values, how does it work in case of the null key?</p>
<p>The null key is handled specially in HashMap, there are two separate methods for that putForNullKey(V value)<br>and getForNullKey()<br>. Later is offloaded version of get() to look up null keys.  Null keys always map to index 0.  This null case is split out into separate methods for the sake of performance in the two most commonly used operations (get and put), but incorporated with conditionals in others. In short, equals()<br>and hashcode() method are not used in case of null keys in HashMap.</p>
<h1 id="Performance-changes-in-JDK-1-7-and-1-8"><a href="#Performance-changes-in-JDK-1-7-and-1-8" class="headerlink" title="Performance changes in JDK 1.7 and 1.8"></a>Performance changes in JDK 1.7 and 1.8</h1><ul>
<li>There is some performance improvement done on HashMap and ArrayList from JDK 1.7, which reduce memory consumption. Due to this empty Map are lazily initialized and will cost you less memory. Earlier, when you create HashMap e.g. new HashMap() it automatically creates an array of default length e.g. 16. After some research, Java team found that most of this Map are temporary and never use that many elements, and only end up wasting memory. Also, From JDK 1.8 onwards HashMap has introduced an improved strategy to deal with high collision rate. Since a poor hash function e.g. which always return location of same bucket, can turn a HashMap into linked list, i.e. converting get() method to perform <strong>in O(n) instead of O(1)</strong> and someone can take advantage of this fact, Java now internally replace linked list to a binary true once certain threshold is breached. This ensures performance or order O(log(n)) even in the worst case where a hash function is not distributing keys properly.</li>
<li>such change is creating empty ArrayList and HashMap with size zero in JDK 1.7.0_40 update.</li>
<li>If you are running on Java 1.6 or earlier version of Java 1.7, you can open code of java.util.ArrayList and check that, currently empty ArrayList is initialized with Object array of <strong>size 10</strong>. If you create several temporary list in your program, which remains uninitialized, due to any reason then you are not only losing memory but also losing performance by giving your garbage collector more work.</li>
<li>Same is true for empty HashMap, which was initialized by <strong>default initial capacity of 16</strong>. This changes are result of observation made by Nathan Reynolds, and Architect at Oracle, which apparently analysed 670 Java heap dumps from different Java programs to find out memory hogs.</li>
<li>By the way, it’s not just memory, it’s also extra work-load for Garbage collector</li>
</ul>
<h1 id="Hashtable"><a href="#Hashtable" class="headerlink" title="Hashtable"></a>Hashtable</h1><ul>
<li>One of the major differences between HashMap and Hashtable is that HashMap is non-synchronized whereas Hashtable is synchronized</li>
<li>Another difference is HashMap allows <strong>one</strong> null key and null values but *<em>Hashtable doesn’t allow null *</em> key or values.</li>
<li>Another significant difference between HashMap vs Hashtable is that Iterator in the <strong>HashMap is  a fail-fast ** iterator  while the enumerator for the **Hashtable is not and throw ConcurrentModificationException</strong> if any other Thread modifies the map structurally  by adding or removing any element except Iterator’s own remove() method</li>
</ul>
<h1 id="ConcurrentHashMap-vs-Hashtable-vs-Synchronized-Map"><a href="#ConcurrentHashMap-vs-Hashtable-vs-Synchronized-Map" class="headerlink" title="ConcurrentHashMap vs Hashtable vs Synchronized Map"></a>ConcurrentHashMap vs Hashtable vs Synchronized Map</h1><ul>
<li>Though all three collection classes are thread-safe and can be used in multi-threaded, concurrent Java application, there is a significant difference between them, which arise from the fact that <strong>how they achieve their thread-safety</strong>. </li>
<li>Hashtable is a legacy class from JDK 1.1 itself, which uses <strong>synchronized methods</strong> to achieve thread-safety. All methods of Hashtable are synchronized which makes them quite slow due to contention if a number of thread increases. </li>
<li>Synchronized Map is also <strong>not very different than Hashtable</strong> and provides similar performance in concurrent Java programs. The only difference between Hashtable and Synchronized Map is that later is not a legacy and you <strong>can wrap any Map</strong> to create it’s synchronized version by using Collections.synchronizedMap()</li>
<li>Unlike Hashtable and Synchronized Map, it <strong>never locks whole Map</strong>, instead, it divides the map into segments and locking is done on those. Though it performs better if a number of <strong>reader threads are greater than</strong> the number of writer threads.</li>
<li><strong>ConcurrentHashMap and CopyOnWriteArrayList</strong> implementations provide much <strong>higher concurrency while preserving thread safety</strong>, with some minor compromises in their promises to callers. ConcurrentHashMap and CopyOnWriteArrayList are not necessarily useful everywhere you might use HashMap or ArrayList, but are designed to optimize specific common situations. </li>
<li><strong>ConcurrentHashMap does not allow null</strong> keys or null values while <strong>synchronized HashMap allows one null key</strong>.</li>
</ul>
<h1 id="Synchronized-List"><a href="#Synchronized-List" class="headerlink" title="Synchronized List"></a>Synchronized List</h1><ul>
<li><p>CopyOnWriteArrayList and CopyOnWriteArraySet<br>CopyOnWriteArrayList is a concurrent alternative of synchronized List. CopyOnWriteArrayList provides better concurrency than synchronized List by allowing <strong>multiple concurrent reader</strong> and <strong>replacing the whole list on write</strong> operation. Yes, write operation is costly on CopyOnWriteArrayList but it <strong>performs better when there are multiple reader</strong> and requirement of <strong>iteration is more than writing</strong>. Since CopyOnWriteArrayList Iterator also don’t throw ConcurrencModificationException <strong>it eliminates need to lock the collection during iteration</strong>. Remember both ConcurrentHashMap and CopyOnWriteArrayList doesn’t provides same level of locking as Synchronized Collection and achieves thread-safety by there locking and mutability strategy. So they perform better if requirements suits there nature. Similarly, CopyOnWriteArraySet is a concurrent replacement to Synchronized Set. See What is CopyOnWriteArrayList in Java for more details</p>
</li>
<li><p>BlockingQueue<br>BlockingQueue is also one of better known collection class in Java 5. BlockingQueue makes it easy <strong>to implement producer-consumer design pattern</strong> by providing inbuilt <strong>blocking support for put() and take() method</strong>. put() method will block if Queue is full while take() method will block if Queue is empty. Java 5 API provides two concrete implementation of BlockingQueue in form of <strong>ArrayBlockingQueue and LinkedBlockingQueue</strong>, both of them implement <strong>FIFO ordering</strong> of element. ArrayBlockingQueue <strong>is backed by Array</strong> and its <strong>bounded</strong> in nature while <strong>LinkedBlockingQueue is optionally bounded</strong>. Consider <strong>using BlockingQueue to solve producer Consumer problem</strong> in Java instead of writing your won wait-notify code. Java 5 also provides <strong>PriorityBlockingQueue</strong>, another implementation of BlockingQueue which is ordered on priority and useful if you want to process elements on order other than FIFO.</p>
</li>
<li><p>Deque interface<br>is added in Java 6 and it extends Queue interface to support <strong>insertion and removal from both end of Queue</strong> referred as <strong>head and tail</strong>. Java6 also provides concurrent implementation of Deque like <strong>ArrayDeque and LinkedBlockingDeque</strong>. Deque Can be used efficiently <strong>to increase parallelism in program by allowing set of worker thread *<em>to help each other by taking some of work load from other thread by utilizing Deque double end consumption property. So if all Thread has there *</em>own set of task Queue and they are consuming from head</strong>; helper thread can also share some work load via <strong>consumption from tail</strong>.</p>
</li>
<li><p>ConcurrentSkipListMap and ConcurrentSkipListSet<br>Just like ConcurrentHashMap provides a concurrent alternative of synchronized HashMap. <strong>ConcurrentSkipListMap and ConcurrentSkipListSet provide concurrent alternative</strong> for synchronized version of <strong>SortedMap and SortedSet</strong>. For example instead of using TreeMap or TreeSet wrapped inside synchronized Collection, You can consider using ConcurrentSkipListMap or ConcurrentSkipListSet from java.util.concurrent package. They also implement NavigableMap and NavigableSet to add additional navigation method we have seen in our post How to use NavigableMap in Java.</p>
</li>
</ul>
<h1 id="To-sort-hashmap-by-key-and-value"><a href="#To-sort-hashmap-by-key-and-value" class="headerlink" title="To sort hashmap by key and value"></a>To sort hashmap by key and value</h1><ul>
<li>Why can’t we use TreeMap in place of HashMap is the question appears in most Java programmer’s mind when they asked to sort HashMap in Java. Well, TreeMap is way slower than HashMap because it runs sorting operation with each insertion, update and removal and sometimes you don’t really need an all time sorted Map, What you need is an ability to sort any Map implementation based upon its key and value.<h2 id="Sort-by-Key"><a href="#Sort-by-Key" class="headerlink" title="Sort by Key"></a>Sort by Key</h2></li>
<li>As I said Map or HashMap in Java can be sorted either on keys or values. Sorting Map on keys is rather easy than sorting on values because Map <strong>allows duplicate values but doesn’t allow duplicates keys</strong>. You can sort Map, be it HashMap or Hashtable by copying keys into List than sorting List by using Collections.sort() method, here you can use either Comparator or Comparable based upon whether you want to sort on a custom order or natural order. </li>
<li>Once List of keys is sorted, we can create another Map, particularly LinkedHashMap to insert keys in sorted order. LinkedHashMap will maintain the order on which keys are inserted, the result is a sorted Map based on keys. This is shown in the following example by writing a generic parameterized method to sort Map based on keys. You can also sort Map in Java by using TreeMap and Google Collection API (Guava). The advantage of using Guava is that you get some flexibility on specifying ordering.<h2 id="Sorting-Map-in-Java-By-Value"><a href="#Sorting-Map-in-Java-By-Value" class="headerlink" title="Sorting Map in Java - By Value"></a>Sorting Map in Java - By Value</h2></li>
<li>To implement Collection.sort(map, new Comparator&lt;Map.Entry&lt;K,V&gt;&gt;(){ o1.getValue().compareTo(o2.getValue())</li>
<li>But need to take care of null and duplication</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="http://javarevisited.blogspot.in/2011/02/how-hashmap-works-in-java.html" target="_blank" rel="noopener">http://javarevisited.blogspot.in/2011/02/how-hashmap-works-in-java.html</a></li>
<li><a href="http://javarevisited.blogspot.in/2011/04/difference-between-concurrenthashmap.html" target="_blank" rel="noopener">http://javarevisited.blogspot.in/2011/04/difference-between-concurrenthashmap.html</a></li>
<li><a href="http://javarevisited.blogspot.com/2013/02/concurrent-collections-from-jdk-56-java-example-tutorial.html#ixzz4WBYzKelD" target="_blank" rel="noopener">http://javarevisited.blogspot.com/2013/02/concurrent-collections-from-jdk-56-java-example-tutorial.html#ixzz4WBYzKelD</a></li>
<li><a href="http://javarevisited.blogspot.com/2012/12/how-to-sort-hashmap-java-by-key-and-value.html#ixzz4WBgfeGVM" target="_blank" rel="noopener">http://javarevisited.blogspot.com/2012/12/how-to-sort-hashmap-java-by-key-and-value.html#ixzz4WBgfeGVM</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2016-12-30-Java-GC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2016-12-30-Java-GC/" class="post-title-link" itemprop="url">Java GC notes</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="verbose-gc"><a href="#verbose-gc" class="headerlink" title="verbose:gc"></a>verbose:gc</h1><p><code>verbose:gc</code> prints right after each gc collection and prints details about each generation memory details. Here is blog on how to read verbose gc</p>
<p>If you are trying to look for memory leak, verbose:gc may not be enough. Use some visualization tools like jhat (or) visualvm etc.,</p>
<p> 4416K-&gt;512K(4928K), 0.0081170 secs</p>
<p>Before GC used memory is 4416K<br>After GC used memory is 512K<br>Total allocated memory is 4928K</p>
<p>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:C:/Users/tzhang17/temp/gc/gc.log</p>
<p>a typical ratio of YoungGen vs. OldGen is 1:3 or 33%.</p>
<p>Minimizing the frequency of major GC collections is a key aspect for optimal performance so it is very important that you understand and estimate how much memory you need during your peak volume.</p>
<p>Again, your type of application and data will dictate how much memory you need. Shopping cart type of applications (long lived objects) involving large and non-serialized session data typically need large Java Heap and lot of OldGen space. Stateless and XML processing heavy applications (lot of short lived objects) require proper YoungGen space in order to minimize frequency of major collections.</p>
<h2 id="Generational-collection"><a href="#Generational-collection" class="headerlink" title="Generational collection"></a>Generational collection</h2><p>According to the generational hypothesis [21], most objects die young and consequently older objects tend to live longer. Generational collection capitalises on the generational hypothesis by dividing the available memory space into multiple regions called generations. Garbage collector passes are less frequent as the generations grow older and objects are always allocated into the newest generation. If the object survives a garbage collection, it is promoted to an older generation. Each generation can have a<br>separate garbage collection strategy.</p>
<h2 id="Reference-counting"><a href="#Reference-counting" class="headerlink" title="Reference counting"></a>Reference counting</h2><p> Reference counting uses a counter per object to record the number of<br>references to the object. The pointer is incremented each time a reference towards the<br>object is created. The object is reclaimed when its reference count drops to zero. Reference<br>counting is being extensively used by scripting languages such as Perl.</p>
<h2 id="GC-strategy"><a href="#GC-strategy" class="headerlink" title="GC strategy"></a>GC strategy</h2><p>Mark-Sweep garbage collection is most times followed by a compaction phase in order to avoid memory fragmentation. The compaction phase requires moving the objects to adjacent memory locations, thus making Mark-Sweep quite an expensive algorithm for large memory multiprocessor environments, unless a multithreaded heap compactor is employed.<br>Simple reference counting is also unsuitable for high throughput environments because it requires objects to be reclaimed on pointer updates; if a pointer is removed and the reference count of the pointed object drops to zero, the runtime system is required to collect both that object and the objects it references. Furthermore, a major drawback of reference counting is its inability to collect circular data structures, such as doubly linked lists. Despite its drawbacks, the simplicity in the implementation of reference counting made it the preferred garbage collection strategy in runtime environments with a limited lifetime, such as scripting languages.</p>
<h2 id="mutable-memory"><a href="#mutable-memory" class="headerlink" title="mutable memory"></a>mutable memory</h2><p>Memory in a typical JVM is organised in a series of mutable (garbage collected) and immutable zones. Class code is usually loaded in immutable space1 and remains there until the JVM is stopped. Also, the code emitted from the JIT compiler is temporarily stored in immutable space. The actual allocations take place in the heap, which is a contiguous memory area.</p>
<p>Apart from the class member values, each object also contains<br>additional data such as a pointer to the respective class methods and flags related to locking and<br>garbage collection. In most virtual machines, object headers take up to 8–12 bytes of additional<br>storage space for each object, and can therefore sadle a program with significant performance<br>and space overhead. A lot of work has been put into compacting the object header [6], which,<br>in some cases, resulted in space savings of up to 20%.</p>
<p>A failure to allocate space for an object triggers a garbage collection cycle. The root set<br>is determined by conservatively scanning the stacks of running or suspended threads and the<br>current values of the processor registers for potential pointers to the heap. Root set acquisition<br>can also be a performance bottleneck in the case when a large number of threads is executed<br>concurrently, though these costs can be amortised using clever co-operation of the garbage<br>collector with the JIT.</p>
<h2 id="JDK-1-5"><a href="#JDK-1-5" class="headerlink" title="JDK 1.5"></a>JDK 1.5</h2><p>Sun’s JVM is an implementation of the 1.5 version of the Java language specification. It features an adaptive optimising JIT compiler, the well-known Hotspot engine, and a choice of three garbage collectors [2, 12]. Sun’s JVM is based upon a generational copying garbage collector that utilises two generations  Figure 1 presents the heap organisation, which is shared among all collectors. Allocations initially occur in the eden space and survivors are promoted to one of the survivor spaces in a copying fashion. Optionally, portions of the heap space can be allocated to individual threads (Thread-Local Heaps (TLHs)), in order to speed up allocations on large-heap multithreaded environments. Objects that reach a certain age threshold, usually measured in minor garbage collection cycles, are copied to the tenured generation where they are left untouched until a major collection occurs. A mark-compact garbage collector is used for the tenured generation.</p>
<h1 id="Tuning-advise"><a href="#Tuning-advise" class="headerlink" title="Tuning advise"></a>Tuning advise</h1><ul>
<li>Unless you have specific hardware constraints, devote as much memory as you can to the virtual machine. A big heap size offers the opportunity for less frequent, albeit more time consuming, full heap collections. In a throughput-oriented environment sacrificing pause times to allow more CPU time for the executed application is often a good compromise. Do not allow the virtual machine to be swapped out to disk, as this is catastrophic for performance. In an application server that only runs a single virtual machine, you could devote about 90% of its available RAM to it and turn off paging, without risking the failure of either the virtual machine or the operating system.</li>
<li>Calculate the memory allocation rate for your application. It is a significant measurement that you should perform by exposing the application to full workload. Its impact varies depending on the underlying hardware. As a rule of thumb, on a multiprocessor machine, each processor could easily generate more than 150MB of garbage per second. High allocation rates can be efficiently dealt with by using parallel collectors or large eden heap sizes.</li>
</ul>
<h2 id="Committed-heap"><a href="#Committed-heap" class="headerlink" title="Committed heap"></a>Committed heap</h2><p>A MemoryUsage object represents a snapshot of memory usage. Instances of the MemoryUsage class are usually constructed by methods that are used to obtain memory usage information about individual memory pool of the Java virtual machine or the heap or non-heap memory of the Java virtual machine as a whole.<br>A MemoryUsage object contains four values:</p>
<p>init    represents the initial amount of memory (in bytes) that the Java virtual machine requests from the operating system for memory management during startup. The Java virtual machine may request additional memory from the operating system and may also release memory to the system over time. The value of init may be undefined.<br>used    represents the amount of memory currently used (in bytes).<br>committed    represents the amount of memory (in bytes) that is guaranteed to be available for use by the Java virtual machine. The amount of committed memory may change over time (increase or decrease). The Java virtual machine may release memory to the system and committed could be less than init. committed will always be greater than or equal to used.<br>max    represents the maximum amount of memory (in bytes) that can be used for memory management. Its value may be undefined. The maximum amount of memory may change over time if defined. The amount of used and committed memory will always be less than or equal to max if max is defined. A memory allocation may fail if it attempts to increase the used memory such that used &gt; committed even if used &lt;= max would still be true (for example, when the system is low on virtual memory).<br>Below is a picture showing an example of a memory pool:<br>        +———————————————-+<br>        +////////////////           |                  +<br>        +////////////////           |                  +<br>        +———————————————-+</p>
<pre><code>|--------|
   init
|---------------|
       used
|---------------------------|
          committed
|----------------------------------------------|</code></pre><h1 id="Garbage-Collection-for-JVM"><a href="#Garbage-Collection-for-JVM" class="headerlink" title="Garbage Collection for JVM"></a>Garbage Collection for JVM</h1><h2 id="Interpreting-vs-compile"><a href="#Interpreting-vs-compile" class="headerlink" title="Interpreting vs compile"></a>Interpreting vs compile</h2><ul>
<li>The HotSpot JVM (and other modern JVMs) uses a combination of bytecode interpretation and dynamic compilation. When a class is first loaded, the JVM executes it by interpreting the bytecode. At some point, if a method is run often enough, the dynamic compiler kicks in and converts it to machine code; when compilation completes, it switches from interpretation to direct execution.</li>
<li>Code may also be decompiled (reverting to interpreted execution) and recompiled for various reasons, such as loading a class that invalidates assumptions made by prior compilations, or gathering sufficient profiling data to decide that a code path should be recompiled with different optimizations.</li>
<li>One of the challenges of writing good benchmarks (in any language) is that optimizing compilers are adept at spotting and eliminating dead code—code that has no effect on the outcome. Since benchmarks often don’t compute anything, they are an easy target for the optimizer. Most of the time, it is a good thing when the optimizer prunes dead code from a program, but for a benchmark this is a big problem because then you are measuring less execution than you think.</li>
<li>Many microbenchmarks perform much “better” when run with HotSpot’s -server compiler than with -client, not just because the server compiler can produce more efficient code, but also because it is more adept at optimizing dead code.</li>
<li>Writing effective performance tests requires tricking the optimizer into not optimizing away your benchmark as dead code. This requires every computed result to be used somehow by your program—in a way that does not require synchronization or substantial computation.</li>
<li>We happen to need it to verify the correctness of the algorithm, but <strong>you can ensure that a value is used by printing it out</strong>. However, you should avoid doing I/O while the test is actually running, so as not to distort the run time measurement.</li>
<li>A cheap trick for preventing a calculation from being optimized away without introducing too much overhead is to compute the hashCode of the field of some derived object, compare it to an arbitrary value such as the current value of System. nanoTime, and print a useless and ignorable message if they happen to match:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(foo.x.hashCode()==System.nanoTime())</span><br><span class="line">	System.out.println(<span class="string">" "</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>The comparison will rarely succeed, and if it does, its only effect will be to insert a harmless space character into the output. (The print method buffers output until println is called, so in the rare case that hashCode and System.nanoTime are equal no I/O is actually performed.)</p>
<ul>
<li>Not only should every computed result be used, but <strong>results should also be unguessable</strong>. Otherwise, a smart dynamic optimizing compiler is allowed to replace actions with precomputed results. </li>
</ul>
<h1 id="Java-GC"><a href="#Java-GC" class="headerlink" title="Java GC"></a>Java GC</h1><p>Java’s GC considers objects “garbage” <strong>if they aren’t reachable through a chain starting at a garbage collection root</strong>, so these objects will be collected. Even though objects may point to each other to form a cycle, they’re <strong>still garbage if they’re cut off from the root</strong>.</p>
<p>See the section on unreachable objects in Appendix A: The Truth About Garbage Collection in Java Platform Performance: Strategies and Tactics (free ebook, also available on Safari) for the gory details.</p>
<h3 id="Java-Garbage-collector-handles-circular-reference"><a href="#Java-Garbage-collector-handles-circular-reference" class="headerlink" title="Java Garbage collector handles circular-reference!"></a>Java Garbage collector handles circular-reference!</h3><p>How?</p>
<p>There are special objects called called <strong>garbage-collection roots (GC roots)</strong>. These are always reachable and so is any object that has them at its own root.</p>
<p>A simple Java application has the following GC roots:</p>
<pre><code>Local variables in the main method
The main thread
Static variables of the main class</code></pre><p>To determine which objects are no longer in use, the JVM intermittently runs what is very aptly called a <strong>mark-and-sweep algorithm</strong>. It works as follows</p>
<pre><code>The algorithm traverses all object references, starting with the GC roots, and marks every object found as alive.
All of the heap memory that is not occupied by marked objects is reclaimed. It is simply marked as free, essentially swept free of unused objects.</code></pre><p>So if any object is not reachable from the GC roots(even if it is self-referenced or cyclic-referenced) it will be subjected to garbage collection.<br>Ofcourse sometimes this may led to memory leak if programmer forgets to dereference an object.</p>
<hr>
<p>The actual answer to this is implementation dependent. The Sun JVM keeps track of some set of root objects (threads and the like), and when it needs to do a garbage collection, traces out which objects are reachable from those and saves them, discarding the rest. It’s actually more complicated than that to allow for some optimizations, but that is the basic principle. This version does not care about circular references: as long as no live object holds a reference to a dead one, it can be GCed.</p>
<p>Other JVMs can use a method known as reference counting. When a reference is created to the object, some counter is incremented, and when the reference goes out of scope, the counter is decremented. If the counter reaches zero, the object is finalized and garbage collected. This version, however, does allow for the possibility of circular references that would never be garbage collected. As a safeguard, many such JVMs include a backup method to determine which objects actually are dead which it runs periodically to resolve self-references and defrag the heap.</p>
<hr>
<p>A garbage collector starts from some “root” set of places that are always considered “reachable”, such as the <strong>CPU registers, stack, and global variables</strong>. It works by finding any pointers in those areas, and <strong>recursively finding everything they point at</strong>. Once it’s found all that, everything else is garbage.</p>
<p>There are, of course, quite a few variations, mostly for the sake of speed. For example, most modern garbage collectors are “generational”, meaning that they divide objects into generations, and as an object gets older, the garbage collector goes longer and longer between times that it tries to figure out whether that object is still valid or not – it just starts to assume that if it has lived a long time, chances are pretty good that it’ll continue to live even longer.</p>
<p>Nonetheless, the basic idea remains the same: it’s all based on starting from some root set of things that it takes for granted could still be used, and then chasing all the pointers to find what else could be in use.</p>
<p>Interesting aside: may people are often surprised by the degree of similarity between this part of a garbage collector and code for marshaling objects for things like remote procedure calls. In each case, you’re starting from some root set of objects, and chasing pointers to find all the other objects those refer to…</p>
<hr>
<h3 id="How-Garbage-Collection-Really-Works"><a href="#How-Garbage-Collection-Really-Works" class="headerlink" title="How Garbage Collection Really Works"></a>How Garbage Collection Really Works</h3><p>Many people think garbage collection collects and discards <strong>dead</strong> objects. In reality, Java garbage collection is <strong>doing the opposite</strong>! <strong>Live</strong> objects are <strong>tracked</strong> and everything else designated garbage. As you’ll see, this fundamental misunderstanding can lead to many performance problems.</p>
<h4 id="Garbage-Collection-Roots—The-Source-of-All-Object-Trees"><a href="#Garbage-Collection-Roots—The-Source-of-All-Object-Trees" class="headerlink" title="Garbage-Collection Roots—The Source of All Object Trees"></a>Garbage-Collection Roots—The Source of All Object Trees</h4><p>Every object tree must have one or more root objects. As long as the application can reach those roots, the whole tree is reachable. But when are those root objects considered reachable? Special objects called <strong>garbage-collection roots (GC roots; see Figure 2.2) are always reachable</strong> and so is any object that has a garbage-collection root at its own root.</p>
<p>There are <strong>four</strong> kinds of GC roots in Java:</p>
<ol>
<li><strong>Local variables</strong> are kept alive by the stack of a thread. This is not a real object virtual reference and thus is not visible. For all intents and purposes, local variables are GC roots.</li>
<li><strong>Active Java threads</strong> are always considered live objects and are therefore GC roots. This is especially important for thread local variables.</li>
<li><strong>Static variables</strong> are referenced by their classes. This fact makes them de facto GC roots. Classes themselves can be garbage-collected, which would remove all referenced static variables. This is of special importance when we use application servers, OSGi containers or class loaders in general. We will discuss the related problems in the Problem Patterns section.</li>
<li><strong>JNI References</strong> are Java objects that the native code has created as part of a JNI call. Objects thus created are treated specially because the JVM does not know if it is being referenced by the native code or not. Such objects represent a very special form of GC root, which we will examine in more detail in the Problem Patterns section below.</li>
</ol>
<p>Therefore, a simple Java application has the following GC roots:</p>
<ul>
<li>Local variables in the main method</li>
<li>The main thread</li>
<li>Static variables of the main class</li>
</ul>
<h4 id="Marking-and-Sweeping-Away-Garbage"><a href="#Marking-and-Sweeping-Away-Garbage" class="headerlink" title="Marking and Sweeping Away Garbage"></a>Marking and Sweeping Away Garbage</h4><p>To determine which objects are no longer in use, the JVM intermittently runs what is very aptly called a <strong>mark-and-sweep algorithm</strong>. As you might intuit, it’s a straightforward, two-step process:</p>
<ol>
<li>The algorithm traverses all object references, <strong>starting with the GC roots</strong>, and <strong>marks every object found as alive</strong>.</li>
<li>All of the heap memory that is <strong>not occupied by marked objects is <em>reclaimed</em></strong>. It is simply marked as free, essentially swept free of unused objects.</li>
</ol>
<hr>
<p>Garbage collectors which rely solely on <strong>reference counting</strong> are generally <strong>vulnerable to failing to collection self-referential structures</strong> such as this. These GCs rely on a count of the number of references to the object in order to calculate whether a given object is reachable.</p>
<p>Non-reference counting approaches apply a more comprehensive reachability test to determine whether an object is eligible to be collected. These systems define an object (or set of objects) which are always assumed to be reachable. Any object for which references are available from this object graph is considered ineligible for collection. Any object not directly accessible from this object is not. Thus, cycles do not end up affecting reachability, and can be collected.</p>
<hr>
<h3 id="Tracing-collector-vs-countering-collector"><a href="#Tracing-collector-vs-countering-collector" class="headerlink" title="Tracing collector vs. countering collector"></a>Tracing collector vs. countering collector</h3><p>There are two primary types of garbage collectors, although often a hybrid approach is found between these to suit particular needs. The first type, the one which might be the most intuitive, is a reference counting collector. The second one, which is most similar to what we described above, is a tracing collector.</p>
<h4 id="Reference-Counting-Collector"><a href="#Reference-Counting-Collector" class="headerlink" title="Reference Counting Collector"></a>Reference Counting Collector</h4><p>When a new memory object is allocated by the GC, it is given an integer count field. Every time a pointer is made to that object, a reference, the count is increased. So long as the count is a positive non-zero integer, the object is actively being referenced and is still alive.<br>When a reference to the object is removed, the count is decremented. When the count reaches zero, the object is dead and can be immediately reclaimed.<br>There are a number of points to remember about Reference Counting collectors:</p>
<ol>
<li><strong>Circular references will never be reclaimed</strong>, even if the entire set of objects is dead.</li>
<li><strong>Reference counting is pervasive</strong>: The entire program must be made aware of the system, and every pointer reference or dereference must be accompanied by an appropriate increment or decrement. Failing to maintain the count, even once in a large program, will create memory problems for your program.</li>
<li>Reference counting can be <strong>costly</strong>, because counts must be manipulated for every pointer operation, and the count must be tested against zero on ever decrement. These operations can, if used often enough, create a performance penalty for your program.</li>
</ol>
<p>These types of collectors are often called <strong>cooperative collectors</strong> because they require cooperation from the rest of the system to maintain the counts.</p>
<h4 id="Tracing-Collector"><a href="#Tracing-Collector" class="headerlink" title="Tracing Collector"></a>Tracing Collector</h4><p>Tracing collectors are entirely dissimilar from reference counting collectors, and have opposite strengths and weaknesses.<br>When the Tracing GC allocates a new memory chunk, the GC does not create a counter, but it does create a flag to determine when the item has been marked, and a pointer to the object that the GC keeps. The flags are not manipulated by the program itself, but are only manipulated by the GC when it performs a run.</p>
<p>During a GC run, the program execution typically halts. This can cause intermittent pauses in the program, pauses which can be quite long if there are many memory objects to trace.</p>
<p>The GC selects a set of root objects which are available to the current program scope and parent scopes. Starting from these objects, the GC identifies all pointers within the objects, called children. The object itself is marked as being alive, and then the collector moves to each child and marks it in the same way. The memory objects form a sort of tree structure, and the GC traverses this tree using recursive or stack-based methods.</p>
<p>At the end of the GC run, when there are no more children to be marked, all unmarked objects are considered unreachable and therefore dead. All dead objects are collected.</p>
<p>A few points to remember about Tracing GCs:</p>
<ol>
<li>Tracing GCs can be used <strong>to find cycles</strong>, memory objects whose pointers form circular structures. Reference Counting schemes cannot do this.</li>
<li>Tracing GCs <strong>cause pauses</strong> in the program, and these pauses can become unbearably long in some complex programs that use many small memory objects.</li>
<li><strong>Dead objects are not reclaimed immediately</strong>. Reclamation only occurs after a GC run. This causes a certain inefficiency in memory usage.</li>
<li>Tracing collectors do not require the program to account explicitly for memory counts or memory status updates. All memory tracking logic is stored inside the GC itself. This makes it easier to write extensions for these systems, and also makes it easier to install a Tracing GC in an existing system then to install a Reference Counting one.</li>
</ol>
<p>Tracing GCs are often called <strong>uncooperative</strong> collectors because they do not require cooperation from the rest of the system to function properly.<br>Hybrid Collectors</p>
<p>Sometimes, reference counting schemes will utilize Tracing systems to find cyclical garbage. Tracing systems may employ reference counts on very large objects to ensure they are reclaimed quickly. These are just two examples of hybridized garbage collectors that are more common then either of the two “pure” types described above.</p>
<p>In later chapters, we will discuss garbage collectors and their algorithms in more detail.</p>
<h1 id="Java-runtime-data-area"><a href="#Java-runtime-data-area" class="headerlink" title="Java runtime data area"></a>Java runtime data area</h1><p>There are 5 areas</p>
<ol>
<li>Heap</li>
<li>Java Stack</li>
<li>Method Area</li>
<li>Native method area</li>
<li>PC/Register</li>
</ol>
<h1 id="Java-GC-1"><a href="#Java-GC-1" class="headerlink" title="Java GC"></a>Java GC</h1><p>Java’s GC considers objects “garbage” <strong>if they aren’t reachable through a chain starting at a garbage collection root</strong>, so these objects will be collected. Even though objects may point to each other to form a cycle, they’re <strong>still garbage if they’re cut off from the root</strong>.</p>
<p>See the section on unreachable objects in Appendix A: The Truth About Garbage Collection in Java Platform Performance: Strategies and Tactics (free ebook, also available on Safari) for the gory details.</p>
<h3 id="Java-Garbage-collector-handles-circular-reference-1"><a href="#Java-Garbage-collector-handles-circular-reference-1" class="headerlink" title="Java Garbage collector handles circular-reference!"></a>Java Garbage collector handles circular-reference!</h3><p>How?</p>
<p>There are special objects called called <strong>garbage-collection roots (GC roots)</strong>. These are always reachable and so is any object that has them at its own root.</p>
<p>A simple Java application has the following GC roots:</p>
<pre><code>Local variables in the main method
The main thread
Static variables of the main class</code></pre><p>To determine which objects are no longer in use, the JVM intermittently runs what is very aptly called a <strong>mark-and-sweep algorithm</strong>. It works as follows</p>
<pre><code>The algorithm traverses all object references, starting with the GC roots, and marks every object found as alive.
All of the heap memory that is not occupied by marked objects is reclaimed. It is simply marked as free, essentially swept free of unused objects.</code></pre><p>So if any object is not reachable from the GC roots(even if it is self-referenced or cyclic-referenced) it will be subjected to garbage collection.<br>Ofcourse sometimes this may led to memory leak if programmer forgets to dereference an object.</p>
<hr>
<p>The actual answer to this is implementation dependent. The Sun JVM keeps track of some set of root objects (threads and the like), and when it needs to do a garbage collection, traces out which objects are reachable from those and saves them, discarding the rest. It’s actually more complicated than that to allow for some optimizations, but that is the basic principle. This version does not care about circular references: as long as no live object holds a reference to a dead one, it can be GCed.</p>
<p>Other JVMs can use a method known as reference counting. When a reference is created to the object, some counter is incremented, and when the reference goes out of scope, the counter is decremented. If the counter reaches zero, the object is finalized and garbage collected. This version, however, does allow for the possibility of circular references that would never be garbage collected. As a safeguard, many such JVMs include a backup method to determine which objects actually are dead which it runs periodically to resolve self-references and defrag the heap.</p>
<hr>
<p>A garbage collector starts from some “root” set of places that are always considered “reachable”, such as the <strong>CPU registers, stack, and global variables</strong>. It works by finding any pointers in those areas, and <strong>recursively finding everything they point at</strong>. Once it’s found all that, everything else is garbage.</p>
<p>There are, of course, quite a few variations, mostly for the sake of speed. For example, most modern garbage collectors are “generational”, meaning that they divide objects into generations, and as an object gets older, the garbage collector goes longer and longer between times that it tries to figure out whether that object is still valid or not – it just starts to assume that if it has lived a long time, chances are pretty good that it’ll continue to live even longer.</p>
<p>Nonetheless, the basic idea remains the same: it’s all based on starting from some root set of things that it takes for granted could still be used, and then chasing all the pointers to find what else could be in use.</p>
<p>Interesting aside: may people are often surprised by the degree of similarity between this part of a garbage collector and code for marshaling objects for things like remote procedure calls. In each case, you’re starting from some root set of objects, and chasing pointers to find all the other objects those refer to…</p>
<hr>
<h3 id="How-Garbage-Collection-Really-Works-1"><a href="#How-Garbage-Collection-Really-Works-1" class="headerlink" title="How Garbage Collection Really Works"></a>How Garbage Collection Really Works</h3><p>Many people think garbage collection collects and discards <strong>dead</strong> objects. In reality, Java garbage collection is <strong>doing the opposite</strong>! <strong>Live</strong> objects are <strong>tracked</strong> and everything else designated garbage. As you’ll see, this fundamental misunderstanding can lead to many performance problems.</p>
<h4 id="Garbage-Collection-Roots—The-Source-of-All-Object-Trees-1"><a href="#Garbage-Collection-Roots—The-Source-of-All-Object-Trees-1" class="headerlink" title="Garbage-Collection Roots—The Source of All Object Trees"></a>Garbage-Collection Roots—The Source of All Object Trees</h4><p>Every object tree must have one or more root objects. As long as the application can reach those roots, the whole tree is reachable. But when are those root objects considered reachable? Special objects called <strong>garbage-collection roots (GC roots; see Figure 2.2) are always reachable</strong> and so is any object that has a garbage-collection root at its own root.</p>
<p>There are <strong>four</strong> kinds of GC roots in Java:</p>
<ol>
<li><strong>Local variables</strong> are kept alive by the stack of a thread. This is not a real object virtual reference and thus is not visible. For all intents and purposes, local variables are GC roots.</li>
<li><strong>Active Java threads</strong> are always considered live objects and are therefore GC roots. This is especially important for thread local variables.</li>
<li><strong>Static variables</strong> are referenced by their classes. This fact makes them de facto GC roots. Classes themselves can be garbage-collected, which would remove all referenced static variables. This is of special importance when we use application servers, OSGi containers or class loaders in general. We will discuss the related problems in the Problem Patterns section.</li>
<li><strong>JNI References</strong> are Java objects that the native code has created as part of a JNI call. Objects thus created are treated specially because the JVM does not know if it is being referenced by the native code or not. Such objects represent a very special form of GC root, which we will examine in more detail in the Problem Patterns section below.</li>
</ol>
<p>Therefore, a simple Java application has the following GC roots:</p>
<ul>
<li>Local variables in the main method</li>
<li>The main thread</li>
<li>Static variables of the main class</li>
</ul>
<h4 id="Marking-and-Sweeping-Away-Garbage-1"><a href="#Marking-and-Sweeping-Away-Garbage-1" class="headerlink" title="Marking and Sweeping Away Garbage"></a>Marking and Sweeping Away Garbage</h4><p>To determine which objects are no longer in use, the JVM intermittently runs what is very aptly called a <strong>mark-and-sweep algorithm</strong>. As you might intuit, it’s a straightforward, two-step process:</p>
<ol>
<li>The algorithm traverses all object references, <strong>starting with the GC roots</strong>, and <strong>marks every object found as alive</strong>.</li>
<li>All of the heap memory that is <strong>not occupied by marked objects is <em>reclaimed</em></strong>. It is simply marked as free, essentially swept free of unused objects.</li>
</ol>
<hr>
<p>Garbage collectors which rely solely on <strong>reference counting</strong> are generally <strong>vulnerable to failing to collection self-referential structures</strong> such as this. These GCs rely on a count of the number of references to the object in order to calculate whether a given object is reachable.</p>
<p>Non-reference counting approaches apply a more comprehensive reachability test to determine whether an object is eligible to be collected. These systems define an object (or set of objects) which are always assumed to be reachable. Any object for which references are available from this object graph is considered ineligible for collection. Any object not directly accessible from this object is not. Thus, cycles do not end up affecting reachability, and can be collected.</p>
<hr>
<h3 id="Tracing-collector-vs-countering-collector-1"><a href="#Tracing-collector-vs-countering-collector-1" class="headerlink" title="Tracing collector vs. countering collector"></a>Tracing collector vs. countering collector</h3><p>There are two primary types of garbage collectors, although often a hybrid approach is found between these to suit particular needs. The first type, the one which might be the most intuitive, is a reference counting collector. The second one, which is most similar to what we described above, is a tracing collector.</p>
<h4 id="Reference-Counting-Collector-1"><a href="#Reference-Counting-Collector-1" class="headerlink" title="Reference Counting Collector"></a>Reference Counting Collector</h4><p>When a new memory object is allocated by the GC, it is given an integer count field. Every time a pointer is made to that object, a reference, the count is increased. So long as the count is a positive non-zero integer, the object is actively being referenced and is still alive.<br>When a reference to the object is removed, the count is decremented. When the count reaches zero, the object is dead and can be immediately reclaimed.<br>There are a number of points to remember about Reference Counting collectors:</p>
<ol>
<li><strong>Circular references will never be reclaimed</strong>, even if the entire set of objects is dead.</li>
<li><strong>Reference counting is pervasive</strong>: The entire program must be made aware of the system, and every pointer reference or dereference must be accompanied by an appropriate increment or decrement. Failing to maintain the count, even once in a large program, will create memory problems for your program.</li>
<li>Reference counting can be <strong>costly</strong>, because counts must be manipulated for every pointer operation, and the count must be tested against zero on ever decrement. These operations can, if used often enough, create a performance penalty for your program.</li>
</ol>
<p>These types of collectors are often called <strong>cooperative collectors</strong> because they require cooperation from the rest of the system to maintain the counts.</p>
<h4 id="Tracing-Collector-1"><a href="#Tracing-Collector-1" class="headerlink" title="Tracing Collector"></a>Tracing Collector</h4><p>Tracing collectors are entirely dissimilar from reference counting collectors, and have opposite strengths and weaknesses.<br>When the Tracing GC allocates a new memory chunk, the GC does not create a counter, but it does create a flag to determine when the item has been marked, and a pointer to the object that the GC keeps. The flags are not manipulated by the program itself, but are only manipulated by the GC when it performs a run.</p>
<p>During a GC run, the program execution typically halts. This can cause intermittent pauses in the program, pauses which can be quite long if there are many memory objects to trace.</p>
<p>The GC selects a set of root objects which are available to the current program scope and parent scopes. Starting from these objects, the GC identifies all pointers within the objects, called children. The object itself is marked as being alive, and then the collector moves to each child and marks it in the same way. The memory objects form a sort of tree structure, and the GC traverses this tree using recursive or stack-based methods.</p>
<p>At the end of the GC run, when there are no more children to be marked, all unmarked objects are considered unreachable and therefore dead. All dead objects are collected.</p>
<p>A few points to remember about Tracing GCs:</p>
<ol>
<li>Tracing GCs can be used <strong>to find cycles</strong>, memory objects whose pointers form circular structures. Reference Counting schemes cannot do this.</li>
<li>Tracing GCs <strong>cause pauses</strong> in the program, and these pauses can become unbearably long in some complex programs that use many small memory objects.</li>
<li><strong>Dead objects are not reclaimed immediately</strong>. Reclamation only occurs after a GC run. This causes a certain inefficiency in memory usage.</li>
<li>Tracing collectors do not require the program to account explicitly for memory counts or memory status updates. All memory tracking logic is stored inside the GC itself. This makes it easier to write extensions for these systems, and also makes it easier to install a Tracing GC in an existing system then to install a Reference Counting one.</li>
</ol>
<p>Tracing GCs are often called <strong>uncooperative</strong> collectors because they do not require cooperation from the rest of the system to function properly.<br>Hybrid Collectors</p>
<p>Sometimes, reference counting schemes will utilize Tracing systems to find cyclical garbage. Tracing systems may employ reference counts on very large objects to ensure they are reclaimed quickly. These are just two examples of hybridized garbage collectors that are more common then either of the two “pure” types described above.</p>
<p>In later chapters, we will discuss garbage collectors and their algorithms in more detail.</p>
<h1 id="to-be-callibrated"><a href="#to-be-callibrated" class="headerlink" title="to be callibrated"></a>to be callibrated</h1><p>G1 is a concurrent collector that operates on discrete regions within the heap. Each region (there are by default around 2,048 of them) can belong to either the old or new generation, and the generational regions need not be contiguous. The idea behind having regions in the old generation is that when the concurrent background threads look for unreferenced objects, some regions will contain more garbage than other regions. The actual collection of a region still requires that application threads be stopped, but G1 can focus on the regions that are mostly garbage and only spend a little bit of time emptying those regions. This approach—clearing out only the mostly garbage regions—is what gives G1 its name: Garbage First.<br>That doesn’t apply to the regions in the young generation: during a young GC, the entire young generation is either freed or promoted (to a survivor space or to the old generation). Still, the young generation is defined in terms of regions, in part because it makes resizing the generations much easier if the regions are predefined.<br>G1 has four main operations:<br>A young collection<br>A background, concurrent cycle<br>A mixed collection<br>If necessary, a full GC<br>We’ll look at each of those in turn, starting with the G1 young collection shown in Figure 6-6.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://www.ibm.com/developerworks/java/library/j-jtp10283/" target="_blank" rel="noopener">http://www.ibm.com/developerworks/java/library/j-jtp10283/</a></li>
<li><a href="https://blogs.oracle.com/jonthecollector/entry/our_collectors" target="_blank" rel="noopener">https://blogs.oracle.com/jonthecollector/entry/our_collectors</a></li>
<li><a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29#Tracing_garbage_collectors" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29#Tracing_garbage_collectors</a></li>
<li><a href="http://users.cecs.anu.edu.au/~steveb/pubs/papers/urc-oopsla-2003.pdf" target="_blank" rel="noopener">http://users.cecs.anu.edu.au/~steveb/pubs/papers/urc-oopsla-2003.pdf</a></li>
<li><a href="https://www.dynatrace.com/resources/ebooks/javabook/" target="_blank" rel="noopener">https://www.dynatrace.com/resources/ebooks/javabook/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Tracing_garbage_collection</a></li>
<li><a href="https://en.wikibooks.org/wiki/Memory_Management/Garbage_Collection" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/Memory_Management/Garbage_Collection</a></li>
<li><a href="http://flyingfrogblog.blogspot.com/2013/09/how-do-reference-counting-and-tracing.html" target="_blank" rel="noopener">http://flyingfrogblog.blogspot.com/2013/09/how-do-reference-counting-and-tracing.html</a></li>
<li><a href="https://www.dynatrace.com/resources/ebooks/javabook/how-garbage-collection-works/" target="_blank" rel="noopener">https://www.dynatrace.com/resources/ebooks/javabook/how-garbage-collection-works/</a></li>
<li><a href="http://stackoverflow.com/questions/1910194/how-does-java-garbage-collection-work-with-circular-references" target="_blank" rel="noopener">http://stackoverflow.com/questions/1910194/how-does-java-garbage-collection-work-with-circular-references</a></li>
<li><a href="http://www.java-books.us/j2ee_0003.php" target="_blank" rel="noopener">http://www.java-books.us/j2ee_0003.php</a></li>
<li><a href="http://www.ibm.com/developerworks/java/library/j-jtp10283/" target="_blank" rel="noopener">http://www.ibm.com/developerworks/java/library/j-jtp10283/</a></li>
<li><a href="https://blogs.oracle.com/jonthecollector/entry/our_collectors" target="_blank" rel="noopener">https://blogs.oracle.com/jonthecollector/entry/our_collectors</a></li>
<li><a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29#Tracing_garbage_collectors" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29#Tracing_garbage_collectors</a></li>
<li><a href="http://users.cecs.anu.edu.au/~steveb/pubs/papers/urc-oopsla-2003.pdf" target="_blank" rel="noopener">http://users.cecs.anu.edu.au/~steveb/pubs/papers/urc-oopsla-2003.pdf</a></li>
<li><a href="https://www.dynatrace.com/resources/ebooks/javabook/" target="_blank" rel="noopener">https://www.dynatrace.com/resources/ebooks/javabook/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Tracing_garbage_collection</a></li>
<li><a href="https://en.wikibooks.org/wiki/Memory_Management/Garbage_Collection" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/Memory_Management/Garbage_Collection</a></li>
<li><a href="http://flyingfrogblog.blogspot.com/2013/09/how-do-reference-counting-and-tracing.html" target="_blank" rel="noopener">http://flyingfrogblog.blogspot.com/2013/09/how-do-reference-counting-and-tracing.html</a></li>
<li><a href="https://www.dynatrace.com/resources/ebooks/javabook/how-garbage-collection-works/" target="_blank" rel="noopener">https://www.dynatrace.com/resources/ebooks/javabook/how-garbage-collection-works/</a></li>
<li><a href="http://stackoverflow.com/questions/1910194/how-does-java-garbage-collection-work-with-circular-references" target="_blank" rel="noopener">http://stackoverflow.com/questions/1910194/how-does-java-garbage-collection-work-with-circular-references</a></li>
<li><a href="http://www.java-books.us/j2ee_0003.php" target="_blank" rel="noopener">http://www.java-books.us/j2ee_0003.php</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Todd Zhang</p>
  <div class="site-description motion-element" itemprop="description">Contact me via phray.zhang@gmail.com or wechat at helloworld_2000</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">148</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">127</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>



        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Todd Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>


  <script src="/js/schemes/muse.js?v=7.3.0"></script>


<script src="/js/next-boot.js?v=7.3.0"></script>




  




























  

  

  


  
</body>
</html>
