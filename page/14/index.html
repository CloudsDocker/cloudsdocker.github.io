<!DOCTYPE html>





<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.8.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    save_scroll: false,
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta name="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
<meta property="og:type" content="website">
<meta property="og:title" content="Clouds &amp; Docker">
<meta property="og:url" content="http://www.todzhang.com/page/14/index.html">
<meta property="og:site_name" content="Clouds &amp; Docker">
<meta property="og:description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Clouds &amp; Docker">
<meta name="twitter:description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
  <link rel="canonical" href="http://www.todzhang.com/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Clouds & Docker</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Clouds & Docker</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    

  <a href="https://github.com/CloudsDocker" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content page-home">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-07-23-akka-scala/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-07-23-akka-scala/" class="post-title-link" itemprop="url">akka framework of scala</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="philosophy"><a href="#philosophy" class="headerlink" title="philosophy"></a>philosophy</h1><p>The actor model adopts the philosophy that everything is an actor. This is similar to the everything is an object philosophy used by some object-oriented programming languages.</p>
<p>Decoupling the sender from communications sent was a fundamental advance of the Actor model enabling asynchronous communication and control structures as patterns of passing messages.</p>
<p>Recipients of messages are identified by address, sometimes called “mailing address”. Thus an actor can only communicate with actors whose addresses it has.</p>
<h1 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h1><p>Routes effectively are simply highly specialised functions that take a RequestContext and eventually complete it, which could (and often should) happen asynchronously.</p>
<p>Directives create Routes.</p>
<p>The Route is the central concept of Akka HTTP’s Routing DSL. All the structures you build with the DSL, no matter whether they consists of a single line or span several hundred lines, are type turning a RequestContext into a Future[RouteResult].</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Route</span> </span>= <span class="type">RequestContext</span> =&gt; <span class="type">Future</span>[<span class="type">RouteResult</span>]</span><br></pre></td></tr></table></figure>

<p>Generally when a route receives a request (or rather a RequestContext for it) it can do one of these things:</p>
<ul>
<li>Complete the request by returning the value of requestContext.complete(…)</li>
<li>Reject the request by returning the value of requestContext.reject(…) (see Rejections)</li>
<li>Fail the request by returning the value of requestContext.fail(…) or by just throwing an exception (see Exception Handling)</li>
<li>Do any kind of asynchronous processing and instantly return a Future[RouteResult] to be eventually completed later</li>
</ul>
<h2 id="The-Routing-Tree"><a href="#The-Routing-Tree" class="headerlink" title="The Routing Tree"></a>The Routing Tree</h2><p>Essentially, when you combine directives and custom routes via nesting and the ~ operator, you build a routing structure that forms a tree. When a request comes in it is injected into this tree at the root and flows down through all the branches in a depth-first manner until either some node completes it or it is fully rejected.</p>
<p>In RouteDirective.scala</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Completes the request using the given arguments.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @group route</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">complete</span></span>(m: ? <span class="type">ToResponseMarshallable</span>): <span class="type">StandardRoute</span> =</span><br><span class="line">    <span class="type">StandardRoute</span>(_.complete(m))</span><br></pre></td></tr></table></figure>

<h2 id="RouteResult"><a href="#RouteResult" class="headerlink" title="RouteResult"></a>RouteResult</h2><p>RouteResult is a simple abstract data type (ADT) that models the possible non-error results of a Route. It is defined as such:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sealed</span> <span class="class"><span class="keyword">trait</span> <span class="title">RouteResult</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">object</span> <span class="title">RouteResult</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Complete</span>(<span class="params">response: <span class="type">HttpResponse</span></span>) <span class="keyword">extends</span> <span class="title">RouteResult</span></span></span><br><span class="line"><span class="class">  <span class="title">final</span> <span class="title">case</span> <span class="title">class</span> <span class="title">Rejected</span>(<span class="params">rejections: immutable.<span class="type">Seq</span>[<span class="type">Rejection</span>]</span>) <span class="keyword">extends</span> <span class="title">RouteResult</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Routing-DSL"><a href="#Routing-DSL" class="headerlink" title="Routing DSL"></a>Routing DSL</h2><p>In addition to the Core Server API Akka HTTP provides a very flexible ,Routing DSL, for elegantly defining RESTful web services.</p>
<p>Http().bindAndHandle(routes ~ abcRoute, host, port)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a Route that chains two Routes. If the first Route rejects the request the second route is given a</span></span><br><span class="line"><span class="comment">     * chance to act upon the request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">~</span></span>(other: <span class="type">Route</span>): <span class="type">Route</span> = &#123; ctx ?</span><br><span class="line">      <span class="keyword">import</span> ctx.executionContext</span><br><span class="line">      route(ctx).fast.flatMap &#123;</span><br><span class="line">        <span class="keyword">case</span> x: <span class="type">RouteResult</span>.<span class="type">Complete</span> ? <span class="type">FastFuture</span>.successful(x)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">RouteResult</span>.<span class="type">Rejected</span>(outerRejections) ?</span><br><span class="line">          other(ctx).fast.map &#123;</span><br><span class="line">            <span class="keyword">case</span> x: <span class="type">RouteResult</span>.<span class="type">Complete</span>               ? x</span><br><span class="line">            <span class="keyword">case</span> <span class="type">RouteResult</span>.<span class="type">Rejected</span>(innerRejections) ? <span class="type">RouteResult</span>.<span class="type">Rejected</span>(outerRejections ++ innerRejections)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Path-matching"><a href="#Path-matching" class="headerlink" title="Path matching"></a>Path matching</h3><blockquote>
<p>Note<br>The path matching DSL describes what paths to accept after URL decoding. This is why the path-separating slashes have special status and cannot simply be specified as part of a string! The string ¡°foo/bar¡± would match the raw URI path ¡°foo%2Fbar¡±, which is most likely not what you want!</p>
</blockquote>
<h1 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h1><p>A Sink is a set of stream processing steps that has one open input. Can be used as a Subscriber</p>
<h1 id="supervision"><a href="#supervision" class="headerlink" title="supervision"></a>supervision</h1><h2 id="What-Supervision-Means"><a href="#What-Supervision-Means" class="headerlink" title="What Supervision Means"></a>What Supervision Means</h2><p>As described in Actor Systems supervision describes a dependency relationship between actors: the supervisor delegates tasks to subordinates and therefore must respond to their failures. When a subordinate detects a failure (i.e. throws an exception), it suspends itself and all its subordinates and sends a message to its supervisor, signaling failure. Depending on the nature of the work to be supervised and the nature of the failure, the supervisor has a choice of the following four options:</p>
<ul>
<li>Resume the subordinate, keeping its accumulated internal state</li>
<li>Restart the subordinate, clearing out its accumulated internal state</li>
<li>Stop the subordinate permanently</li>
<li>Escalate the failure, thereby failing itself</li>
</ul>
<h2 id="sealed-class"><a href="#sealed-class" class="headerlink" title="sealed class"></a>sealed class</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">object Supervision &#123;</span><br><span class="line">  sealed trait Directive</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A sealed class may not be directly inherited, except if the inheriting template is defined in the same source file as the inherited class. However, subclasses of a sealed class can inherited anywhere.</p>
<h2 id="implicit"><a href="#implicit" class="headerlink" title="implicit"></a>implicit</h2><p>A method can have an implicit parameter list, marked by the implicit keyword at the start of the parameter list. If the parameters in that parameter list are not passed as usual, Scala will look if it can get an implicit value of the correct type, and if it can, pass it automatically.</p>
<p>The places Scala will look for these parameters fall into two categories:</p>
<p>Scala will first look for implicit definitions and implicit parameters that can be accessed directly (without a prefix) at the point the method with the implicit parameter block is called.<br>Then it looks for members marked implicit in all the companion objects associated with the implicit candidate type.</p>
<h2 id="KillSwitch"><a href="#KillSwitch" class="headerlink" title="KillSwitch"></a>KillSwitch</h2><p>A KillSwitch allows completion of Graphs from the outside by completing Graphs of FlowShape linked to the switch. Depending on whether the KillSwitch is a UniqueKillSwitch or a SharedKillSwitch one or multiple streams might be linked with the switch.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">KillSwitch</span> </span>&#123;</span><br><span class="line"><span class="comment">//After calling KillSwitch.shutdown() the linked Graphs of FlowShape are completed normally.</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">shutdown</span></span>(): <span class="type">Unit</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">abort</span></span>(ex:<span class="type">Throwable</span>): <span class="type">Unit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p>A Source is a set of stream processing steps that has one open output. It can comprise any number of internal sources and transformations that are wired together, or it can be an atomic source, e.g. from a collection or a file. Materialization turns a Source into a Reactive Streams Publisher (at least conceptually).</p>
<h3 id="connect-to-Sink"><a href="#connect-to-Sink" class="headerlink" title="connect to Sink"></a>connect to Sink</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Connect this [[akka.stream.scaladsl.Source]] to a [[akka.stream.scaladsl.Sink]],</span></span><br><span class="line"><span class="comment">   * concatenating the processing steps of both.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to</span></span>[<span class="type">Mat2</span>](sink: <span class="type">Graph</span>[<span class="type">SinkShape</span>[<span class="type">Out</span>], <span class="type">Mat2</span>]): <span class="type">RunnableGraph</span>[<span class="type">Mat</span>] = toMat(sink)(<span class="type">Keep</span>.left)</span><br></pre></td></tr></table></figure>

<h1 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h1><p>trait Future[+T]<br> extends Awaitable[T]<br>A Future represents a value which may or may not <em>currently</em> be available, but will be available at some point, or an exception if that value could not be made available. Asynchronous computations that yield futures are created with the Future.apply call and are computed using a supplied ExecutionContext, which can be backed by a Thread pool.</p>
<p>   import ExecutionContext.Implicits.global<br>   val s = “Hello”<br>   val f: Future[String] = Future {<br>     s + “ future!”<br>   }<br>   f foreach {<br>     msg =&gt; println(msg)<br>   }</p>
<h2 id="Future-introduction"><a href="#Future-introduction" class="headerlink" title="Future introduction"></a>Future introduction</h2><p>Futures provide a way to reason about performing many operations in parallel¨C in an efficient and non-blocking way. A Future is a placeholder object for a value that may not yet exist. Generally, the value of the Future is supplied concurrently and can subsequently be used. Composing concurrent tasks in this way tends to result in faster, asynchronous, non-blocking parallel code.</p>
<p>By default, futures and promises are non-blocking, making use of callbacks instead of typical blocking operations. To simplify the use of callbacks both syntactically and conceptually, Scala provides combinators such as flatMap, foreach, and filter used to compose futures in a non-blocking way. Blocking is still possible - for cases where it is absolutely necessary, futures can be blocked on (although this is discouraged).</p>
<h1 id="Scala-scope-protection"><a href="#Scala-scope-protection" class="headerlink" title="Scala scope protection:"></a>Scala scope protection:</h1><p>private[C] means that access is private “up to” C, where C is the corresponding package, class or singleton object.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[http] <span class="function"><span class="keyword">def</span> <span class="title">build</span> </span>= &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The modi?er can be quali?ed with an identi?er C (e.g. private[C]) that must denote a class or package enclosing the de?nition. Members labeled with such a modi?er are accessible respectively only from code inside the package C or only from code inside the class C and its companion module (¡ì5.4). Such members are also inherited only from templates inside C.</p>
<h1 id="Scala-flexible-import"><a href="#Scala-flexible-import" class="headerlink" title="Scala flexible import"></a>Scala flexible import</h1><p>you can import several classes the Scala way:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.&#123;<span class="type">File</span>, <span class="type">IOException</span>, <span class="type">FileNotFoundException</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Use the following syntax to import everything from the java.io package:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io._</span><br></pre></td></tr></table></figure>

<p>The _ character in this example is similar to the * wildcard character in Java.</p>
<p>If the _ character feels unusual at first, it helps to know that it¡¯s used consistently throughout the Scala language as a wildcard character, and that consistency is very nice.</p>
<h2 id="Directives"><a href="#Directives" class="headerlink" title="Directives"></a>Directives</h2><p>A ¡°Directive¡± is a small building block used for creating arbitrarily complex route structures. Akka HTTP already pre-defines a large number of directives and you can easily construct your own:</p>
<h1 id="Regular-Expression"><a href="#Regular-Expression" class="headerlink" title="Regular Expression"></a>Regular Expression</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> pattern = <span class="string">"Scala"</span>.r</span><br><span class="line">      <span class="keyword">val</span> str = <span class="string">"Scala is Scalable and cool"</span></span><br><span class="line">      </span><br><span class="line">      println(pattern findFirstIn str)</span><br></pre></td></tr></table></figure>

<p>We create a String and call the r( ) method on it. Scala implicitly converts the String to a RichString and invokes that method to get an instance of Regex. To find a first match of the regular expression, simply call the findFirstIn() method. If instead of finding only the first occurrence we would like to find all occurrences of the matching word, we can use the findAllIn( ) method and in case there are multiple Scala words available in the target string, this will return a collection of all matching words.</p>
<h2 id="PathMatcher"><a href="#PathMatcher" class="headerlink" title="PathMatcher"></a>PathMatcher</h2><ul>
<li>Segment: PathMatcher1[String]<br>Matches if the unmatched path starts with a path segment (i.e. not a slash). If so the path segment is extracted as a String instance.</li>
</ul>
<h1 id="Option"><a href="#Option" class="headerlink" title="Option"></a>Option</h1><p>In short, if you have a value of type A that may be absent, Scala uses an instance of Option[A] as its container. An Intance of Option is either an instance of case class Some when it is present or case object None when it is not. Since both Some and None are children of Option, your function signature should declare that the returned value is an Option of some type, e.g. Option[A]</p>
<h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><p>It is very easy to create an Option in Scala, i.e. you can use a present/absent value directly.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> optionalInt: <span class="type">Option</span>[<span class="type">Int</span>] = <span class="type">Some</span>(<span class="number">1</span>)</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="comment">// val optionalInt: Option[Int] = None</span></span><br></pre></td></tr></table></figure>

<h3 id="To-validate-user-login"><a href="#To-validate-user-login" class="headerlink" title="To validate user login"></a>To validate user login</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span></span>(user:<span class="type">String</span>, pwd:<span class="type">String</span>): <span class="type">AuthResult</span> =</span><br><span class="line">	(user, pwd) <span class="keyword">match</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> (u, _) <span class="keyword">if</span> <span class="type">Option</span>(u).exists(_.trim.isEmpty) =&gt; <span class="type">ErrorLogin</span></span><br><span class="line">	<span class="keyword">case</span> (_, p) <span class="keyword">if</span> <span class="type">Option</span>(p).exists(_.trim.isEmpty) =&gt; <span class="type">ErrorPwd</span></span><br><span class="line">	<span class="keyword">case</span> (u, p) =&gt; doAuth(u,p)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="isDefined"><a href="#isDefined" class="headerlink" title="isDefined"></a>isDefined</h2><p>you add a checker for the None value using the isDefined method and specify logic to handle each scenario accordingly.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addTwoWithDefault</span></span>(a: <span class="type">Option</span>[<span class="type">Int</span>]): <span class="type">Int</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span>(a.isDefined) a.get + <span class="number">2</span> <span class="keyword">else</span> <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="getOrElse"><a href="#getOrElse" class="headerlink" title="getOrElse"></a>getOrElse</h2><p>In many cases, you have a fallback or default value for your absent values, e.g. zero in the above example. With Option, you can easily provide a default value via the getOrElse method.</p>
<p>def addTwoWithDefault(a: Option[Int]): Int = a.getOrElse(0) + 2</p>
<h2 id="flatten"><a href="#flatten" class="headerlink" title="flatten"></a>flatten</h2><p>Assume that we have a List of Option[Int].</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> l: <span class="type">List</span>[<span class="type">Option</span>[<span class="type">Int</span>]] = <span class="type">List</span>(<span class="type">Some</span>(<span class="number">3</span>), <span class="type">Some</span>(<span class="number">1</span>), <span class="type">None</span>, <span class="type">Some</span>(<span class="number">5</span>), <span class="type">Some</span>(<span class="number">8</span>), <span class="type">None</span>)</span><br></pre></td></tr></table></figure>

<p>A common scenario is that we need to filter out the absent values and return a List of Int. A straightfoward approach is to combine filter with .isDefined.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l.filter(_.isDefined).map(_.get) </span><br><span class="line"><span class="comment">// res1: List[Int] = List(3, 1, 5, 8)</span></span><br></pre></td></tr></table></figure>

<p>However, Scala actually provides an elegent built-in function to achieve the same goal, which is often more preferred.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l.flatten</span><br><span class="line"><span class="comment">// res1: List[Int] = List(3, 1, 5, 8)</span></span><br></pre></td></tr></table></figure>

<h1 id="underscore"><a href="#underscore" class="headerlink" title="underscore"></a>underscore</h1><p>In Scala, pattern matching is somewhat similar to java switch statement. But it is more powerful.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">matchTest</span></span>(x: <span class="type">Int</span>): <span class="type">String</span> = x <span class="keyword">match</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="number">1</span> =&gt; <span class="string">"one"</span></span><br><span class="line">   <span class="keyword">case</span> <span class="number">2</span> =&gt; <span class="string">"two"</span></span><br><span class="line">   <span class="keyword">case</span> _ =&gt; <span class="string">"anything other than one and two"</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>_ acts like a wildcard. It will match anything. Scala allows nested patterns, so we can nest the _ also.Lets see another example that uses _ in nested pattern.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="keyword">match</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">List</span>(<span class="number">1</span>,_,_) =&gt; <span class="string">" a list with three element and the first element is 1"</span></span><br><span class="line">  <span class="keyword">case</span> <span class="type">List</span>(_*)  =&gt; <span class="string">" a list with zero or more elements "</span></span><br><span class="line">  <span class="keyword">case</span> <span class="type">Map</span>[_,_] =&gt; <span class="string">" matches a map with any key type and any value type "</span></span><br><span class="line">  <span class="keyword">case</span> _ =&gt;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Anonymous-Functions"><a href="#Anonymous-Functions" class="headerlink" title="Anonymous Functions"></a>Anonymous Functions</h2><p>Scala represents anonymous functions with a elegant syntax. The _ acts as a placeholder for parameters in the anonymous function. The _ should be used only once, But we can use two or more underscores to refer different parameters.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).foreach(print(_))</span><br><span class="line"><span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).foreach( a =&gt; print(a))</span><br><span class="line"><span class="comment">// Here the _ refers to the parameter. The first one is a short form of the second one. Lets look at another example which take two parameters.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sum = <span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).reduceLeft(_+_)</span><br><span class="line"><span class="keyword">val</span> sum = <span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).reduceLeft((a, b) =&gt; a + b)</span><br></pre></td></tr></table></figure>

<h2 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h2><p>Scala is a functional language. So we can treat function as a normal variable. If you try to assign a function to a new variable, the function will be invoked and the result will be assigned to the variable. This confusion occurs due to the optional braces for method invocation. We should use _ after the function name to assign it to another variable.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).foreach(print(_))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fun</span> </span>= &#123;</span><br><span class="line">    <span class="comment">// some code</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> funLike = fun _</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).foreach(print(_))</span><br></pre></td></tr></table></figure>

<h1 id="Either-Left-Right"><a href="#Either-Left-Right" class="headerlink" title="Either, Left, Right"></a>Either, Left, Right</h1><p>Using Either, Left, and Right<br>Prior to Scala 2.10, an approach similar to Try was available with the Either, Left, and Right classes. With these classes, Either is analogous to Try, Right is similar to Success, and Left is similar to Failure.</p>
<p>The following method demonstrates how to implement the Either approach:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">divideXByY</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Either</span>[<span class="type">String</span>, <span class="type">Int</span>] = &#123;</span><br><span class="line">    <span class="keyword">if</span> (y == <span class="number">0</span>) <span class="type">Left</span>(<span class="string">"Dude, can't divide by 0"</span>)</span><br><span class="line">    <span class="keyword">else</span> <span class="type">Right</span>(x / y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As shown, your method should be declared to return an Either, and the method body should return a Right on success and a Left on failure. The Right type is the type your method returns when it runs successfully (an Int in this case), and the Left type is typically a String, because that¡¯s how the error message is returned.</p>
<p>As with Option and Try, a method returning an Either can be called in a variety of ways, including getOrElse or a match expression:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> x = divideXByY(<span class="number">1</span>, <span class="number">1</span>).right.getOrElse(<span class="number">0</span>)   <span class="comment">// returns 1</span></span><br><span class="line"><span class="keyword">val</span> x = divideXByY(<span class="number">1</span>, <span class="number">0</span>).right.getOrElse(<span class="number">0</span>)   <span class="comment">// returns 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// prints "Answer: Dude, can't divide by 0"</span></span><br><span class="line">divideXByY(<span class="number">1</span>, <span class="number">0</span>) <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Left</span>(s) =&gt; println(<span class="string">"Answer: "</span> + s)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Right</span>(i) =&gt; println(<span class="string">"Answer: "</span> + i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can also access the error message by testing the result with isLeft, and then accessing the left value, but this isn¡¯t really the Scala way:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> x = divideXByY(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">x: <span class="type">Either</span>[<span class="type">String</span>,<span class="type">Int</span>] = <span class="type">Left</span>(<span class="type">Dude</span>, can<span class="symbol">'t</span> divide by <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; x.isLeft</span><br><span class="line">res0: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">scala&gt; x.left</span><br><span class="line">res1: scala.util.<span class="type">Either</span>.<span class="type">LeftProjection</span>[<span class="type">String</span>,<span class="type">Int</span>] =</span><br><span class="line">      <span class="type">LeftProjection</span>(<span class="type">Left</span>(<span class="type">Dude</span>, can<span class="symbol">'t</span> divide by <span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<p>Although the Either classes offered a potential solution prior to Scala 2.10, I now use the Try classes in all of my code instead of Either.</p>
<h3 id="classOf"><a href="#classOf" class="headerlink" title="classOf"></a>classOf</h3><p>Retrieve the runtime representation of a class type. classOf[T] is equivalent to the class literal T.class in Java.</p>
<h2 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h2><p>// Keywords<br>&lt;-  // Used on for-comprehensions, to separate pattern from generator<br>=&gt;  // Used for function types, function literals and import renaming</p>
<h1 id="Akka-framework"><a href="#Akka-framework" class="headerlink" title="Akka framework"></a>Akka framework</h1><p>Akka is a toolkit and runtime for building highly concurrent, distributed, and fault-tolerant event-driven applications on the JVM. </p>
<p>Actors are the unit of execution in Akka. The Actor model is an abstraction that makes it easier to write correct concurrent, parallel and distributed systems.</p>
<p>This will get your feet wet, and hopefully inspire you to dive deeper into the wonderful sea of Akka!</p>
<p>The Akka team refers to their creation as a toolkit rather than a framework. Frameworks tend to be a mechanism for providing a discrete element of a stack (e.g. the ui, or the web services layer). Akka provides a set of tools to render any part of the stack, and to provide the interconnects between them. </p>
<p>He two ways (shared mutable state/message passing (Akka)) to solve the problem of selling tickets.</p>
<p>Actors do not share state, can only communicate through immutable messages and do not talk to each other directly but through actor references, similar to the addresses we talked about. This approach satisfies the three things we wanted to change. So why is this simpler than the shared mutable state approach?</p>
<ul>
<li>We don’t need to manage locks. We don’t have to think about how to protect the shared data. Inside an actor we’re safe.</li>
<li>We are more protected from deadlocks caused by out of order access by multiple threads, that cause the system to wait forever, or other problems like race conditions and thread starvation. Use of Akka precludes most of these problems, relieving us of the burden.</li>
<li>Performance tuning a shared mutable state solution is hard work and error prone and verification through tests is nearly impossible.</li>
</ul>
<h2 id="Benefits-of-using-the-Actor-Model"><a href="#Benefits-of-using-the-Actor-Model" class="headerlink" title="Benefits of using the Actor Model"></a>Benefits of using the Actor Model</h2><p>The following characteristics of Akka allow you to solve difficult concurrency and scalability challenges in an intuitive way:</p>
<ul>
<li>Event-driven model — Actors perform work in response to messages. Communication between Actors is asynchronous, allowing Actors to send messages and continue their own work without blocking to wait for a reply.</li>
<li>Strong isolation principles — Unlike regular objects in Java, an Actor does not have a public API in terms of methods that you can invoke. Instead, its public API is defined through messages that the actor handles. This prevents any sharing of state between Actors; the only way to observe another actor’s state is by sending it a message asking for it.</li>
<li>Location transparency — The system constructs Actors from a factory and returns references to the instances. Because location doesn’t matter, Actor instances can start, stop, move, and restart to scale up and down as well as recover from unexpected failures.</li>
<li>Lightweight — Each instance consumes only a few hundred bytes, which realistically allows millions of concurrent Actors to exist in a single application.</li>
</ul>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>two special channels. The first is the Dead Letter channel, which contain message that couldn’t be delivered. This is sometimes also called a dead message queue. This channel can help when debugging, why some messages aren’t processed or to monitor where there are problems.</p>
<h3 id="EventStream"><a href="#EventStream" class="headerlink" title="EventStream"></a>EventStream</h3><p>the benefit of decoupling the receivers and the sender and the dynamic nature of the publish-subscribe channel, but because the EventStream is available for all actors is also a nice solution for messages which can be send from all over the system and needs to be collected at one or more Actors. A good example is logging. Logging can be done throughout the system and needs to be collected at one point and be written to a log file. Internally the ActorLogging is using the EventStream to collect the log lines from all over the system.</p>
<h3 id="Dead-Letter-Message"><a href="#Dead-Letter-Message" class="headerlink" title="Dead Letter Message"></a>Dead Letter Message</h3><p>Akka is using the EventStream to implement the dead letter queue. This way only the actors which are interested in the failed messages are receiving them. When a message is queued in a mailbox of an actor that Terminates or is send after the Termination, the message is send to the EventStream of the ActorSystem. The message is wrapped into a DeadLetter object. This Object contains the original message, the sender of the message and the intended receiver. This way the Dead letter queue is integrated in the EventStream. To get these dead letter messages you only need to subscribe your actor to the EventStream with the DeadLetter class as the Classifier.</p>
<p>Messages send to a Terminated Actor can’t be processed anymore and the ActorRef of this actor should not be used anymore. When there are messages send to a terminated Actor, these message will be send to the DeadLetter queue.</p>
<p>Another use of the DeadLetter queue is when the processing fails. This is a Actor specific decision. An actor can decide that a received message couldn’t be processed and that it doesn’t know what to do with it. In this situation the messages can be send to the dead letter queue. </p>
<h2 id="Design-recommendations"><a href="#Design-recommendations" class="headerlink" title="Design recommendations"></a>Design recommendations</h2><p>When defining Actors and their messages, keep these recommendations in mind:</p>
<ul>
<li>Since messages are the Actor’s public API, it is a good practice to define messages with good names and rich semantic and domain specific meaning, even if they just wrap your data type. This will make it easier to use, understand and debug actor-based systems.</li>
<li>Messages should be immutable, since they are shared between different threads.</li>
<li>It is a good practice to put an actor’s associated messages as static classes in the class of the Actor. This makes it easier to understand what type of messages the actor expects and handles.</li>
<li>It is also a common pattern to use a static props method in the class of the Actor that describes how to construct the Actor.</li>
</ul>
<h3 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h3><p>The static props method creates and returns a Props instance. Props is a configuration class to specify options for the creation of actors, think of it as an immutable and thus freely shareable recipe for creating an actor that can include associated deployment information. This example simply passes the parameters that the Actor requires when being constructed. We will see the props method in action later in this tutorial.</p>
<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><p>When using the default, the library will try to find the configuration file. Since the library supports a number of different configuration formats, it looks for different files, in the following order:<br>application.properties<br>This file should contain the configuration properties in the java property file format.<br>application.json<br>This file should contain the configuration properties in the json style</p>
<p>application.conf<br>This file should contain the configuration properties in the HOCON format. This is a format based on json but easier to read..<br>It is possible to use all the different files at the same time. For the example below, in listing 7.2 we use the last file:<br>MyAppl {<br>    version = 10<br>    description = “My application”<br>    database {<br>        connect=”jdbc:mysql://localhost/mydata”<br>        user=”me”<br>        }<br>}
Nesting is done by simply grouping with {}s</p>
<h3 id="substitution"><a href="#substitution" class="headerlink" title="substitution"></a>substitution</h3><p> hostname=”localhost”<br>hostname=${?HOST_NAME}<br>MyAppl {<br>    version = 10<br>    description = “My<br>    application”<br>    database {<br>        connect=”jdbc:mysql://${hostname}/mydata”<br>user=”me” }<br>}</p>
<p>define the variable first, if system environment do exist, override it, otherwise use default<br>? means get a variable from system envrionment</p>
<h3 id="Default-fallback-properies"><a href="#Default-fallback-properies" class="headerlink" title="Default/fallback properies"></a>Default/fallback properies</h3><p>Default properties are configured in the file reference.conf and placed in the root of the jar file; the idea is that every library contains its own defaults. The configuration library will find all the reference.conf files and integrate these settings into the configuration fall-back structure. </p>
<h3 id="Order-of-properties"><a href="#Order-of-properties" class="headerlink" title="Order of properties"></a>Order of properties</h3><p>System properties-&gt;application.conf-&gt;applicaiton.json-&gt;application.properties-&gt;reference.conf</p>
<h2 id="The-power-of-location-transparency"><a href="#The-power-of-location-transparency" class="headerlink" title="The power of location transparency"></a>The power of location transparency</h2><p>In Akka you can’t create an instance of an Actor using the new keyword. Instead, you create Actor instances using a factory. The factory does not return an actor instance, but a reference, akka.actor.ActorRef, that points to the actor instance. This level of indirection adds a lot of power and flexibility in a distributed system.</p>
<p>In Akka location doesn’t matter. Location transparency means that the ActorRef can, while retaining the same semantics, represent an instance of the running actor in-process or on a remote machine. If needed, the runtime can optimize the system by changing an Actor’s location or the entire application topology while it is running. This enables the “let it crash” model of failure management in which the system can heal itself by crashing faulty Actors and restarting healthy ones.</p>
<h2 id="The-Akka-ActorSystem"><a href="#The-Akka-ActorSystem" class="headerlink" title="The Akka ActorSystem"></a>The Akka ActorSystem</h2><p>The akka.actor.ActorSystem factory is, to some extent, similar to Spring’s BeanFactory. It acts as a container for Actors and manages their life-cycles. The actorOf factory method creates Actors and takes two parameters, a configuration object called Props and a name.</p>
<h3 id="Asynchronous-communication"><a href="#Asynchronous-communication" class="headerlink" title="Asynchronous communication"></a>Asynchronous communication</h3><p>Actors are reactive and message driven. An Actor doesn’t do anything until it receives a message. Actors communicate using asynchronous messages. This ensures that the sender does not stick around waiting for their message to be processed by the recipient. Instead, the sender puts the message in the recipient’s mailbox and is free to do other work. The Actor’s mailbox is essentially a message queue with ordering semantics. The order of multiple messages sent from the same Actor is preserved, but can be interleaved with messages sent by another Actor.</p>
<p>You might be wondering what the Actor is doing when it is not processing messages, i.e. doing actual work? It is in a suspended state in which it does not consume any resources apart from memory. Again, showing the lightweight, efficient nature of Actors.</p>
<h3 id="Sending-messages-to-an-Actor"><a href="#Sending-messages-to-an-Actor" class="headerlink" title="Sending messages to an Actor"></a>Sending messages to an Actor</h3><p>To put a message into an Actor’s mailbox, use the tell method on the ActorRef. For example, the main class of Hello World sends messages to the Greeter Actor like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">howdyGreeter.tell(<span class="keyword">new</span> WhoToGreet(<span class="string">"Akka"</span>), ActorRef.noSender());</span><br><span class="line">howdyGreeter.tell(<span class="keyword">new</span> Greet(), ActorRef.noSender());</span><br></pre></td></tr></table></figure>

<p>The test class is using akka.test.javadsl.TestKit, which is a module for integration testing of actors and actor systems. This class only uses a fraction of the functionality provided by TestKit.</p>
<h2 id="Akka-under-the-hood"><a href="#Akka-under-the-hood" class="headerlink" title="Akka under the hood"></a>Akka under the hood</h2><p>So are there no concurrency primitives like locks used at all in Akka? Well, of course there are, it’s just that you don’t have to deal with them directly . Everything still eventually runs on threads and low level concurrency primitives. Akka uses the java.util.concurrent library to coordinate message processing and takes great care to minimize the number of locks used to an absolute bare minimum. It uses lock free and wait free algorithms where possible, for example compare-and-swap (CAS) techniques, which are beyond the scope of this book. And because nothing can be shared between actors, the shared locks that you would normally have between objects are not present at all. </p>
<p>There are other benefits that stem from the message passing approach that Akka uses, which we will discuss in the next sections. We have touched on them briefly already:</p>
<ol>
<li>Even in this first, simple example, the message passing approach is clearly more fault tolerant, averting catastrophic failure if one component (no matter how key) fails.</li>
<li>The shared mutable state is always in one place in the example (in one JVM if it is kept entirely in memory). If you need to scale beyond this constraint, you will have to (re)distribute the data somehow. Since the message passing style uses addresses, looking ahead, you can see that if local and remote addresses were interchangeable, scaling out would be possible without code changes of any kind.</li>
</ol>
<p>This scenario is one example of a fault tolerance strategy that Akka provides, which is called the Restart strategy. Other strategies that can be used are Resume, Stop and Escalate. </p>
<h2 id="Scale-up-and-Scale-out"><a href="#Scale-up-and-Scale-out" class="headerlink" title="Scale up and Scale out"></a>Scale up and Scale out</h2><p>In our Ticketing example, scaling up would mean getting more TicketingAgents running on our one server, scaling out would be bringing up TicketingAgents on a number of machines.</p>
<h2 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h2><p>locks result in contention, which will mean the number of threads doing work at any one time is often less than the total number, as some will have to wait on each other to finish. Sharing as little as possible means locking as little as possible, which is the goal of the message passing approach.</p>
<p>Every thread has a stack to store runtime data. The size of the stack differs per operating system, for instance on the linux x64 platform it is normally 256kB. The stack size is one of the factors that limits the number of threads that run at the same time on a server. Around 4096 threads can fit in 1GB of memory on the linux x64 platform.</p>
<h2 id="Dispatcher"><a href="#Dispatcher" class="headerlink" title="Dispatcher"></a>Dispatcher</h2><p>Actors run on an abstraction which is called a dispatcher. The dispatcher takes care of which threading model is used and processes the mailboxes.</p>
<p>Actors are lightweight because they run on top of dispatchers, the actors are not necessarily directly proportional to the number of threads. Akka Actors take a lot less space than threads, around 2.7 million actors can fit in 1GB of memory. A big difference compared to 4096 threads, which means that you can create different types of actors more freely than you would when using threads directly. There are different types of dispatchers to choose from which can be tuned to specific needs.</p>
<p>We identified that we had to make the following changes to get to a message passing style:</p>
<ol>
<li>No mutable shared data structure. </li>
<li>Immutable message passing.</li>
<li>Asynchronous message sending.</li>
</ol>
<p>Akka implements actors and which components compare to the concepts we’ve talked about so far: actors, addresses and mailboxes.</p>
<h2 id="Actor-Path"><a href="#Actor-Path" class="headerlink" title="Actor Path"></a>Actor Path</h2><p>So how do you get an actor reference to an actor in the hierarchy? This is where ActorPaths come in. You could compare the hierarchy of actors to a URL path structure. Every actor has a name. This name needs to be unique per level in the hierarchy, two sibling actors cannot have the same name (if you do not provide a name Akka generates one for you, but it is a good idea to name all your actors). All actor references can be located directly by an actor path, absolute or relative, and it has to follow the URI generic syntax. An actor path is built just like a URI, starting with a scheme followed by a scheme-specific part,</p>
<h2 id="Core-Actor-Operations"><a href="#Core-Actor-Operations" class="headerlink" title="Core Actor Operations"></a>Core Actor Operations</h2><p>Another way to look at an actor is to describe the operations that it supports. An Akka actor has four core operations :</p>
<ol>
<li>CREATE: An actor can create another actor. In Akka, actors are part of an actor system, which defines the root of the actor hierarchy and creates top-level actors. Every actor can create child actors. The topology of the actors is dynamic, it depends on which actors create other actors and which addresses are used to communicate with them.</li>
<li>SEND: An actor can send a message to another actor. Messages are sent asynchronously, using an address to send to an Actor associated with a given Mailbox.</li>
<li>BECOME: The behavior of an actor can be dynamically changed. Messages are received one at a time and an actor can designate that it wants to handle next messages in a different way, basically swapping its behavior, which we will look at in later chapters.</li>
<li>SUPERVISE: An actor supervises and monitors its children in the actor hierarchy and manages the failures that happen. As we will see in chapter 3, this provides a clean separation between message processing and error handling.</li>
</ol>
<h2 id="Akka-concurrency"><a href="#Akka-concurrency" class="headerlink" title="Akka concurrency"></a>Akka concurrency</h2><p>Message passing enables an easier road to real concurrency<br> With that concurrent approach, we will be able to scale up and out<br>We can scale both the request and the processing elements of our application<br>Messages also unlock greater fault tolerance capabilities<br>Supervision provides a means of modeling for both concurrency and fault tolerance<br>Akka infuses our code with these powers in a lightweight, unobtrusive manner</p>
<h3 id="Build-Akka"><a href="#Build-Akka" class="headerlink" title="Build Akka"></a>Build Akka</h3><p>using TypeSafe’s Simple Build Tool (SBT) to create a single jar file that can be used to run the app</p>
<p>If you have not worked with the SBT DSL before it is important to note that you need to put en empty line between lines in the file (this is the price we pay for not telling Scala where each expression ends).</p>
<h3 id="tell-vs-ask"><a href="#tell-vs-ask" class="headerlink" title="tell vs ask"></a>tell vs ask</h3><p>Messages are sent to an Actor through one of the following methods.</p>
<p>! means “fire-and-forget”, e.g. send a message asynchronously and return immediately. Also known as tell.</p>
<p>? sends a message asynchronously and returns a Future representing a possible reply. Also known as ask.</p>
<p>So below line is equivalent to tell</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReceiveActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Hello"</span> =&gt; sender ! <span class="string">"And Hello to you!"</span> <span class="comment">// same as sender.tell("And Hello to you!")</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Sample-of-actor"><a href="#Sample-of-actor" class="headerlink" title="Sample of actor"></a>Sample of actor</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.goticks</span><br><span class="line"><span class="keyword">import</span> akka.actor.&#123;<span class="type">PoisonPill</span>, <span class="type">Actor</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketSeller</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">import</span> <span class="type">TicketProtocol</span>._</span><br><span class="line">  <span class="keyword">var</span> tickets = <span class="type">Vector</span>[<span class="type">Ticket</span>]()</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">GetEvents</span> =&gt; sender ! tickets.size</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Tickets</span>(newTickets) =&gt;</span><br><span class="line">      tickets = tickets ++ newTickets</span><br><span class="line">    <span class="keyword">case</span> <span class="type">BuyTicket</span> =&gt;</span><br><span class="line">      <span class="keyword">if</span> (tickets.isEmpty) &#123;</span><br><span class="line">        sender ! <span class="type">SoldOut</span></span><br><span class="line">        self ! <span class="type">PoisonPill</span></span><br><span class="line">&#125;</span><br><span class="line">      tickets.headOption.foreach &#123; ticket =&gt;</span><br><span class="line">        tickets = tickets.tail</span><br><span class="line">        sender ! ticket</span><br><span class="line">&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="type">Event</span>(name, nrOfTickets) =&gt;</span><br><span class="line">  <span class="keyword">if</span>(context.child(name).isEmpty) &#123;</span><br><span class="line"><span class="type">If</span> <span class="type">TicketSellers</span> have not been</span><br><span class="line">   <span class="keyword">val</span> ticketSeller = context.actorOf(<span class="type">Props</span>[<span class="type">TicketSeller</span>], name)</span><br><span class="line">  <span class="keyword">val</span> tickets = <span class="type">Tickets</span>((<span class="number">1</span> to nrOfTickets).map&#123;</span><br><span class="line">    nr=&gt; <span class="type">Ticket</span>(name, nr)).toList</span><br><span class="line">&#125;</span><br><span class="line">  ticketSeller ! tickets</span><br><span class="line">&#125;</span><br><span class="line">sender ! <span class="type">EventCreated</span></span><br></pre></td></tr></table></figure>

<p>The BoxOffice creates TicketSellers for each event. Notice that it uses it’s context instead of the actor system to create the actor; Actors created with the context of another Actor are its children and subject to the parent Actor’s supervision</p>
<h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>Right now it always fails since it is not implemented yet, as is expected in Red-Green-Refactor style, where you first make sure the test fails (Red), then implement the code to make it pass (Green), after which you might refactor the code to make it nicer.</p>
<h2 id="source-code"><a href="#source-code" class="headerlink" title="source code"></a>source code</h2><h3 id="UntypedActor"><a href="#UntypedActor" class="headerlink" title="UntypedActor"></a>UntypedActor</h3><p>This class is the Java cousin to the akka.actor.Actor Scala interface. Subclass this abstract class to create a MDB-style untyped actor.</p>
<p>An actor has a well-defined (non-cyclic) life-cycle.</p>
<pre><code>RUNNING (created and started actor) - can receive messages
SHUTDOWN (when &apos;stop&apos; or &apos;exit&apos; is invoked) - can&apos;t do anything</code></pre><p>The Actor’s own akka.actor.ActorRef is available as getSelf(), the current message’s sender as getSender() and the akka.actor.UntypedActorContext as getContext(). The only abstract method is onReceive() which is invoked for each processed message unless dynamically overridden using getContext().become().</p>
<p>Annotations<br>    @Deprecated @deprecated<br>Deprecated</p>
<pre><code>(Since version 2.5.0) Use AbstractActor instead of UntypedActor.</code></pre><h3 id="loggingAdaptor"><a href="#loggingAdaptor" class="headerlink" title="loggingAdaptor"></a>loggingAdaptor</h3><p>trait LoggingAdapter extends AnyRef</p>
<p>Logging wrapper to make nicer and optimize: provide template versions which evaluate .toString only if the log level is actually enabled. Typically used by obtaining an implementation from the Logging object:</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-08-09-Chronicle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-08-09-Chronicle/" class="post-title-link" itemprop="url">Chronicle</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>Chronicle Software is about simplifying fast data.  It is a suite of libraries to make it easier to write, monitor and tune data processing systems where performance and scalability are concerned.</p>
<h1 id="Writing-to-a-Queue"><a href="#Writing-to-a-Queue" class="headerlink" title="Writing to a Queue"></a>Writing to a Queue</h1><p>In Chronicle Queue we refer to the act of writing your data to the Chronicle queue, as storing an excerpt. This data could be made up from any data type, including text, numbers, or serialised blobs. Ultimately, all your data, regardless of what it is, is stored as a series of bytes.</p>
<p>Just before storing your excerpt, Chronicle Queue reserves an 8-byte header. Chronicle Queue writes the length of your data into this header. This way, when Chronicle Queue comes to read your excerpt, it knows how long each blob of data is. We refer to this 8-byte header, along with your excerpt, as a document. So strictly speaking Chronicle Queue can be used to read and write documents.</p>
<blockquote>
<p>Within this 8-byte header we also reserve a few bits for a number of internal operations, such as locking, to make Chronicle Queue thread-safe across both processors and threads. The important thing to note is that because of this, you can’t strictly convert the 8 bytes to an integer to find the length of your data blob.</p>
</blockquote>
<p>To write data to a Chronicle-Queue, you must first create an Appender</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (ChronicleQueue queue = SingleChronicleQueueBuilder.binary(path + <span class="string">"/trades"</span>).build()) &#123;</span><br><span class="line">   <span class="keyword">final</span> ExcerptAppender appender = queue.acquireAppender();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Chronicle Queue uses the following low-level interface to write the data:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="keyword">final</span> DocumentContext dc = appender.writingDocument()) &#123;</span><br><span class="line">      dc.wire().write().text(“your text data“);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So, Chronicle Queue uses an <code>Appender to write</code> to the queue and a <code>Tailer to read</code> from the queue. Unlike other java queuing solutions, messages are not lost when they are read with a Tailer. </p>
<p>Each Chronicle Queue excerpt has a unique index.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="keyword">final</span> DocumentContext dc = appender.writingDocument()) &#123;</span><br><span class="line">    dc.wire().write().text(“your text data“);</span><br><span class="line">    System.out.println(<span class="string">"your data was store to index="</span>+ dc.index());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The high-level methods below such as writeText() are convenience methods on calling appender.writingDocument(), but both approaches essentially do the same thing. The actual code of writeText(CharSequence text) looks like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text to write a message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeText</span><span class="params">(CharSequence text)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (DocumentContext dc = writingDocument()) &#123;</span><br><span class="line">        dc.wire().bytes().append8bit(text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is the highest-level API which hides the fact you are writing to messaging at all. The benefit is that you can swap calls to the interface with a real component, or an interface to a different protocol.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// using the method writer interface.</span></span><br><span class="line">RiskMonitor riskMonitor = appender.methodWriter(RiskMonitor.class);</span><br><span class="line"><span class="keyword">final</span> LocalDateTime now = LocalDateTime.now(Clock.systemUTC());</span><br><span class="line">riskMonitor.trade(<span class="keyword">new</span> TradeDetails(now, <span class="string">"GBPUSD"</span>, <span class="number">1.3095</span>, <span class="number">10e6</span>, Side.Buy, <span class="string">"peter"</span>));</span><br></pre></td></tr></table></figure>

<p>You can write a “self-describing message”. Such messages can support schema changes. They are also easier to understand when debugging or diagnosing problems.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writing a self describing message</span></span><br><span class="line">appender.writeDocument(w -&gt; w.write(<span class="string">"trade"</span>).marshallable(</span><br><span class="line">        m -&gt; m.write(<span class="string">"timestamp"</span>).dateTime(now)</span><br><span class="line">                .write(<span class="string">"symbol"</span>).text(<span class="string">"EURUSD"</span>)</span><br><span class="line">                .write(<span class="string">"price"</span>).float64(<span class="number">1.1101</span>)</span><br><span class="line">                .write(<span class="string">"quantity"</span>).float64(<span class="number">15e6</span>)</span><br><span class="line">                .write(<span class="string">"side"</span>).object(Side.class, Side.Sell)</span><br><span class="line">                .write(<span class="string">"trader"</span>).text(<span class="string">"peter"</span>)));</span><br></pre></td></tr></table></figure>

<p>You can write “raw data” which is self-describing. The types will always be correct; position is the only indication as to the meaning of those values.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writing just data</span></span><br><span class="line">appender.writeDocument(w -&gt; w</span><br><span class="line">        .getValueOut().int32(<span class="number">0x123456</span>)</span><br><span class="line">        .getValueOut().int64(<span class="number">0x999000999000L</span>)</span><br><span class="line">        .getValueOut().text(<span class="string">"Hello World"</span>));</span><br></pre></td></tr></table></figure>

<p>You can write “raw data” which is not self-describing. Your reader must know what this data means, and the types that were used.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writing raw data</span></span><br><span class="line">appender.writeBytes(b -&gt; b</span><br><span class="line">        .writeByte((<span class="keyword">byte</span>) <span class="number">0x12</span>)</span><br><span class="line">        .writeInt(<span class="number">0x345678</span>)</span><br><span class="line">        .writeLong(<span class="number">0x999000999000L</span>)</span><br><span class="line">        .writeUtf8(<span class="string">"Hello World"</span>));</span><br></pre></td></tr></table></figure>

<p>This is the lowest level way to write data. You get an address to raw memory and you can write what you want.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Unsafe low level</span></span><br><span class="line">appender.writeBytes(b -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> address = b.address(b.writePosition());</span><br><span class="line">    Unsafe unsafe = UnsafeMemory.UNSAFE;</span><br><span class="line">    unsafe.putByte(address, (<span class="keyword">byte</span>) <span class="number">0x12</span>);</span><br><span class="line">    address += <span class="number">1</span>;</span><br><span class="line">    unsafe.putInt(address, <span class="number">0x345678</span>);</span><br><span class="line">    address += <span class="number">4</span>;</span><br><span class="line">    unsafe.putLong(address, <span class="number">0x999000999000L</span>);</span><br><span class="line">    address += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="string">"Hello World"</span>.getBytes(StandardCharsets.ISO_8859_1);</span><br><span class="line">    unsafe.copyMemory(bytes, Unsafe.ARRAY_BYTE_BASE_OFFSET, <span class="keyword">null</span>, address, bytes.length);</span><br><span class="line">    b.writeSkip(<span class="number">1</span> + <span class="number">4</span> + <span class="number">8</span> + bytes.length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>You can print the contents of the queue. You can see the first two, and last two messages store the same data.</p>
<p>// dump the content of the queue<br>System.out.println(queue.dump());</p>
<h1 id="position-262568-header-0"><a href="#position-262568-header-0" class="headerlink" title="position: 262568, header: 0"></a>position: 262568, header: 0</h1><p>— !!data #binary<br>trade: {<br>  timestamp: 2016-07-17T15:18:41.141,<br>  symbol: GBPUSD,<br>  price: 1.3095,<br>  quantity: 10000000.0,<br>  side: Buy,<br>  trader: peter<br>}</p>
<h1 id="position-262684-header-1"><a href="#position-262684-header-1" class="headerlink" title="position: 262684, header: 1"></a>position: 262684, header: 1</h1><p>— !!data #binary<br>trade: {<br>  timestamp: 2016-07-17T15:18:41.141,<br>  symbol: EURUSD,<br>  price: 1.1101,<br>  quantity: 15000000.0,<br>  side: Sell,<br>  trader: peter<br>}</p>
<h1 id="position-262800-header-2"><a href="#position-262800-header-2" class="headerlink" title="position: 262800, header: 2"></a>position: 262800, header: 2</h1><p>— !!data #binary<br>!int 1193046<br>168843764404224<br>Hello World</p>
<h1 id="position-262830-header-3"><a href="#position-262830-header-3" class="headerlink" title="position: 262830, header: 3"></a>position: 262830, header: 3</h1><p>— !!data #binary<br>000402b0       12 78 56 34 00 00  90 99 00 90 99 00 00 0B   ·xV4·· ········<br>000402c0 48 65 6C 6C 6F 20 57 6F  72 6C 64                Hello Wo rld</p>
<h1 id="position-262859-header-4"><a href="#position-262859-header-4" class="headerlink" title="position: 262859, header: 4"></a>position: 262859, header: 4</h1><p>— !!data #binary<br>000402c0                                               12                 ·<br>000402d0 78 56 34 00 00 90 99 00  90 99 00 00 0B 48 65 6C xV4····· ·····Hel<br>000402e0 6C 6F 20 57 6F 72 6C 64 </p>
<h2 id="Finding-the-index-at-the-end-of-a-Chronicle-Queue"><a href="#Finding-the-index-at-the-end-of-a-Chronicle-Queue" class="headerlink" title="Finding the index at the end of a Chronicle Queue"></a>Finding the index at the end of a Chronicle Queue</h2><p>Chronicle Queue appenders are thread-local. In fact when you ask for:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ExcerptAppender appender = queue.acquireAppender();</span><br></pre></td></tr></table></figure>

<p>the acquireAppender() uses a thread-local pool to give you an appender which will be reused to reduce object creation.</p>
<p>As such, the method call to:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> index = appender.lastIndexAppended();</span><br></pre></td></tr></table></figure>

<p>will only give you the last index appended by this appender; not the last index appended by any appender.</p>
<p>If you wish to find the index of the last record written, then you have to call:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> index = queue.createTailer().toEnd().index();</span><br></pre></td></tr></table></figure>

<h2 id="Dumping-a-Chronicle-Queue-cq4-file-as-text-to-the-Command-Line"><a href="#Dumping-a-Chronicle-Queue-cq4-file-as-text-to-the-Command-Line" class="headerlink" title="Dumping a Chronicle Queue, cq4 file as text to the Command Line"></a>Dumping a Chronicle Queue, cq4 file as text to the Command Line</h2><p>Chronicle Queue stores its data in binary format, with a file extension of cq4:</p>
<p>\��@π�header∂�SCQStoreÇE���»wireType∂�WireTypeÊBINARYÕwritePositionèèèèß��������ƒroll∂�SCQSRollÇ*���∆length¶ÄÓ6�∆format<br>ÎyyyyMMdd-HH≈epoch¶ÄÓ6�»indexing∂SCQSIndexingÇN��� indexCount•��ÃindexSpacing�Àindex2Indexé����ß��������…lastIndexé�<br>���ß��������ﬂlastAcknowledgedIndexReplicatedé������ßˇˇˇˇˇˇˇˇ»recovery∂�TimedStoreRecoveryÇ����…timeStampèèèß����������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������<br>This can often be a bit difficult to read, so it is better to dump the cq4 files as text. This can also help you fix your production issues, as it gives you the visibility as to what has been stored in the queue, and in what order.</p>
<p>You have to use the chronicle-queue.jar, from any version 4.5.3 or later, and set up the dependent files in the class path. </p>
<p>$ java -cp chronicle-queue-4.5.5.jar net.openhft.chronicle.queue.DumpQueueMain 19700101-02.cq4</p>
<p>this will dump the 19700101-02.cq4 file out as text, as shown below:</p>
<p>— !!meta-data #binary<br>header: !SCQStore {<br>  wireType: !WireType BINARY,<br>  writePosition: 0,<br>  roll: !SCQSRoll {<br>    length: !int 3600000,<br>    format: yyyyMMdd-HH,<br>    epoch: !int 3600000<br>  },<br>  indexing: !SCQSIndexing {<br>    indexCount: !short 4096,<br>    indexSpacing: 4,<br>    index2Index: 0,<br>    lastIndex: 0<br>  },<br>  lastAcknowledgedIndexReplicated: -1,<br>  recovery: !TimedStoreRecovery {<br>    timeStamp: 0<br>  }<br>}</p>
<p>…<br>4198044 bytes remaining</p>
<h2 id="Reading-from-a-Queue-using-a-Tailer"><a href="#Reading-from-a-Queue-using-a-Tailer" class="headerlink" title="Reading from a Queue using a Tailer"></a>Reading from a Queue using a Tailer</h2><p>Reading the queue follows the same pattern as writing, except there is a possibility there is not a message when you attempt to read it.</p>
<p>Start Reading</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (ChronicleQueue queue = SingleChronicleQueueBuilder.binary(path + <span class="string">"/trades"</span>).build()) &#123;</span><br><span class="line">   <span class="keyword">final</span> ExcerptTailer tailer = queue.createTailer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can turn each message into a method call based on the content of the message.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reading using method calls</span></span><br><span class="line">RiskMonitor monitor = System.out::println;</span><br><span class="line">MethodReader reader = tailer.methodReader(monitor);</span><br><span class="line"><span class="comment">// read one message</span></span><br><span class="line">assertTrue(reader.readOne());</span><br></pre></td></tr></table></figure>

<p>You can decode the message yourself.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">assertTrue(tailer.readDocument(w -&gt; w.read(<span class="string">"trade"</span>).marshallable(</span><br><span class="line">        m -&gt; &#123;</span><br><span class="line">            LocalDateTime timestamp = m.read(<span class="string">"timestamp"</span>).dateTime();</span><br><span class="line">            String symbol = m.read(<span class="string">"symbol"</span>).text();</span><br><span class="line">            <span class="keyword">double</span> price = m.read(<span class="string">"price"</span>).float64();</span><br><span class="line">            <span class="keyword">double</span> quantity = m.read(<span class="string">"quantity"</span>).float64();</span><br><span class="line">            Side side = m.read(<span class="string">"side"</span>).object(Side.class);</span><br><span class="line">            String trader = m.read(<span class="string">"trader"</span>).text();</span><br><span class="line">            <span class="comment">// do something with values.</span></span><br><span class="line">        &#125;)));</span><br></pre></td></tr></table></figure>

<p>You can read self-describing data values. This will check the types are correct, and convert as required.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">assertTrue(tailer.readDocument(w -&gt; &#123;</span><br><span class="line">    ValueIn in = w.getValueIn();</span><br><span class="line">    <span class="keyword">int</span> num = in.int32();</span><br><span class="line">    <span class="keyword">long</span> num2 = in.int64();</span><br><span class="line">    String text = in.text();</span><br><span class="line">    <span class="comment">// do something with values</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>You can read raw data as primitives and strings.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">assertTrue(tailer.readBytes(in -&gt; &#123;</span><br><span class="line">    <span class="keyword">int</span> code = in.readByte();</span><br><span class="line">    <span class="keyword">int</span> num = in.readInt();</span><br><span class="line">    <span class="keyword">long</span> num2 = in.readLong();</span><br><span class="line">    String text = in.readUtf8();</span><br><span class="line">    assertEquals(<span class="string">"Hello World"</span>, text);</span><br><span class="line">    <span class="comment">// do something with values</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>or, you can get the underlying memory address and access the native memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">assertTrue(tailer.readBytes(b -&gt; &#123;</span><br><span class="line">    <span class="keyword">long</span> address = b.address(b.readPosition());</span><br><span class="line">    Unsafe unsafe = UnsafeMemory.UNSAFE;</span><br><span class="line">    <span class="keyword">int</span> code = unsafe.getByte(address);</span><br><span class="line">    address++;</span><br><span class="line">    <span class="keyword">int</span> num = unsafe.getInt(address);</span><br><span class="line">    address += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">long</span> num2 = unsafe.getLong(address);</span><br><span class="line">    address += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> length = unsafe.getByte(address);</span><br><span class="line">    address++;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">    unsafe.copyMemory(<span class="keyword">null</span>, address, bytes, Unsafe.ARRAY_BYTE_BASE_OFFSET, bytes.length);</span><br><span class="line">    String text = <span class="keyword">new</span> String(bytes, StandardCharsets.UTF_8);</span><br><span class="line">    assertEquals(<span class="string">"Hello World"</span>, text);</span><br><span class="line">    <span class="comment">// do something with values</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h3 id="Tailers-and-File-Handlers-Clean-up"><a href="#Tailers-and-File-Handlers-Clean-up" class="headerlink" title="Tailers and File Handlers Clean up"></a>Tailers and File Handlers Clean up</h3><p>Chronicle queue tailers may create file handlers, the file handlers are cleaned up whenever the associated chronicle queue is close() or whenever the Jvm runs a Garbage Collection. </p>
<h3 id="ExcerptTailer-toEnd"><a href="#ExcerptTailer-toEnd" class="headerlink" title="ExcerptTailer.toEnd()"></a>ExcerptTailer.toEnd()</h3><p>In some applications, it may be necessary to start reading from the end of the queue (e.g. in a restart scenario). For this use-case, ExcerptTailer provides the toEnd() method.</p>
<p>If it is necessary to read backwards through the queue from the end, then the tailer can be set to read backwards:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExcerptTailer tailer = queue.createTailer();</span><br><span class="line">tailer.direction(TailerDirection.BACKWARD).toEnd();</span><br></pre></td></tr></table></figure>

<p>When reading backwards, then the toEnd() method will move the tailer to the last record in the queue. If the queue is not empty, then there will be a DocumentContext available for reading:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this will be true if there is at least one message in the queue</span></span><br><span class="line"><span class="keyword">boolean</span> messageAvailable = tailer.toEnd().direction(TailerDirection.BACKWARD).</span><br><span class="line">        readingDocument().isPresent();</span><br></pre></td></tr></table></figure>

<h1 id="Low-GC"><a href="#Low-GC" class="headerlink" title="Low GC"></a>Low GC</h1><p>Ultra low GC means less than one minor collection per day.</p>
<p>the principles of Zero-copy eliminating unnecessary garbage collection and increased speed. Runtime code generation that reduces code size for efficient CPU cache usage and increased speed. Smart ordering for optimal parsing and you guessed it increased speed. All these combine to allow Chronicle FIX to achieve excellent performance results.</p>
<h1 id="Low-garbage-rate"><a href="#Low-garbage-rate" class="headerlink" title="Low garbage rate"></a>Low garbage rate</h1><p>Minimising garbage is key to avoiding GC pauses. To use your L1 and L2 cache efficiently, you need to keep your garbage rates very low.  If you are not using these cache efficiently your application can be 2-5x slower. </p>
<p>The garbage from Chronicle is low enough that you can process one million events without jstat detecting you have created any garbage.  jstat only displays multiples of 4 KB, and only when a new TLAB is allocated.  Chronicle does create garbage, but it is extremely low. i.e. a few objects per million events processes.</p>
<p>Once you make the GC pauses manageable, or non-existent, you start to see other sources of delay in your system.   Take away the boulders and you start to see the rocks.  Take away the rocks and you start to see the pebbles.</p>
<h1 id="Chronicle-has-minimal-interaction-with-the-Operating-System"><a href="#Chronicle-has-minimal-interaction-with-the-Operating-System" class="headerlink" title="Chronicle has minimal interaction with the Operating System."></a>Chronicle has minimal interaction with the Operating System.</h1><p>System calls are slow, and if you can avoid call the OS, you can save significant amounts of latency. </p>
<p>For example, if you send a message over TCP on loopback, this can add a 10 micro-seconds latency between writing and reading the data.  You can write to a chronicle, which is a plain write to memory, and read from chronicle, which is also a read from memory with a latency of 0.2 micro-seconds. (And as I mentioned before, you get persistence as well)</p>
<h1 id="No-need-to-worry-about-running-out-of-heap"><a href="#No-need-to-worry-about-running-out-of-heap" class="headerlink" title="No need to worry about running out of heap."></a>No need to worry about running out of heap.</h1><p>A common problem with unbounded queues and this uses an open ended amount of heap.  </p>
<p>Chronicle solves this by not using the heap to store data, but instead using memory mapped files.  This improve memory utilisation by making the data more compact but also means a 1 GB JVM can stream 1 TB of data over a day without worrying about the heap or how much main memory you have.  In this case, an unbounded queue becomes easier to manage.</p>
<h1 id="how-it-works"><a href="#how-it-works" class="headerlink" title="how it works"></a>how it works</h1><p>Chronicle uses a memory mapped file to continuously journal messages, chronicles file-based storage will slowly grow in size as more data is written to the queue, the size of the queue can exceed your available memory, you are only constrained by the amount of disk space you have on your server. Chronicle writes data directly into off-heap memory which is shared between java processes on the same server.</p>
<p>Chronicle is very fast, it is able to write and read a message in just two microseconds with no garbage. Typically at the end of each day, you archive the queue and start the next day with a fresh empty queue.</p>
<h1 id="Chronicle-Queue-is-a-distributed-unbounded-persisted-queue"><a href="#Chronicle-Queue-is-a-distributed-unbounded-persisted-queue" class="headerlink" title="Chronicle Queue is a distributed unbounded persisted queue."></a>Chronicle Queue is a distributed unbounded persisted queue.</h1><p>Chronicle Queue:</p>
<p>supports asynchronous RMI and Publish/Subscribe interfaces with microsecond latencies.</p>
<p>passes messages between JVMs in under a microsecond (in optimised examples)</p>
<p>passes messages between JVMs on different machines via replication in under 10 microseconds (in optimised examples)</p>
<p>provides stable, soft, real time latencies into the millions of messages per second for a single thread to one queue; with total ordering of every event.</p>
<h2 id="Queue-introduction"><a href="#Queue-introduction" class="headerlink" title="Queue introduction"></a>Queue introduction</h2><p>Chronicle Queue is a Java project focused on building a persisted low-latency messaging framework for high performance and critical applications.</p>
<p>Chronicle diagram 005<br>At first glance Chronicle Queue can be seen as simply another queue implementation. However, it has major design choices that should be emphasised.</p>
<p>Using non-heap storage options (RandomAccessFile), Chronicle Queue provides a processing environment where applications do not suffer from Garbage Collection (GC). When implementing high-performance and memory-intensive applications (you heard the fancy term “bigdata”?) in Java, one of the biggest problems is garbage collection.</p>
<p>Garbage collection may slow down your critical operations non-deterministically at any time. In order to avoid non-determinism, and escape from garbage collection delays, off-heap memory solutions are ideal. The main idea is to manage your memory manually so it does not suffer from garbage collection. Chronicle Queue behaves like a management interface over off-heap memory so you can build your own solutions over it.</p>
<p>Chronicle Queue uses RandomAccessFiles while managing memory and this choice brings lots of possibilities. RandomAccessFiles permit non-sequential, or random, access to a file’s contents. To access a file randomly, you open the file, seek a particular location, and read from or write to that file. RandomAccessFiles can be seen as “large” C-type byte arrays that you can access at any random index “directly” using pointers. File portions can be used as ByteBuffers if the portion is mapped into memory.</p>
<p>This memory mapped file is also used for exceptionally fast interprocess communication (IPC) without affecting your system performance. There is no garbage collection as everything is done off-heap.</p>
<h2 id="Message-type"><a href="#Message-type" class="headerlink" title="Message type"></a>Message type</h2><ul>
<li>TCP: Stream-oriented </li>
<li>UDP, SCTP: message-oriented .</li>
</ul>
<h2 id="On-heap-vs-off-heap-memory-usage"><a href="#On-heap-vs-off-heap-memory-usage" class="headerlink" title="On heap vs off heap memory usage"></a>On heap vs off heap memory usage</h2><p>Overview</p>
<p>I was recently asked about the benefits and wisdom of using off heap memory in Java.  The answers may be of interest to others facing the same choices.</p>
<p>Off heap memory is nothing special.  The thread stacks, application code, NIO buffers are all off heap.  In fact in C and C++, you only have unmanaged memory as it does not have a managed heap by default.  The use of managed memory or “heap” in Java is a special feature of the language. Note: Java is not the only language to do this.<br>new Object() vs Object pool vs Off Heap memory.</p>
<p>new Object()</p>
<p>Before Java 5.0, using object pools was very popular.  Creating objects was still very expensive.   However, from Java 5.0, object allocation and garbage cleanup was made much cheaper, and developers found they got a performance speed up and a simplification of their code by removing object pools and just creating new objects whenever needed.  Before Java 5.0, almost any object pool, even an object pool which used objects provided an improvement, from Java 5.0 pooling only expensive objects obviously made sense e.g. threads, socket and database connections.</p>
<p>Object pools</p>
<p>In the low latency space it was still apparent that recycling mutable objects improved performance by reduced pressure on your CPU caches.  These objects have to have simple life cycles and have a simple structure, but you could see significant improvements in performance and jitter by using them.<br>Another area where it made sense to use object pools is when loading large amounts of data with many duplicate objects. With a significant reduction in memory usage and a reduction in the number of objects the GC had to manage, you saw a reduction in GC times and an increase in throughput.<br>These object pools were designed to be more light weight than say using a synchronized HashMap, and so they still helped.</p>
<p>Take this StringInterner class as an example. You pass it a recycled mutable StringBuilder of the text you want as a String and it will provide a String which matches.  Passing a String would be inefficient as you would have already created the object.  The StringBuilder can be recycled.<br>Note: this structure has an interesting property that requires no additional thread safety features, like volatile or synchronized, other than is provided by the minimum Java guarantees. i.e. you can see the final fields in a String correctly and only read consistent references.</p>
<p>public class StringInterner {<br>    private final String[] interner;<br>    private final int mask;<br>    public StringInterner(int capacity) {<br>        int n = Maths.nextPower2(capacity, 128);<br>        interner = new String[n];<br>        mask = n - 1;<br>    }</p>
<pre><code>private static boolean isEqual(@Nullable CharSequence s, @NotNull CharSequence cs) {
    if (s == null) return false;
    if (s.length() != cs.length()) return false;
    for (int i = 0; i &lt; cs.length(); i++)
        if (s.charAt(i) != cs.charAt(i))
            return false;
    return true;
}

@NotNull
public String intern(@NotNull CharSequence cs) {
    long hash = 0;
    for (int i = 0; i &lt; cs.length(); i++)
        hash = 57 * hash + cs.charAt(i);
    int h = (int) Maths.hash(hash) &amp; mask;
    String s = interner[h];
    if (isEqual(s, cs))
        return s;
    String s2 = cs.toString();
    return interner[h] = s2;
}</code></pre><p>}
Off heap memory usage</p>
<p>Using off heap memory and using object pools both help reduce GC pauses, this is their only similarity.  Object pools are good for short lived mutable objects, expensive to create objects and long live immutable objects where there is a lot of duplication.  Medium lived mutable objects, or complex objects are more likely to be better left to the GC to handle.  However, medium to long lived mutable objects suffer in a number of ways which off heap memory solves.</p>
<p>Off heap memory provides;</p>
<p>Scalability to large memory sizes e.g. over 1 TB and larger than main memory.<br>Notional impact on GC pause times.<br>Sharing between processes, reducing duplication between JVMs, and making it easier to split JVMs.<br>Persistence for faster restarts or replying of production data in test.<br>The use of off heap memory gives you more options in terms of how you design your system.  The most important improvement is not performance, but determinism.</p>
<p>Off heap and testing</p>
<p>One of the biggest challenges in high performance computing is reproducing obscure bugs and being able to prove you have fixed them.  By storing all your input events and data off heap in a persisted way you can turn your critical systems into a series of complex state machines. (Or in simple cases, just one state machine) In this way you get reproducible behaviour and performance between test and production.</p>
<p>A number of investment banks use this technique to replay a system reliably to any event in the day and work out exactly why that event was processed the way it was.  More importantly, once you have a fix you can show that you have fixed the issue which occurred in production, instead of finding an issue and hoping this was the issue.</p>
<p>Along with deterministic behaviour comes deterministic performance.  In test environments, you can replay the events with realistic timings and show the latency distribution you expect to get in production.  Some system jitter can’t be reproduce esp if the hardware is not the same, but you can get pretty close when you take a statistical view.  To avoid taking a day to replay a day of data you can add a threshold. e.g. if the time between events is more than 10 ms you might only wait 10 ms.  This can allow you to replay a day of events with realistic timing in under an hour and see whether your changes have improved your latency distribution or not.</p>
<p>By going more low level don’t you lose some of “compile once, run anywhere”?</p>
<p>To some degree this is true, but it is far less than you might think.  When you are working closer the processor and so you are more dependant on how the processor, or OS behaves.  Fortunately, most systems use AMD/Intel processors and even ARM processors are becoming more compatible in terms of the low level guarantees they provide.  There is also differences in the OSes, and these techniques tend to work better on Linux than Windows.  However, if you develop on MacOSX or Windows and use Linux for production, you shouldn’t have any issues.  This is what we do at Higher Frequency Trading.</p>
<p>What new problems are we creating by using off heap?</p>
<p>Nothing comes for free, and this is the case with off heap.  The biggest issue with off heap is your data structures become less natural.  You either need a simple data structure which can be mapped directly to off heap, or you have a complex data structure which serializes and deserializes to put it off heap.  Obvious using serialization has its own headaches and performance hit.  Using serialization thus much slower than on heap objects.</p>
<p>In the financial world, most high ticking data structure are flat and simple, full of primitives which maps nicely off heap with little overhead.</p>
<h1 id="How-does-Chronicle-Queue-work"><a href="#How-does-Chronicle-Queue-work" class="headerlink" title="How does Chronicle Queue work"></a>How does Chronicle Queue work</h1><h2 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h2><ul>
<li>Messages are grouped by topics. A topic can contain any number of sub-topics which are logically stored together under the queue/topic.</li>
<li>An appender is the source of messages.</li>
<li>A tailer is a receiver of messages.</li>
<li>Chronicle Queue is <code>broker-less</code> by default. You can use Chronicle Engine to act as a broker for remote access.</li>
</ul>
<blockquote>
<p>Note<br>We deliberately avoid the term consumer as messages are not consumed/destroyed by reading.</p>
</blockquote>
<h2 id="At-a-high-level"><a href="#At-a-high-level" class="headerlink" title="At a high level:"></a>At a high level:</h2><ul>
<li><p>appenders write to the end of a queue. There is no way to insert, or delete excerpts.</p>
</li>
<li><p>tailers read the next available message each time they are called.</p>
</li>
</ul>
<p>By using Chronicle Engine, a Java or C# client can publish to a queue to act as a remote appender, and you subscribe to a queue to act as a remote tailer.</p>
<h2 id="Topics-and-Queue-files"><a href="#Topics-and-Queue-files" class="headerlink" title="Topics and Queue files"></a>Topics and Queue files</h2><p>Each topic is a directory of queues. There is a file for each roll cycle. If you have a topic called mytopic, the layout could look like this:</p>
<p>mytopic/<br>    20160710.cq4<br>    20160711.cq4<br>    20160712.cq4<br>    20160713.cq4<br>To copy all the data for a single day (or cycle), you can copy the file for that day on to your development machine for replay testing.</p>
<p>Appenders and tailers are cheap as they don’t even require a TCP connection; they are just a few Java objects.</p>
<h2 id="File-Retention"><a href="#File-Retention" class="headerlink" title="File Retention"></a>File Retention</h2><p>You can add a StoreFileListener to notify you when a file is added, or no longer used. This can be used to delete files after a period of time. However, by default, files are retained forever. Our largest users have over 100 TB of data stored in queues.</p>
<h2 id="Every-Tailer-sees-every-message"><a href="#Every-Tailer-sees-every-message" class="headerlink" title="Every Tailer sees every message."></a>Every Tailer sees every message.</h2><p>An abstraction can be added to filter messages, or assign messages to just one message processor. However, in general you only need one main tailer for a topic, with possibly, some supporting tailers for monitoring etc.</p>
<p>As Chronicle Queue doesn’t partition its topics, you get total ordering of all messages within that topic. Across topics, there is no guarantee of ordering; if you want to replay deterministically from a system which consumes from multiple topics, we suggest replaying from that system’s output.</p>
<h1 id="Guarantees"><a href="#Guarantees" class="headerlink" title="Guarantees"></a>Guarantees</h1><p>Chronicle Queue provides the following guarantees;</p>
<p>for each appender, messages are written in the order the appender wrote them. Messages by different appenders are interleaved,</p>
<p>for each tailer, it will see every message for a topic in the same order as every other tailer,</p>
<p>when replicated, every replica has a copy of every message.</p>
<h1 id="Use-Cases"><a href="#Use-Cases" class="headerlink" title="Use Cases"></a>Use Cases</h1><p>Chronicle Queue is most often used for producer-centric systems where you need to retain a lot of data for days or years.</p>
<h2 id="What-is-a-producer-centric-system"><a href="#What-is-a-producer-centric-system" class="headerlink" title="What is a producer-centric system?"></a>What is a producer-centric system?</h2><p>Most messaging systems are consumer-centric. Flow control is implemented to avoid the consumer ever getting overloaded; even momentarily. A common example is a server supporting multiple GUI users. Those users might be on different machines (OS and hardware), different qualities of network (latency and bandwidth), doing a variety of other things at different times. For this reason it makes sense for the client consumer to tell the producer when to back off, delaying any data until the consumer is ready to take more data.</p>
<p>Chronicle Queue is a producer-centric solution and does everything possible to never push back on the producer, or tell it to slow down. This makes it a powerful tool, providing a big buffer between your system, and an upstream producer over which you have little, or no, control.</p>
<p>For market data in particular, real time means in a few microseconds; it doesn’t mean intra-day (during the day).</p>
<p>Chronicle Queue is fast and efficient, and has been used to increase the speed that data is passed between threads. In addition, it also keeps a record of every message passed allowing you to significantly reduce the amount of logging that you need to do.</p>
<h2 id="Latency-Sensitive-Micro-services"><a href="#Latency-Sensitive-Micro-services" class="headerlink" title="Latency Sensitive Micro-services"></a>Latency Sensitive Micro-services</h2><p>Chronicle Queue supports low latency IPC (Inter Process Communication) between JVMs on the same machine in the order of magnitude of 1 microsecond; as well as between machines with a typical latency of 10 microseconds for modest throughputs of a few hundred thousands. Chronicle Queue supports throughputs of millions of events per second, with stable microsecond latencies.</p>
<h2 id="Log-Replacement"><a href="#Log-Replacement" class="headerlink" title="Log Replacement"></a>Log Replacement</h2><p>As Chronicle Queue can be used to build state machines. All the information about the state of those components can be reproduced externally, without direct access to the components, or to their state. This significantly reduces the need for additional logging.</p>
<p>However, any logging you do need can be recorded in great detail. This makes enabling DEBUG logging in production practical. This is because the cost of logging is very low; less than 10 microseconds. Logs can be replicated centrally for log consolidation.</p>
<p>Chronicle Queue is being used to store 100+ TB of data, which can be replayed from any point in time.</p>
<h1 id="Source-code"><a href="#Source-code" class="headerlink" title="Source code"></a>Source code</h1><h2 id="MappedFile"><a href="#MappedFile" class="headerlink" title="MappedFile"></a>MappedFile</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.openhft.chronicle.bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.openhft.chronicle.core.Jvm;</span><br><span class="line"><span class="keyword">import</span> net.openhft.chronicle.core.OS;</span><br><span class="line"><span class="keyword">import</span> net.openhft.chronicle.core.ReferenceCounted;</span><br><span class="line"><span class="keyword">import</span> net.openhft.chronicle.core.ReferenceCounter;</span><br><span class="line"><span class="keyword">import</span> net.openhft.chronicle.core.io.IORuntimeException;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel.MapMode;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileLock;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> net.openhft.chronicle.core.io.Closeable.closeQuietly;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A memory mapped files which can be randomly accessed in chunks. It has overlapping regions to</span></span><br><span class="line"><span class="comment"> * avoid wasting bytes at the end of chunks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MappedFile</span> <span class="keyword">implements</span> <span class="title">ReferenceCounted</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_CAPACITY = <span class="number">128L</span> &lt;&lt; <span class="number">40</span>;</span><br><span class="line">    <span class="comment">// A single JVM cannot lock a file more than once.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object GLOBAL_FILE_LOCK = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RandomAccessFile raf;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileChannel fileChannel;</span><br></pre></td></tr></table></figure>

<p>public interface BytesStore extends RandomDataInput, RandomDataOutput, ReferencedCount, CharSequence</p>
<p>public interface Memory {<br>    default long heapUsed() {<br>        Runtime runtime = Runtime.getRuntime();<br>        return runtime.totalMemory() - runtime.freeMemory();<br>    }</p>
<pre><code>@Override
@ForceInline
public void writeByte(long address, byte b) {
    UNSAFE.putByte(address, b);
}</code></pre><p>/**</p>
<ul>
<li>Marker annotation for some methods and constructors in the JSR 292 implementation.</li>
<li><p></p></li>
<li>To utilise this annotation se Chronicle Enterprise Warmup module.</li>
<li>/
@Target({ElementType.METHOD, ElementType.CONSTRUCTOR})<br>@Retention(RetentionPolicy.RUNTIME)<br>public @interface ForceInline {<br>}</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://github.com/OpenHFT/Chronicle-Queue" target="_blank" rel="noopener">https://github.com/OpenHFT/Chronicle-Queue</a></li>
<li><a href="http://vanillajava.blogspot.com/2015/08/what-does-chronicle-software-do.html" target="_blank" rel="noopener">http://vanillajava.blogspot.com/2015/08/what-does-chronicle-software-do.html</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-08-19-ZooKeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-08-19-ZooKeeper/" class="post-title-link" itemprop="url">Zoo-keeper</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="ZK-Motto"><a href="#ZK-Motto" class="headerlink" title="ZK Motto"></a>ZK Motto</h1><blockquote>
<p>the motto “ZooKeeper: Because Coordinating Distributed Systems is a Zoo.”</p>
</blockquote>
<h1 id="Features-of-Zookeeper"><a href="#Features-of-Zookeeper" class="headerlink" title="Features of Zookeeper"></a>Features of Zookeeper</h1><ul>
<li>Synchronization − Mutual exclusion and co-operation between server processes.</li>
<li>Ordered Messages - The strict ordering means that sophisticated synchronization primitives can be implemented at the client.</li>
<li>Reliability - The reliability aspects keep it from being a single point of failure.</li>
<li>Atomicity − Data transfer either succeeds or fails completely, but no transaction is partial.</li>
<li>High performant - The performance aspects of Zookeeper means it can be used in large, distributed systems.</li>
<li>Distributed.</li>
<li>High avaliablity.</li>
<li>Fault-tolerant.</li>
<li>Loose coupling.</li>
<li>Partial failure.</li>
<li>High throughput and low latency - data is stored data in memory and on disk as well.</li>
<li>Replicated.</li>
<li>Automatic failover: When a Zookeeper dies, the session is automatically migrated over to another Zookeeper.</li>
</ul>
<h2 id="Different-type-of-data"><a href="#Different-type-of-data" class="headerlink" title="Different type of data"></a>Different type of data</h2><p>When designing an application with ZooKeeper, one ideally separates application data from control or coordination data. For example, the users of a web-mail service are interested in their mailbox content, but not on which server is handling the requests of a particular mailbox. The mailbox content is application data, whereas the mapping of the mailbox to a specific mail server is part of the coordination data (or metadata). A ZooKeeper ensemble manages the latter.</p>
<p>The multiple processes consequently need to implement mutual exclusion. We can actually think of the task of acquiring mastership as the one of acquiring a lock: the process that acquires the mastership lock exercises the role of master.</p>
<p>Coordination does not always take the form of synchronization primitives like leader election or locks. Configuration metadata is often used as a way for a process to convey what others should be doing. For example, in a master-worker system, workers need to know the tasks that have been assigned to them, and this information must be available even if the master crashes.</p>
<h2 id="How-world-work-without-ZooKeeper"><a href="#How-world-work-without-ZooKeeper" class="headerlink" title="How world work without ZooKeeper"></a>How world work without ZooKeeper</h2><p>It is certainly possible to build distributed systems without using ZooKeeper. ZooKeep‐ er, however, offers developers the possibility of focusing more on application logic rather than on arcane distributed systems concepts. Programming distributed systems without ZooKeeper is possible, but more difficult.</p>
<h2 id="What-does-ZooKeeper-does-not-do"><a href="#What-does-ZooKeeper-does-not-do" class="headerlink" title="What does ZooKeeper does not do"></a>What does ZooKeeper does not do</h2><p>The ensemble of ZooKeeper servers manages critical application data related to coor‐ dination. ZooKeeper is not for bulk storage. For bulk storage of application data, there are a number of options available, such as databases and distributed file systems. When designing an application with ZooKeeper, one ideally separates application data from control or coordination data.</p>
<p>ZooKeeper, however, does not implement the tasks for you. It does not elect a master or track live processes for the application out of the box. Instead, it provides the tools for implementing such tasks. The developer decides what coordination tasks to implement.</p>
<p>Processes in a distributed system have two broad options for communication: they can exchange messages directly through a network, or read and write to some shared storage. ZooKeeper uses the shared storage model to let applications implement coordination and synchronization primitives. But shared storage itself requires network communi‐ cation between the processes and the storage. It is important to stress the role of network communication because it is an important source of complications in the design of a distributed system.</p>
<p>This scenario leads to a problem commonly called split-brain: two or more parts of the system make progress independ‐ ently, leading to inconsistent behavior. As part of coming up with a way to cope with master failures, it is critical that we avoid split-brain scenarios.</p>
<h1 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h1><p>The following requirements for our master-worker architecture:<br>Master election<br>It is critical for progress to have a master available to assign tasks to workers.<br>Crash detection<br>The master must be able to detect when workers crash or disconnect.<br>Group membership management<br>The master must be able to figure out which workers are available to execute tasks.<br>Metadata management<br>The master and the workers must be able to store assignments and execution sta‐ tuses in a reliable manner.</p>
<h1 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h1><p>known as CAP, which stands for Consistency, Availability, and Partition-tolerance, says that when designing a distributed system we may want all three of those properties, but that no system can handle all three.2 Zoo‐ Keeper has been designed with mostly consistency and availability in mind, although it also provides read-only capability in the presence of network partitions.</p>
<h1 id="ZooKeeper-Basics"><a href="#ZooKeeper-Basics" class="headerlink" title="ZooKeeper Basics"></a>ZooKeeper Basics</h1><p>Several primitives used for coordination are commonly shared across many applica‐ tions. Consequently, one way of designing a service used for coordination is to come up with a list of primitives, expose calls to create instances of each primitive, and ma‐ nipulate these instances directly. For example, we could say that distributed locks con‐ stitute an important primitive and expose calls to create, acquire, and release locks.<br>Such a design, however, suffers from a couple of important shortcomings. First, we need to either come up with an exhaustive list of primitives used beforehand, or keep ex‐ tending the API to introduce new primitives. Second, it does not give flexibility to the application using the service to implement primitives in the way that is most suitable for it.<br>We consequently have taken a different path with ZooKeeper. ZooKeeper does not ex‐ pose primitives directly. Instead, it exposes a file system-like API comprised of a small set of calls that enables applications to implement their own primitives. We typically use recipes to denote these implementations of primitives. Recipes include ZooKeeper operations that manipulate small data nodes, called znodes, that are organized hier‐ archically as a tree, just like in a file system.</p>
<h2 id="znodes"><a href="#znodes" class="headerlink" title="znodes"></a>znodes</h2><p>a few other znodes that could be useful in a master- worker configuration:</p>
<ul>
<li>The /workers znode is the parent znode to all znodes representing a worker avail‐ able in the system. Figure 2-1 shows that one worker (foo.com:2181) is available. If a worker becomes unavailable, its znode should be removed from /workers.</li>
<li>The /tasks znode is the parent of all tasks created and waiting for workers to execute them. Clients of the master-worker application add new znodes as children of /tasks to represent new tasks and wait for znodes representing the status of the task.</li>
<li>The /assign znode is the parent of all znodes representing an assignment of a task to a worker. When a master assigns a task to a worker, it adds a child znode to /assign.<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2>API Overview<br>Znodes may or may not contain data. If a znode contains any data, the data is stored as a byte array. The exact format of the byte array is specific to each application, and ZooKeeper does not directly provide support to parse it. Serialization packages such as Protocol Buffers, Thrift, Avro, and MessagePack may be handy for dealing with the format of the data stored in znodes, but sometimes string encodings such as UTF-8 or ASCII suffice.</li>
</ul>
<h2 id="The-ZooKeeper-API-exposes-the-following-operations"><a href="#The-ZooKeeper-API-exposes-the-following-operations" class="headerlink" title="The ZooKeeper API exposes the following operations:"></a>The ZooKeeper API exposes the following operations:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create /path data</span><br><span class="line">Creates a znode named with /path and containing data</span><br><span class="line">delete /path</span><br><span class="line">Deletes the znode /path</span><br><span class="line">exists /path</span><br><span class="line">Checks whether /path exists</span><br><span class="line">setData /path data</span><br><span class="line">Sets the data of znode /path to data</span><br><span class="line">getData /path</span><br><span class="line">Returns the data in /path</span><br><span class="line">getChildren /path</span><br><span class="line">Returns the list of children under /path</span><br><span class="line">One important note is that ZooKeeper does not allow partial writes or reads of the znode data. When setting the data of a znode or reading it, the content of the znode is replaced or read entirely.</span><br></pre></td></tr></table></figure>

<p>ZooKeeper clients connect to a ZooKeeper service and establish a session through which they make API calls. </p>
<p>If a worker becomes unavailable, its session expires and its znode in /workers disappears automatically.</p>
<p>An ephemeral znode can be deleted in two situations:</p>
<ol>
<li>When the session of the client creator ends, either by expiration or because it ex‐ plicitly closed.</li>
<li>When a client, not necessarily the creator, deletes it.</li>
</ol>
<h3 id="Sequential-znodes"><a href="#Sequential-znodes" class="headerlink" title="Sequential znodes"></a>Sequential znodes</h3><p>A znode can also be set to be sequential. A sequential znode is assigned a unique, mo‐ notonically increasing integer. This sequence number is appended to the path used to create the znode. For example, if a client creates a sequential znode with the path /tasks/ task-, ZooKeeper assigns a sequence number, say 1, and appends it to the path. The path of the znode becomes /tasks/task-1. Sequential znodes provide an easy way to create znodes with unique names. They also provide a way to easily see the creation order of znodes.</p>
<h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><p>This is a common problem with polling. To replace the client polling, we have opted for a mechanism based on notifications: clients register with ZooKeeper to receive notifi‐ cations of changes to znodes. Registering to receive a notification for a given znode consists of setting a watch. A watch is a one-shot operation, which means that it triggers one notification. To receive multiple notifications over time, the client must set a new watch upon receiving each notification. </p>
<h2 id="Versions"><a href="#Versions" class="headerlink" title="Versions"></a>Versions</h2><p>Each znode has a version number associated with it that is incremented every time its data changes. A couple of operations in the API can be executed conditionally: setDa ta and delete. Both calls take a version as an input parameter, and the operation suc‐ ceeds only if the version passed by the client matches the current version on the server. The use of versions is important when multiple ZooKeeper clients might be trying to perform operations over the same znode. For example, suppose that a client c1 writes a znode /config containing some configuration. If another client c2 concurrently updates the znode, the version c1 has is stale and the setData of c1 must not succeed. Using versions avoids such situations. In this case, the version that c1 uses when writing back doesn’t match and the operation fails. </p>
<h1 id="ZooKeeper-Architecture"><a href="#ZooKeeper-Architecture" class="headerlink" title="ZooKeeper Architecture"></a>ZooKeeper Architecture</h1><p>Now that we have discussed at a high level the operations that ZooKeeper exposes to applications, we need to understand more of how the service actually works. Applica‐ tions make calls to ZooKeeper through a client library. The client library is responsible for the interaction with ZooKeeper servers.</p>
<p>ZooKeeper servers run in two modes: standalone and quorum. Standalone mode is pretty much what the term says: there is a single server, and ZooKeeper state is not replicated. In quorum mode, a group of ZooKeeper servers, which we call a ZooKeeper ensemble, replicates the state, and together they serve client requests. From this point on, we use the term “ZooKeeper ensemble” to denote an installation of servers. This installation could contain a single server and operate in standalone mode or contain a group of servers and operate in quorum mode.</p>
<h2 id="ZooKeeper-Quorums"><a href="#ZooKeeper-Quorums" class="headerlink" title="ZooKeeper Quorums"></a>ZooKeeper Quorums</h2><p>In quorum mode, ZooKeeper replicates its data tree across all servers in the ensemble. But if a client had to wait for every server to store its data before continuing, the delays might be unacceptable. In public administration, a quorum is the minimum number of legislators required to be present for a vote. In ZooKeeper, it is the minimum number of servers that have to be running and available in order for ZooKeeper to work. This number is also the minimum number of servers that have to store a client’s data before telling the client it is safely stored. For instance, we might have five ZooKeeper servers in total, but a quorum of three. So long as any three servers have stored the data, the client can continue, and the other two servers will eventually catch up and store the data.</p>
<p>It is important to choose an adequate size for the quorum. Quorums must guarantee that, regardless of delays and crashes in the system, any update request the service pos‐ itively acknowledges will persist until another request supersedes it.</p>
<p><code>The bottom line is that we should always shoot for an odd number of servers.</code></p>
<h2 id="sessions"><a href="#sessions" class="headerlink" title="sessions"></a>sessions</h2><p>All operations a client submits to ZooKeeper are associated to a session. When a session ends for any reason, the ephemeral nodes created during that session disappear.</p>
<p>the session may be moved to a different server if the client has not heard from its current server for some time. Moving a session to a different server is handled transparently by the ZooKeeper client library.</p>
<p>Sessions offer order guarantees, which means that requests in a session are executed in FIFO (first in, first out) order. Typically, a client has only a single session open, so its requests are all executed in FIFO order. If a client has multiple concurrent sessions, FIFO ordering is not necessarily preserved across the sessions.</p>
<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 5] <span class="built_in">stat</span> /master</span><br><span class="line">cZxid = 0x4</span><br><span class="line">ctime = Mon Aug 20 21:10:23 AEST 2018</span><br><span class="line">mZxid = 0x4</span><br><span class="line">mtime = Mon Aug 20 21:10:23 AEST 2018</span><br><span class="line">pZxid = 0x4</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x10003c70e250001</span><br><span class="line">dataLength = 11</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 8] create /workers <span class="string">""</span></span><br><span class="line">Created /workers</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 9] create /tasks <span class="string">""</span></span><br><span class="line">Created /tasks</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 10] create /assign <span class="string">""</span></span><br><span class="line">Created /assign</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 11] ls /</span><br><span class="line">[assign, master, tasks, workers, zookeeper]</span><br></pre></td></tr></table></figure>

<h2 id="link-master-and-workers"><a href="#link-master-and-workers" class="headerlink" title="link master and workers"></a>link master and workers</h2><p>In a real application, these znodes need to be created either by a primary process before it starts assigning tasks or by some bootstrap procedure. Regardless of how they are created, once they exist, the master needs to watch for changes in the children of /workers and /tasks:<br>    [zk: localhost:2181(CONNECTED) 4] ls /workers true<br>    []<br>    [zk: localhost:2181(CONNECTED) 5] ls /tasks true<br>    []<br>    [zk: localhost:2181(CONNECTED) 6]<br>Note that we have used the optional true parameter with ls, as we did before with stat on the master. The true parameter, in this case, creates a watch for changes to the set of children of the corresponding znode.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 14] create -e /workers/todd-worker1 <span class="string">""</span></span><br><span class="line">Created /workers/todd-worker1</span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:NodeChildrenChanged path:/workers</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 15]</span><br></pre></td></tr></table></figure>

<p>Recall that the master has set a watch for changes to the children of /workers. Once the worker creates a znode under /workers, the master observes the following notification:<br>    WATCHER::<br>    WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/workers</p>
<h2 id="Tasks-workflows"><a href="#Tasks-workflows" class="headerlink" title="Tasks workflows"></a>Tasks workflows</h2><ul>
<li>Clients add tasks to the system. Here we assume that the client asks the master-worker system to run a command cmd. To add a task to the system, a client executes the following:<br>  [zk: localhost:2181(CONNECTED) 0] create -s /tasks/task- “cmd”<br>  Created /tasks/task-0000000000</li>
<li>The client now has to wait until the task is executed. </li>
<li>The worker that executes the task creates a status znode for the task once the task completes. </li>
<li>The client determines that the task has been executed when it sees that a status znode for the task has been created; </li>
<li>the client consequently must watch for the creation of the status znode:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 18] create -s /tasks/task- <span class="string">"cmd"</span></span><br><span class="line">Created /tasks/task-0000000000</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 19] ls /tasks</span><br><span class="line">[task-0000000000]</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 20] ls -w /tasks/task-0000000000 </span><br><span class="line">[]</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 21] ls -w /workers</span><br><span class="line">[todd-worker1]</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 22] create /assign/todd-worker1/task-0000000000 <span class="string">""</span></span><br><span class="line">Ephemerals cannot have children: /assign/todd-worker1/task-0000000000</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 23] delete /assign/todd-worker1</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 24] create /assign/todd-worker1</span><br><span class="line">Created /assign/todd-worker1</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 25] create /assign/todd-worker1/task-0000000000 <span class="string">""</span></span><br><span class="line">Created /assign/todd-worker1/task-0000000000</span><br><span class="line">[zk: 127.0.0.1:2181,127.0.0.1:2182(CONNECTED) 26] ls /assign/todd-worker1</span><br><span class="line">[task-0000000000]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Once the worker finishes executing the task, it adds a status znode to /tasks:</span></span><br><span class="line">    [zk: localhost:2181(CONNECTED) 4] create /tasks/task-0000000000/status <span class="string">"done"</span></span><br><span class="line">    Created /tasks/task-0000000000/status</span><br><span class="line">    [zk: localhost:2181(CONNECTED) 5]</span><br><span class="line"><span class="comment"># and the client receives a notification and checks the result:</span></span><br><span class="line">WATCHER::</span><br><span class="line">    WatchedEvent state:SyncConnected <span class="built_in">type</span>:NodeChildrenChanged</span><br><span class="line">    path:/tasks/task-0000000000</span><br><span class="line">    [zk: localhost:2181(CONNECTED) 2] get /tasks/task-0000000000</span><br><span class="line">    <span class="string">"cmd"</span></span><br></pre></td></tr></table></figure>

<h1 id="ZooKeeper-API"><a href="#ZooKeeper-API" class="headerlink" title="ZooKeeper API"></a>ZooKeeper API</h1><h2 id="Setting-the-ZooKeeper-CLASSPATH"><a href="#Setting-the-ZooKeeper-CLASSPATH" class="headerlink" title="Setting the ZooKeeper CLASSPATH"></a>Setting the ZooKeeper CLASSPATH</h2><p> ZOOBINDIR=”<path_to_distro>/bin”<br>    . “$ZOOBINDIR”/zkEnv.sh</path_to_distro></p>
<h2 id="handle"><a href="#handle" class="headerlink" title="handle"></a>handle</h2><p>The ZooKeeper API is built around a ZooKeeper handle that is passed to every API call. This handle represents a session with ZooKeeper. A session that is established with one ZooKeeper server will migrate to another ZooKeeper server if its connection is broken. As long as the session is alive, the handle will remain valid, and the ZooKeeper client library will continually try to keep an active connection to a ZooKeeper server to keep the session alive. If the handle is closed, the ZooKeeper client library will tell the ZooKeeper servers to kill the session. If ZooKeeper decides that a client has died, it will invalidate the session. If a client later tries to reconnect to a Zoo‐ Keeper server using the handle that corresponds to the invalidated session, the Zoo‐ Keeper server informs the client library that the session is no longer valid and the handle returns errors for all operations.</p>
<p>The constructor that creates a ZooKeeper handle usually looks like:<br>ZooKeeper(<br>String connectString, int sessionTimeout, Watcher watcher)</p>
<h3 id="Implementing-a-Watcher"><a href="#Implementing-a-Watcher" class="headerlink" title="Implementing a Watcher"></a>Implementing a Watcher</h3><p>To receive notifications from ZooKeeper, we need to implement watchers. Let’s look a bit more closely at the Watcher interface. It has the following declaration:<br>public interface Watcher {<br>void process(WatchedEvent event);<br>}</p>
<h3 id="Sample-ZooKeeper-handle"><a href="#Sample-ZooKeeper-handle" class="headerlink" title="Sample ZooKeeper handle"></a>Sample ZooKeeper handle</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper; </span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Master</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123; </span><br><span class="line">  ZooKeeper zk;</span><br><span class="line">        String hostPort;</span><br><span class="line"></span><br><span class="line">Master(String hostPort) </span><br><span class="line">&#123; <span class="keyword">this</span>.hostPort = hostPort;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startZK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">zk = <span class="keyword">new</span> ZooKeeper(hostPort, <span class="number">15000</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent e)</span> </span>&#123; System.out.println(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Master m = <span class="keyword">new</span> Master(args[<span class="number">0</span>]);</span><br><span class="line">            m.startZK();</span><br><span class="line">            <span class="comment">// wait for a bit</span></span><br><span class="line">            Thread.sleep(<span class="number">60000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nce we have connected to ZooKeeper, there will be a background thread that will maintain the ZooKeeper session. This thread is a daemon thread, which means that the program may exit even if the thread is still active. Here we sleep for a bit so that we can see some events come in before the program exits.<br>We can compile this simple example using the following:<br>$ javac -cp $CLASSPATH Master.java<br>Once we have compiled Master.java, we run it and see the following:<br>$ java -cp $CLASSPATH Master 127.0.0.1:2181</p>
<h2 id="disconnect"><a href="#disconnect" class="headerlink" title="disconnect"></a>disconnect</h2><p>When developers see the Disconnected event, some think they need to create a new ZooKeeper handle to reconnect to the service. Do not do that! See what happens when you start the server, start the Master, and then stop and start the server while the Master is still running. You should see the SyncConnected event followed by the Disconnec ted event and then another SyncConnected event. The ZooKeeper client library takes care of reconnecting to the service for you. Unfortunately, network outages and server failures happen. Usually, ZooKeeper can deal with these failures.</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-08-21-sudo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-08-21-sudo/" class="post-title-link" itemprop="url">Sudo in a Nutshell</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Sudo-in-a-Nutshell"><a href="#Sudo-in-a-Nutshell" class="headerlink" title="Sudo in a Nutshell"></a>Sudo in a Nutshell</h1><p>Sudo (su “do”) allows a system administrator to give certain users (or groups of users) the ability to run some (or all) commands as root while logging all commands and arguments. Sudo operates on a per-command basis, it is not a replacement for the shell. Its features include:</p>
<p>The ability to restrict what commands a user may run on a per-host basis.<br>Sudo does copious logging of each command, providing a clear audit trail of who did what. When used in tandem with syslogd, the system log daemon, sudo can log all commands to a central host (as well as on the local host). At CU, all admins use sudo in lieu of a root shell to take advantage of this logging.<br>Sudo uses timestamp files to implement a “ticketing” system. When a user invokes sudo and enters their password, they are granted a ticket for 5 minutes (this timeout is configurable at compile-time). Each subsequent sudo command updates the ticket for another 5 minutes. This avoids the problem of leaving a root shell where others can physically get to your keyboard. There is also an easy way for a user to remove their ticket file, useful for placing in a .logout file.<br>Sudo’s configuration file, the sudoers file, is setup in such a way that the same sudoers file may be used on many machines. This allows for central administration while keeping the flexibility to define a user’s privileges on a per-host basis. Please see the samples sudoers file below for a real-world example.</p>
<h1 id="sudo-conf"><a href="#sudo-conf" class="headerlink" title="sudo.conf"></a>sudo.conf</h1><p>The sudo.conf file is used to configure the sudo front end. It specifies the security policy and I/O logging plugins, debug flags as well as plugin-agnostic path names and settings.</p>
<p>sudo supports a plugin architecture for security policies and input/output logging. Third parties can develop and distribute their own policy and I/O logging plugins to work seamlessly with the sudo front end. Plugins are dynamically loaded based on the contents of sudo.conf.<br>A Plugin line consists of the Plugin keyword, followed by the symbol_name and the path to the dynamic shared object that contains the plugin. The symbol_name is the name of the struct policy_plugin or struct io_plugin symbol contained in the plugin. The path may be fully qualified or relative. If not fully qualified, it is relative to the directory specified by the plugin_dir Path setting, which defaults to /usr/local/libexec/sudo. In other words:<br>Plugin sudoers_policy sudoers.so<br>is equivalent to:<br>Plugin sudoers_policy /usr/local/libexec/sudo/sudoers.so</p>
<h2 id="Configurations"><a href="#Configurations" class="headerlink" title="Configurations"></a>Configurations</h2><ul>
<li><p>sudoers_file=pathname<br>The sudoers_file argument can be used to override the default path to the sudoers file.</p>
</li>
<li><p>sudoers_uid=uid<br>The sudoers_uid argument can be used to override the default owner of the sudoers file. It should be specified as a numeric user ID.</p>
</li>
</ul>
<h1 id="email-notification"><a href="#email-notification" class="headerlink" title="email notification"></a>email notification</h1><p>If a user who is not listed in the policy tries to run a command via sudo, mail is sent to the proper authorities. The address used for such mail is configurable via the mailto Defaults entry (described later) and defaults to root.</p>
<p>Note that no mail will be sent if an unauthorized user tries to run sudo with the -l or -v option unless there is an authentication error and either the mail_always or mail_badpass flags are enabled. This allows users to determine for themselves whether or not they are allowed to use sudo. All attempts to run sudo (successful or not) will be logged, regardless of whether or not mail is sent.</p>
<p>sudoers uses per-user time stamp files for credential caching. Once a user has been authenticated, a record is written containing the user ID that was used to authenticate, the terminal session ID, the start time of the session leader (or parent process) and a time stamp (using a monotonic clock if one is available). The user may then use sudo without a password for a short period of time (5 minutes unless overridden by the timestamp_timeout option). By default, sudoers uses a separate record for each terminal, which means that a user’s login sessions are authenticated separately. The timestamp_type option can be used to select the type of time stamp record sudoers will use.</p>
<h1 id="File-format"><a href="#File-format" class="headerlink" title="File format"></a>File format</h1><p>The sudoers file is composed of two types of entries: aliases (basically variables) and user specifications (which specify who may run what).</p>
<p>When multiple entries match for a user, they are applied in order. Where there are multiple matches, the last match is used (which is not necessarily the most specific match).<br>The sudoers file grammar will be described below in Extended Backus-Naur Form (EBNF). Don’t despair if you are unfamiliar with EBNF; it is fairly simple, and the definitions below are annotated.</p>
<h1 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h1><p>By default, the env_reset option is enabled. This causes commands to be executed with a new, minimal environment.</p>
<p>Lists have two additional assignment operators, += and -=. These operators are used to add to and delete from a list respectively. It is not an error to use the -= operator to remove an element that does not exist in a list.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">35 Defaults    env_reset</span><br><span class="line">36 Defaults    env_keep += <span class="string">"BLOCKSIZE"</span></span><br><span class="line">37 Defaults    env_keep += <span class="string">"COLORFGBG COLORTERM"</span></span><br><span class="line">38 Defaults    env_keep += <span class="string">"__CF_USER_TEXT_ENCODING"</span></span><br><span class="line">39 Defaults    env_keep += <span class="string">"CHARSET LANG LANGUAGE LC_ALL LC_COLLATE LC_CTYPE"</span></span><br><span class="line">40 Defaults    env_keep += <span class="string">"LC_MESSAGES LC_MONETARY LC_NUMERIC LC_TIME"</span></span><br><span class="line">41 Defaults    env_keep += <span class="string">"LINES COLUMNS"</span></span><br><span class="line">42 Defaults    env_keep += <span class="string">"LSCOLORS"</span></span><br><span class="line">43 Defaults    env_keep += <span class="string">"SSH_AUTH_SOCK"</span></span><br><span class="line">44 Defaults    env_keep += <span class="string">"TZ"</span></span><br><span class="line">45 Defaults    env_keep += <span class="string">"DISPLAY XAUTHORIZATION XAUTHORITY"</span></span><br><span class="line">46 Defaults    env_keep += <span class="string">"EDITOR VISUAL"</span></span><br><span class="line">47 Defaults    env_keep += <span class="string">"HOME MAIL"</span></span><br><span class="line">48 </span><br><span class="line">49 Defaults    lecture_file = <span class="string">"/etc/sudo_lecture"</span></span><br></pre></td></tr></table></figure>

<h3 id="lecture"><a href="#lecture" class="headerlink" title="lecture"></a>lecture</h3><h4 id="lecture-1"><a href="#lecture-1" class="headerlink" title="lecture"></a>lecture</h4><p>This option controls when a short lecture will be printed along with the password prompt. It has the following possible values:</p>
<ul>
<li>always<br>Always lecture the user.</li>
<li>never<br>Never lecture the user.</li>
<li>once<br>Only lecture the user the first time they run sudo.<br>If no value is specified, a value of once is implied. Negating the option results in a value of never being used. The default value is once.<h4 id="lecture-file"><a href="#lecture-file" class="headerlink" title="lecture_file"></a>lecture_file</h4>Path to a file containing an alternate sudo lecture that will be used in place of the standard lecture if the named file exists. By default, sudo uses a built-in lecture.  </li>
</ul>
<h1 id="Everything-is-file"><a href="#Everything-is-file" class="headerlink" title="Everything is file"></a>Everything is file</h1><p>A fundamental and very powerful, consistent abstraction provided in UNIX and compatible operating systems is the file abstraction. Many OS services and device interfaces are implemented to provide a file or file system metaphor to applications.</p>
<h1 id="manage-user-group"><a href="#manage-user-group" class="headerlink" title="manage user group"></a>manage user group</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Alternatively, gpasswd may be used. Though the username can only be added (or removed) from one group at a time:</span></span><br><span class="line">gpasswd --add username group</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add users to a group with the gpasswd command:</span></span><br><span class="line">gpasswd -a user group</span><br><span class="line"></span><br><span class="line"><span class="comment">#To remove users from a group:</span></span><br><span class="line">gpasswd -d user group</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gpasswd - administer the /etc/group file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXAMPLES</span><br><span class="line">1. Add user (tracy) to the group (hrd)</span><br><span class="line">$ gpasswd -a tracy hrd</span><br><span class="line">2. Add multiper users to the group (developer)</span><br><span class="line">$ gpasswd -a pavan,john developer</span><br><span class="line">3. Remove user (rakesh) from group (sqa)</span><br><span class="line">$ gpasswd -d rakesh sqa</span><br><span class="line">4. Remove multiple users from group (managers)</span><br><span class="line">$ gpasswd -d shane,ron,ram managers</span><br><span class="line">5. Set user (joy) and group administrator <span class="keyword">for</span> (managers)</span><br><span class="line">$ gpasswd -A joy managers</span><br></pre></td></tr></table></figure>

<h3 id="to-show-user-details"><a href="#to-show-user-details" class="headerlink" title="to show user details"></a>to show user details</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id todzhang</span><br></pre></td></tr></table></figure>

<h3 id="Display-group-membership-with-the-groups-command"><a href="#Display-group-membership-with-the-groups-command" class="headerlink" title="Display group membership with the groups command:"></a>Display group membership with the groups command:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ groups user</span><br></pre></td></tr></table></figure>

<h3 id="To-change-the-user’s-login-shell"><a href="#To-change-the-user’s-login-shell" class="headerlink" title="To change the user’s login shell:"></a>To change the user’s login shell:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># usermod -s /bin/bash username</span></span><br></pre></td></tr></table></figure>

<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a href="https://www.sudo.ws/man/sudo.conf.man.html" target="_blank" rel="noopener">https://www.sudo.ws/man/sudo.conf.man.html</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-09-06-mockito/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-09-06-mockito/" class="post-title-link" itemprop="url">Distruptor</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="multithreading"><a href="#multithreading" class="headerlink" title="multithreading"></a>multithreading</h1><p>Concurrent execution of code ia bout two things: mutal exclusion and visibility of change.</p>
<ul>
<li>Mutual exclusion is about managing contented updtes to some resources.</li>
<li>Visibiliyt of change is about controlling when such changes are made visible to other threads.</li>
</ul>
<h2 id="mutal-exclusion"><a href="#mutal-exclusion" class="headerlink" title="mutal exclusion"></a>mutal exclusion</h2><p>It is possible to avoid the need for mutal exclusion if you can eliminate the need for contented updates. If your algorithm can guarantee that any given resource is modified by only one thread then utal exclusion is unnecessary.</p>
<p>Read and write operations require that all changes are made visible to other threads.</p>
<p>The most costly operation in any concurrent environment is a contended write access.</p>
<h3 id="locks"><a href="#locks" class="headerlink" title="locks"></a>locks</h3><p>Lock provide mutual exclusion and ensure that the visibility of change occurs in an ordered manner. Locks are incredibly expensive because they require arbitration when contended. This arbitration is achieved by a context switch to the OS kernerl which will suspend threads waiting on a lock until it’s released. During such a context switch , as well as releasing control to the OS which may decided to do other house-keeping tasks which it has control, execution context can lose previously cached data nad instrucionts. This can have a serious performance impact on modern CPU. </p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="noopener">https://developers.google.com/protocol-buffers/docs/overview</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-09-03-distruptor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-09-03-distruptor/" class="post-title-link" itemprop="url">Mockito</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Feature"><a href="#Feature" class="headerlink" title="Feature"></a>Feature</h1><p>There only 2 things you can do with Mockito mocks - verify or stub. Stubbing goes before execution and verification afterwards.</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://github.com/mockito/mockito/wiki/Mockito-vs-EasyMock" target="_blank" rel="noopener">https://github.com/mockito/mockito/wiki/Mockito-vs-EasyMock</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-09-16-yaml-config/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-09-16-yaml-config/" class="post-title-link" itemprop="url">YAML</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Key-points"><a href="#Key-points" class="headerlink" title="Key points"></a>Key points</h1><p>All YAML files (regardless of their association with Ansible or not) can optionally begin with — and end with …. This is part of the YAML format and indicates the start and end of a document.</p>
<p>In a way, YAML is to JSON what Markdown is to HTML.</p>
<p># </p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="noopener">https://developers.google.com/protocol-buffers/docs/overview</a></li>
</ul>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-09-26-Citrix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-09-26-Citrix/" class="post-title-link" itemprop="url">Citrix receiver</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="“Cannot-connect-to-remote-desktop”-with-Citrix-Receiver"><a href="#“Cannot-connect-to-remote-desktop”-with-Citrix-Receiver" class="headerlink" title="“Cannot connect to remote desktop” with Citrix Receiver"></a>“Cannot connect to remote desktop” with Citrix Receiver</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/Citrix/ICAClient/keystore/ <span class="keyword">then</span>: rm -rf cacerts and finally: ln -s /etc/ssl/certs cacerts</span><br></pre></td></tr></table></figure>

<h1 id="Cann’t-show-full-sreen-in-linux-citrix-receiver"><a href="#Cann’t-show-full-sreen-in-linux-citrix-receiver" class="headerlink" title="Cann’t show full sreen in linux citrix receiver"></a>Cann’t show full sreen in linux citrix receiver</h1><p>There is workaround, i.e. Press <code>Alt</code> and drag RDP window, then maximum it.</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-09-18-Google-Guice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-09-18-Google-Guice/" class="post-title-link" itemprop="url">Guice</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="A-new-type-of-Juice"><a href="#A-new-type-of-Juice" class="headerlink" title="A new type of Juice"></a>A new type of Juice</h1><p>Put simply, Guice alleviates the need for factories and the use of new in your Java code. Think of Guice’s @Inject as the new new. You will still need to write factories in some cases, but your code will not depend directly on them. Your code will be easier to change, unit test and reuse in other contexts.</p>
<p>Guice embraces Java’s type safe nature, especially when it comes to features introduced in Java 5 such as generics and annotations. You might think of Guice as filling in missing features for core Java. Ideally, the language itself would provide most of the same features, but until such a language comes along, we have Guice.</p>
<p>Guice helps you design better APIs, and the Guice API itself sets a good example. Guice is not a kitchen sink. We justify each feature with at least three use cases. When in doubt, we leave it out. We build general functionality which enables you to extend Guice rather than adding every feature to the core framework.</p>
<h1 id="Guice-vs-Spring"><a href="#Guice-vs-Spring" class="headerlink" title="Guice vs Spring"></a>Guice vs Spring</h1><p>Spring and Google Guice are two powerful dependency injection frameworks in use today. Both frameworks fully embrace the concepts of dependency injection, but each has its own way of implementing them. Although Spring provides many benefits, it was created in a pre-Java-5 world. The Guice framework takes DI to the next level.</p>
<p>The advent of Java 5 brought significant changes to the language like generics and annotations: features that enhance the power of Java static typing. Guice is a DI framework that was built from the ground up with the intent to take full advantage of these new features and that has focused on one primary goal: to do dependency injection well.</p>
<p>Guice aims to make development and debugging easier and faster, not harder and slower. In that vein, Guice steers clear of surprises and magic. You should be able to understand code with or without tools, though tools can make things even easier. When errors do occur, Guice goes the extra mile to generate helpful messages.</p>
<h3 id="core-differences-between-the-two-and-see-why-I-prefer-to-use-Guice"><a href="#core-differences-between-the-two-and-see-why-I-prefer-to-use-Guice" class="headerlink" title="core differences between the two, and see why I prefer to use Guice."></a>core differences between the two, and see why I prefer to use Guice.</h3><ol>
<li>Living in XML Hell</li>
<li>Eliminating reliance on String identifiers</li>
<li>Preferring Constructor Injection</li>
</ol>
<p>Although Spring and Guice both support constructor and setter injection, each framework has a preference. Spring has long favored setter injection. Back in the early days of Spring, the authors believed the lack of argument names and default arguments in constructor injection reduced clarity. In addition, constructor injection makes it difficult to have optional dependencies, requires dependencies to be configured in a specific order, and forces subclasses to deal with superclass dependencies. Using setter injection eliminates these problems, and so Spring favors that approach.</p>
<p>The Guice authors saw difficulties with setter injection. One problem is immutability: it is impossible to make immutable a class that uses setter injection. Constructor injection, on the other hand, makes the creation of immutable classes easy, an important consideration in writing multi-threaded applications. In addition, optional dependencies, while perhaps convenient, can introduce confusion about how a class is configured at runtime. Configuring a class through setter injection can often lead to missed required dependencies. Though Spring does provide a @Required annotation to solve this problem, using constructor injection eliminates it by default.</p>
<p>Constructor injection also makes a class’s dependencies immediately clear at a glance. If you’re writing or modifying a unit test, it’s easy to read what the system-under-test needs. Lastly, because Guice uses types to wire classes together, constructor argument order isn’t an issue. You can feel free to reorder them how you want without needing to modify configuration code at all.</p>
<p>The potential drawbacks posed by setter injection outweigh the benefits in many common scenarios, and so Guice established a best practice of favoring constructor injection instead. Its API is well-suited to that approach. But if you should choose to switch from one form of injection to the other, Guice makes that easy too. Changing from setter to constructor injection or vice versa is simply a matter of modifying the class in question. Unlike in Spring, you need never touch a configuration file.</p>
<ol start="4">
<li>Nullifying NullPointerExceptions</li>
</ol>
<p>Null is easily one of the most non-communicative return values possible from a method call.<br>Guice hates nulls as much as I do. By default, Guice refuses to inject a null into any object, and if an accidental null shows up during wiring, it fails-fast with a ProvisionException. Guice does allow for the exception case by permitting fields to be annotated with @Nullable, but this is discouraged.</p>
<ol start="5">
<li>Intruding into the domain</li>
</ol>
<p>Guice aims to eliminate all of this boilerplate without sacrificing maintainability.<br>With Guice, you implement modules. Guice passes a binder to your module, and your module uses the binder to map interfaces to implementations. The following module tells Guice to map Service to ServiceImpl in singleton scope:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</span><br><span class="line">          binder.bind(Service.class)</span><br><span class="line">           .to(ServiceImpl.class)</span><br><span class="line">           .in(Scopes.SINGLETON);</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>A module tells Guice what we want to inject. Now, how do we tell Guice where we want it injected? With Guice, you annotate constructors, methods and fields with @Inject.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">         <span class="keyword">private</span> <span class="keyword">final</span> Service service;</span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">(Service service)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.service = service;</span><br><span class="line">&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           service.go();</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Guice-vs-Dependency-Injection-By-Hand"><a href="#Guice-vs-Dependency-Injection-By-Hand" class="headerlink" title="Guice vs. Dependency Injection By Hand"></a>Guice vs. Dependency Injection By Hand</h2><p>As you can see, Guice saves you from having to write factory classes. You don’t have to write explicit code wiring clients to their dependencies. If you forget to provide a dependency, Guice fails at startup. Guice handles circular dependencies automatically.<br>Guice enables you to specify scopes declaratively. For example, you don’t have to write the same code to store an object in the HttpSession over and over.<br>In the real world, you often don’t know an implementation class until runtime. You need meta factories or service locators for your factories. Guice addresses these problems with minimal effort.<br>When injecting dependencies by hand, you can easily slip back into old habits and introduce direct dependencies, especially if you’re new to the concept of dependency injection. Using Guice turns the tables and makes doing the right thing easier. Guice helps keep you on track.</p>
<h2 id="Guice-annotations"><a href="#Guice-annotations" class="headerlink" title="Guice annotations"></a>Guice annotations</h2><p>When possible, Guice enables you to use annotations in lieu of explicit bindings and eliminate even more boilerplate code. Back to our example, if you need an interface to simplify unit testing but you don’t care about compile time dependencies, you can point to a default implementation directly from your interface.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">       <span class="meta">@ImplementedBy</span>(ServiceImpl.class)</span><br><span class="line">       <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">void</span> <span class="title">go</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If a client needs a Service and Guice can’t find an explicit binding, Guice will<br>inject an instance of ServiceImpl.</p>
<p>By default, Guice injects a new instance every time. If you want to specify a<br>different scope, you can annotate the implementation class, too.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line">       <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceImpl</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line">... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Architectural-Overview"><a href="#Architectural-Overview" class="headerlink" title="Architectural Overview"></a>Architectural Overview</h1><p>We can break Guice’s architecture down into two distinct stages: startup and<br>runtime. You build an Injector during startup and use it to inject objects at runtime.</p>
<h2 id="Startup"><a href="#Startup" class="headerlink" title="Startup"></a>Startup</h2><p>You configure Guice by implementing Module. You pass Guice a module, Guice passes your module a Binder, and your module uses the binder to configure bindings. A binding most commonly consists of a mapping between an interface and a concrete implementation. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</span><br><span class="line">          <span class="comment">// Bind Foo to FooImpl. Guice will create a new</span></span><br><span class="line">           <span class="comment">// instance of FooImpl for every injection.</span></span><br><span class="line">           binder.bind(Foo.class).to(FooImpl.class);</span><br><span class="line">           <span class="comment">// Bind Bar to an instance of Bar.</span></span><br><span class="line">           Bar bar = <span class="keyword">new</span> Bar();</span><br><span class="line">           binder.bind(Bar.class).toInstance(bar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Injecting-Providers"><a href="#Injecting-Providers" class="headerlink" title="Injecting Providers"></a>Injecting Providers</h1><p>With normal dependency injection, each type gets exactly one instance of each of its dependent types. The RealBillingService gets one CreditCardProcessor and one TransactionLog. Sometimes you want more than one instance of your dependent types. When this flexibility is necessary, Guice binds a provider. Providers produce a value when the get() method is invoked:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Provider</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">T <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Provides-Methods"><a href="#Provides-Methods" class="headerlink" title="@Provides Methods"></a>@Provides Methods</h1><p>When you need code to create an object, use an @Provides method. The method must be defined within a module, and it must have an @Provides annotation. The method’s return type is the bound type. Whenever the injector needs an instance of that type, it will invoke the method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BillingModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  <span class="function">TransactionLog <span class="title">provideTransactionLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DatabaseTransactionLog transactionLog = <span class="keyword">new</span> DatabaseTransactionLog();</span><br><span class="line">    transactionLog.setJdbcUrl(<span class="string">"jdbc:mysql://localhost/pizza"</span>);</span><br><span class="line">    transactionLog.setThreadPoolSize(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">return</span> transactionLog;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If the @Provides method has a binding annotation like @PayPal or @Named(“Checkout”), Guice binds the annotated type. Dependencies can be passed in as parameters to the method. The injector will exercise the bindings for each of these before invoking the method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span> <span class="meta">@PayPal</span></span><br><span class="line"><span class="function">CreditCardProcessor <span class="title">providePayPalCreditCardProcessor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @Named(<span class="string">"PayPal API key"</span>)</span> String apiKey) </span>&#123;</span><br><span class="line">  PayPalCreditCardProcessor processor = <span class="keyword">new</span> PayPalCreditCardProcessor();</span><br><span class="line">  processor.setApiKey(apiKey);</span><br><span class="line">  <span class="keyword">return</span> processor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1>
          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.todzhang.com/2018-10-13-SBE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Todd Zhang">
      <meta itemprop="description" content="Contact me via phray.zhang@gmail.com or wechat at helloworld_2000">
      <meta itemprop="image" content="/images/globe.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Clouds & Docker">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2018-10-13-SBE/" class="post-title-link" itemprop="url">Citrix receiver</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-31 23:03:27" itemprop="dateCreated datePublished" datetime="2019-05-31T23:03:27+10:00">2019-05-31</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="Simple-Binary-Encoding-SBE"><a href="#Simple-Binary-Encoding-SBE" class="headerlink" title="Simple Binary Encoding (SBE)"></a>Simple Binary Encoding (SBE)</h1><p>SBE is an OSI layer 6 presentation for encoding and decoding binary application messages for low-latency financial applications. </p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" src="/images/globe.gif" alt="Todd Zhang">
  <p class="site-author-name" itemprop="name">Todd Zhang</p>
  <div class="site-description motion-element" itemprop="description">Contact me via phray.zhang@gmail.com or wechat at helloworld_2000</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">151</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">128</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>



        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Todd Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

<script src="/js/schemes/pisces.js?v=7.3.0"></script>


<script src="/js/next-boot.js?v=7.3.0"></script>




  




























  

  

  


  
</body>
</html>
